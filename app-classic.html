<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – Classic</title>
<meta name="description" content="Links ohne Tracking. Classic: Einfügen, Säubern, Kopieren, Öffnen, 1-Klick.">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0ea5e9">
<style>
  :root{--bd:#e5e7eb;--fg:#111827;--muted:#6b7280}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;margin:16px;color:var(--fg)}
  h1{font-size:20px;margin:0 0 8px}
  .muted{color:var(--muted);font-size:12px}
  .row{margin:10px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  textarea{width:100%;min-height:120px;padding:10px;border:1px solid var(--bd);border-radius:8px;font-size:14px}
  #out{min-height:120px;margin-top:8px}
  .btn{display:inline-block;padding:10px 12px;border:1px solid var(--bd);border-radius:8px;background:#fff;color:var(--fg);cursor:pointer}
  .btn.small{padding:6px 8px;font-size:12px}
  .btn[disabled]{opacity:.5;pointer-events:none}
  #status{margin-top:8px;padding:8px;border:1px dashed var(--bd);border-radius:8px;font-size:12px}
  code{background:#f8fafc;padding:2px 6px;border-radius:6px}
  details summary{cursor:pointer;font-weight:600;margin:6px 0}
</style>
</head>
<body>

<h1>SafeShare – Classic</h1>
<p class="muted">Einfügen → <strong>Säubern</strong> → <strong>Kopieren</strong> oder <strong>Öffnen</strong>. Optional Affiliates behalten.</p>

<textarea id="in" placeholder="link(s) hier einfügen …"></textarea>

<div class="row">
  <button id="clean" class="btn" type="button">Säubern</button>
  <button id="copy"  class="btn" type="button" disabled>Kopieren</button>
  <button id="open"  class="btn" type="button" disabled>Öffnen</button>
  <button id="openNew" class="btn" type="button" disabled>1-Klick (neu)</button>
  <button id="clear" class="btn small" type="button" title="Leeren">&times;</button>
</div>

<div class="row">
  <label class="muted" style="display:inline-flex;align-items:center;gap:6px">
    <input id="keepAff" type="checkbox" checked> Provisionen behalten (SAFE)
  </label>
</div>

<textarea id="out" readonly placeholder="bereinigte url(s) erscheinen hier …"></textarea>
<div id="status" class="muted">Status: –</div>

<details>
  <summary>Kurzanleitung</summary>
  <ul class="muted" style="margin:6px 0 0 18px">
    <li><strong>Säubern</strong>: entfernt <code>utm_*</code>, <code>fbclid</code>, <code>gclid</code>, löst Wrapper (Google/Facebook/AMP).</li>
    <li><strong>SAFE</strong> (Haken an): Affiliates bleiben. <strong>STRICT</strong> (Haken aus): alles weg, auch Affiliates.</li>
    <li>URL-Parameter: <code>?u=</code> (enkodiert), <code>&aff=1|0</code>, <code>&ao=1</code> für Auto-Öffnen.</li>
  </ul>
</details>

<script>
window.addEventListener('error', e=>{console.warn('JS-Fehler:',e.message);});

/* Kill-Listen und Affiliate-Regeln */
const killBase=new Set(['fbclid','gclid','twclid','msclkid','igshid','vero_id','wickedid','dclid','ref_src','ref_url','si','spm','mkt_tok','wtmc','wt_mc','wt_zmc','zmc','xtor','client','zx','no_sw_cr']);
const AFF={
  baseKeep:new Set(['coupon','code']),
  globalNames:new Set(['ref','refid','ref_id','referrer','aff','affid','aff_id','affiliate','affiliate_id','affsource','affsrc','affname','affcamp','affcampaign','campaign','campaignid','campaign_id','clickid','click_id','irclickid','tduid','admitad_uid','sscid','cjevent','clickref','clickref2','subid','sub_id','sid','u1','u2','u3','u4','u5','pid','aid','awinaffid','awinmid']),
  byHostRules:[
    {test:h=>/(^|\.)amazon\./i.test(h),     names:new Set(['tag','ascsubtag'])},
    {test:h=>/(^|\.)ebay\./i.test(h),       names:new Set(['campid','customid','mkcid','mkevt','mkrid'])},
    {test:h=>/(^|\.)rakuten\./i.test(h),    names:new Set(['ranmid','raneaid','ransiteid','ranlinkid'])},
    {test:h=>/(^|\.)aliexpress\./i.test(h), names:new Set(['aff_fcid','aff_fsk','aff_platform','aff_trace_key','aff_short_key'])}
  ],
  exactPairs:new Set([])
};

/* Elemente */
const $=id=>document.getElementById(id);
const inEl=$('in'), outEl=$('out'), keepAff=$('keepAff'), statusEl=$('status');
const btnClean=$('clean'), btnCopy=$('copy'), btnOpen=$('open'), btnOpenNew=$('openNew'), btnClear=$('clear');

/* Helpers */
function firstUrl(){ const m=(outEl.value||'').match(/https?:\/\/[^\s]+/); return m?m[0]:''; }
function extractUrls(t){const rx=/\bhttps?:\/\/[^\s<>"')]+/gi,r=[];let m;while((m=rx.exec(t||'')))r.push(m[0]);return r.length?r:(t||'').split('\n').map(s=>s.trim()).filter(Boolean);}
function deepDecode(s){let a=s||'',b=s||'';for(let i=0;i<8;i++){try{b=decodeURIComponent(a)}catch(_){break}if(b===a)break;a=b}return a;}
function unwrapDeep(u){
  try{
    if(/(^|\.)google\./i.test(u.hostname)&&u.pathname.startsWith('/url')){const q=u.searchParams.get('q')||u.searchParams.get('url'); if(q) u=new URL(q);}
    if(/(^|\.)facebook\./i.test(u.hostname)&&u.pathname.startsWith('/l.php')){const q2=u.searchParams.get('u'); if(q2) u=new URL(q2);}
  }catch(_){}
  for(let i=0;i<6;i++){
    let found=null;
    for(const [_,v] of u.searchParams){const dec=deepDecode(v||'');const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);if(m){found=m[0];break;}}
    if(!found){const dec=deepDecode(u.hash||'');const m=(dec||'').match(/https?:\/\/[^\s"'<>)]+/i);if(m)found=m[0];}
    if(!found){const dec=deepDecode(u.href);const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);if(m&&m[0]!==u.href)found=m[0];}
    if(!found)break; try{u=new URL(found)}catch(_){break;}
  }
  return u;
}
function applyAmpCanonical(u){
  try{
    let path=u.pathname.replace(/\/amp\/?$/,'/').replace(/\/amp$/,'/');
    const sp=u.searchParams; if(sp.has('amp')) sp.delete('amp'); if((sp.get('output')||'').toLowerCase()==='amp') sp.delete('output');
    return new URL(u.origin+path+(sp.size?('?'+sp.toString()):''));
  }catch(_){return u;}
}
function buildAffNames(host){
  const names=new Set(AFF.globalNames);
  for(const r of AFF.byHostRules) if(r.test(host)) for(const n of r.names) names.add(n);
  return names;
}
function sortAndDedupe(out){
  const sorted=new URL(out.origin+out.pathname);
  [...new Set([...out.searchParams].map(([k,v])=>k+'\u0000'+v))]
    .map(s=>s.split('\u0000')).sort((a,b)=>a[0].localeCompare(b[0]))
    .forEach(([k,v])=>sorted.searchParams.append(k,v));
  out.search=sorted.search;
}
function tallyParams(sp){const set=new Set();for(const [k] of sp){const kl=k.toLowerCase();if(kl.startsWith('utm_')||killBase.has(kl)) set.add(kl);}return set;}
function tallyHash(h){const set=new Set();if(!h)return set;const s=h.replace(/^#/,'');if(!s.includes('='))return set;for(const [k] of new URLSearchParams(s)){const kl=k.toLowerCase();if(kl.startsWith('utm_')||killBase.has(kl)) set.add(kl);}return set;}
function sanitizeHash(u,affNames,keepOn,removed){
  if(!u.hash)return''; const s=u.hash.replace(/^#/,''); if(!s.includes('='))return'';
  const hp=new URLSearchParams(s);
  for(const [k,v] of [...hp]){
    const kl=k.toLowerCase();
    const isAff=affNames.has(kl)||AFF.exactPairs.has(`${kl}:${v}`);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if(isAff && !keepOn){ hp.delete(k); removed.add(kl); continue; }
    if(isTrack && !isAff){ hp.delete(k); removed.add(kl); continue; }
  }
  const nh=hp.toString(); return nh?('#'+nh):'';
}

/* Clean */
let last={kept:new Set(),removed:new Set(),mode:'SAFE'};
function cleanOne(s){
  s=(s||'').trim().replace(/[,.;:)\]]$/,''); if(!s) return s;
  let u0; try{u0=new URL(s);}catch(_){ try{u0=new URL('https://'+s);}catch(__){return s;} }
  const remOuter=tallyParams(u0.searchParams), remOuterH=tallyHash(u0.hash);
  let u=unwrapDeep(u0); u=applyAmpCanonical(u);
  try{ u.protocol=(u.protocol||'https:').toLowerCase(); u.hostname=u.hostname.toLowerCase(); }catch(_){}

  const keepOn=keepAff.checked;
  const host=u.hostname.toLowerCase();
  const affNames=buildAffNames(host);

  const out=new URL(u.origin+u.pathname);
  const kept=new Set(), removed=new Set([...remOuter,...remOuterH]);

  for(const [k,v] of u.searchParams){
    const kl=k.toLowerCase();
    if(AFF.baseKeep.has(kl)){ out.searchParams.append(k,v); kept.add(kl); continue; }
    const isAff=affNames.has(kl)||AFF.exactPairs.has(`${kl}:${v}`);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if(isAff){ if(keepOn){out.searchParams.append(k,v); kept.add(kl);} else removed.add(kl); continue; }
    if(isTrack){ removed.add(kl); continue; }
    out.searchParams.append(k,v);
  }
  out.hash=sanitizeHash(u,affNames,keepOn,removed);
  sortAndDedupe(out);

  last={kept,removed,mode:keepOn?'SAFE':'STRICT'};
  return out.toString();
}
function summarize(){
  const u=firstUrl();
  btnCopy.disabled=!u; btnOpen.disabled=!u; btnOpenNew.disabled=!u;
  const kept=Array.from(last.kept).sort().join(', ')||'–';
  const rem=Array.from(last.removed).sort().join(', ')||'–';
  statusEl.textContent=`Modus: ${last.mode} · Affiliates behalten: ${kept} · Entfernt: ${rem}`;
}

/* Aktionen */
function run(){ const lines=extractUrls(inEl.value); outEl.value=lines.map(cleanOne).join('\n'); summarize(); }
$('clean').onclick=run;
keepAff.onchange=run;
$('copy').onclick=async()=>{const u=firstUrl(); if(!u)return; try{await navigator.clipboard.writeText(u);alert('Kopiert');}catch(_){}};
$('open').onclick =()=>{const u=firstUrl(); if(u) location.href=u;};
$('openNew').onclick=()=>{const u=firstUrl(); if(u) window.open(u,'_blank','noopener');};
$('clear').onclick =()=>{inEl.value='';outEl.value='';statusEl.textContent='Status: –';btnCopy.disabled=btnOpen.disabled=btnOpenNew.disabled=true;inEl.focus();};

/* Normalisiere Hosts in Eingabe */
function normalizeHostsInTextarea(){
  const rx=/(https?:\/\/[^\s<>"')]+)/ig;
  let t=inEl.value;
  t=t.replace(rx,(url)=>{
    try{
      const u=new URL(url);
      u.protocol=(u.protocol||'https:').toLowerCase();
      u.hostname=u.hostname.toLowerCase();
      return u.toString();
    }catch(_){return url;}
  });
  inEl.value=t;
}
inEl.addEventListener('paste', ()=>setTimeout(normalizeHostsInTextarea,0));
inEl.addEventListener('blur', normalizeHostsInTextarea);

/* Autofill + SW */
document.addEventListener('DOMContentLoaded', ()=>{
  const p=new URLSearchParams(location.search);
  let q=p.get('u')||p.get('url'); const ao=p.get('open')||p.get('ao'); const aff=p.get('aff')||p.get('mode');
  if(aff==='0'||/^strict$/i.test(aff)) keepAff.checked=false;
  if(aff==='1'||/^safe$/i.test(aff))  keepAff.checked=true;
  if(q){
    try{q=decodeURIComponent(q);}catch(_){}
    try{ const u=new URL(q); u.protocol=(u.protocol||'https:').toLowerCase(); u.hostname=u.hostname.toLowerCase(); q=u.toString(); }catch(_){}
    inEl.value=q; normalizeHostsInTextarea(); run();
    if(ao==='1'){ const u=firstUrl(); if(u) location.href=u; }
  }

  if ('serviceWorker' in navigator && !navigator.serviceWorker.controller) {
    navigator.serviceWorker.register('sw.js?v=1').catch(()=>{});
  }
});
</script>
</body>
</html>