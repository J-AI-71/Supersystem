<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – Classic</title>
<style>
  :root{--bd:#ddd;--fg:#111;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:16px;color:var(--fg)}
  textarea{width:100%;box-sizing:border-box;padding:10px;font-size:14px;border:1px solid var(--bd);border-radius:6px}
  #in{min-height:120px} #out{min-height:140px;margin-top:8px}
  .btn{display:inline-block;padding:10px 12px;margin:6px 8px 6px 0;border:1px solid var(--bd);border-radius:6px;text-decoration:none;color:var(--fg)}
  .muted{color:var(--muted);font-size:12px}
  .disabled{opacity:.5;pointer-events:none}
  #status{margin-top:8px;padding:8px;border:1px dashed var(--bd);border-radius:6px}
  #debug{white-space:pre-wrap;font-size:12px;color:#7f1d1d;margin-top:6px}
</style>
</head>
<body>
<h1>SafeShare – Classic</h1>
<p class="muted">Tracker raus. Optional Affiliates behalten.</p>

<textarea id="in" placeholder="Link(s) hier einfügen …"></textarea>

<div>
  <button id="clean" class="btn" type="button">Säubern</button>
  <button id="copy"  class="btn" type="button">Kopieren</button>
  <a id="openA" class="btn disabled" href="#" rel="noopener">Öffnen</a>
  <a id="goA"   class="btn disabled" href="#" target="_blank" rel="noopener">1-Klick</a>
  <button id="clear" class="btn" type="button" title="Leeren" style="width:38px;padding:8px 0">&times;</button>
</div>

<label class="muted" style="display:inline-flex;align-items:center">
  <input id="keepAff" type="checkbox" checked style="margin-right:6px">Provisionen behalten
</label>

<textarea id="out" readonly placeholder="Bereinigte URL(s) erscheinen hier …"></textarea>
<div id="status" class="muted">Status: –</div>
<div id="debug" class="muted"></div>

<script>
window.addEventListener('error', e => { const d=document.getElementById('debug'); if(d) d.textContent='JS-Fehler: '+e.message; });

const killBase=new Set(['fbclid','gclid','twclid','msclkid','igshid','vero_id','wickedid','dclid','ref_src','ref_url','si','spm','mkt_tok','wtmc','wt_mc','wt_zmc','zmc','xtor','client','zx','no_sw_cr']);
const AFF={
  baseKeep:new Set(['coupon','code']),
  globalNames:new Set(['ref','refid','ref_id','referrer','aff','affid','aff_id','affiliate','affiliate_id','affsource','affsrc','affname','affcamp','affcampaign','campaign','campaignid','campaign_id','clickid','click_id','irclickid','tduid','admitad_uid','sscid','cjevent','clickref','clickref2','subid','sub_id','sid','u1','u2','u3','u4','u5','pid','aid','awinaffid','awinmid']),
  byHostRules:[
    {test:h=>/(^|\.)amazon\./i.test(h),   names:new Set(['tag','ascsubtag'])},
    {test:h=>/(^|\.)ebay\./i.test(h),     names:new Set(['campid','customid','mkcid','mkevt','mkrid'])},
    {test:h=>/(^|\.)rakuten\./i.test(h),  names:new Set(['ranmid','raneaid','ransiteid','ranlinkid'])},
    {test:h=>/(^|\.)aliexpress\./i.test(h), names:new Set(['aff_fcid','aff_fsk','aff_platform','aff_trace_key','aff_short_key'])}
  ],
  exactPairs:new Set([])
};
const $=id=>document.getElementById(id);
const inEl=$('in'), outEl=$('out'), statusEl=$('status'), openA=$('openA'), goA=$('goA');

function extractUrls(t){const rx=/\bhttps?:\/\/[^\s<>"')]+/gi,r=[];let m;while((m=rx.exec(t||'')))r.push(m[0]);return r.length?r:(t||'').split('\n').map(s=>s.trim()).filter(Boolean);}
function deepDecode(s){let a=s||'',b=s||'';for(let i=0;i<8;i++){try{b=decodeURIComponent(a)}catch(_){break}if(b===a)break;a=b}return a;}
function unwrapDeep(u){
  try{
    if(/(^|\.)google\./i.test(u.hostname)&&u.pathname.startsWith('/url')){const q=u.searchParams.get('q')||u.searchParams.get('url'); if(q) u=new URL(q);}
    if(/(^|\.)facebook\./i.test(u.hostname)&&u.pathname.startsWith('/l.php')){const q2=u.searchParams.get('u'); if(q2) u=new URL(q2);}
  }catch(_){}
  for(let i=0;i<6;i++){
    let found=null;
    for(const [,v] of u.searchParams){const dec=deepDecode(v||'');const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);if(m){found=m[0];break;}}
    if(!found){const dec=deepDecode(u.hash||'');const m=(dec||'').match(/https?:\/\/[^\s"'<>)]+/i);if(m)found=m[0];}
    if(!found){const dec=deepDecode(u.href);const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);if(m&&m[0]!==u.href)found=m[0];}
    if(!found)break; try{u=new URL(found)}catch(_){break;}
  }
  return u;
}
function applyAmpCanonical(u){
  try{
    let path=u.pathname.replace(/\/amp\/?$/,'/').replace(/\/amp$/,'/');
    const sp=u.searchParams; if(sp.has('amp')) sp.delete('amp'); if((sp.get('output')||'').toLowerCase()==='amp') sp.delete('output');
    return new URL(u.origin+path+(sp.size?('?'+sp.toString()):''));
  }catch(_){return u;}
}
function buildKeepNames(host, keepOn){
  const keep=new Set(AFF.baseKeep);
  if(keepOn){
    for(const n of AFF.globalNames) keep.add(n);
    for(const r of AFF.byHostRules) if(r.test(host)) for(const n of r.names) keep.add(n);
  }
  return keep;
}
function sortAndDedupe(out){
  const sorted=new URL(out.origin+out.pathname);
  [...new Set([...out.searchParams].map(([k,v])=>k+'\u0000'+v))]
    .map(s=>s.split('\u0000')).sort((a,b)=>a[0].localeCompare(b[0]))
    .forEach(([k,v])=>sorted.searchParams.append(k,v));
  out.search=sorted.search;
}
function tallyParams(sp){const set=new Set();for(const [k] of sp){const kl=k.toLowerCase();if(kl.startsWith('utm_')||killBase.has(kl)) set.add(kl);}return set;}
function tallyHash(h){const set=new Set();if(!h)return set;const s=h.replace(/^#/,'');if(!s.includes('='))return set;for(const [k] of new URLSearchParams(s)){const kl=k.toLowerCase();if(kl.startsWith('utm_')||killBase.has(kl)) set.add(kl);}return set;}
function sanitizeHash(u,keepNames,removed){
  if(!u.hash)return''; const s=u.hash.replace(/^#/,''); if(!s.includes('='))return'';
  const hp=new URLSearchParams(s);
  for(const [k,v] of [...hp]){
    const kl=k.toLowerCase();
    const isAff=keepNames.has(kl)||AFF.exactPairs.has(`${kl}:${v}`);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if(isTrack&&!isAff){hp.delete(k);removed.add(kl);}
  }
  const nh=hp.toString(); return nh?('#'+nh):'';
}

let last={kept:new Set(),removed:new Set(),mode:'AN'};
function cleanOne(s){
  s=(s||'').trim().replace(/[,.;:)\]]$/,''); if(!s) return s;
  let u0; try{u0=new URL(s);}catch(_){ try{u0=new URL('https://'+s);}catch(__){return s;} }
  const remOuter=tallyParams(u0.searchParams), remOuterH=tallyHash(u0.hash);
  let u=unwrapDeep(u0); u=applyAmpCanonical(u);
  const keepOn=$('keepAff').checked, host=u.hostname.toLowerCase();
  const keepNames=buildKeepNames(host, keepOn);
  const out=new URL(u.origin+u.pathname);
  const kept=new Set(), removed=new Set([...remOuter,...remOuterH]);

  for(const [k,v] of u.searchParams){
    const kl=k.toLowerCase();
    const isAff=keepNames.has(kl)||AFF.exactPairs.has(`${kl}:${v}`);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if(isAff){ if(keepOn){out.searchParams.append(k,v); kept.add(kl);} else removed.add(kl); continue; }
    if(isTrack){ removed.add(kl); continue; }
    out.searchParams.append(k,v);
  }
  out.hash=sanitizeHash(u,keepNames,removed);
  sortAndDedupe(out);
  last={kept,removed,mode:keepOn?'AN':'AUS'};
  return out.toString();
}
function summarize(){
  const first=(outEl.value||'').split(/\s+/).find(x=>/^https?:\/\//i.test(x))||'';
  if(first){ openA.href=first; openA.classList.remove('disabled'); goA.href=first; goA.classList.remove('disabled'); }
  else{ openA.href='#'; openA.classList.add('disabled'); goA.href='#'; goA.classList.add('disabled'); }
  const kept=Array.from(last.kept).sort().join(', ')||'–';
  const rem =Array.from(last.removed).sort().join(', ')||'–';
  statusEl.textContent=`Modus: ${last.mode} · Affiliates behalten: ${kept} · Entfernt: ${rem}`;
}
function run(){ try{ const lines=extractUrls(inEl.value); outEl.value=lines.map(cleanOne).join('\n'); summarize(); }catch(e){ const d=$('debug'); if(d) d.textContent='Laufzeitfehler: '+e.message; } }

document.getElementById('clean').onclick=run;
document.getElementById('keepAff').onchange=run;
document.getElementById('copy').onclick=async()=>{const t=outEl.value;if(!t)return; try{await navigator.clipboard.writeText(t);alert('Kopiert');}catch(_){}};
document.getElementById('clear').onclick=()=>{inEl.value='';outEl.value='';statusEl.textContent='Status: –';const d=$('debug'); if(d) d.textContent='';inEl.focus();};

(function(){
  const p=new URLSearchParams(location.search);
  const q=p.get('u')||p.get('url'); const ao=p.get('open')||p.get('ao'); const v=p.get('v');
  if(q){ inEl.value=decodeURIComponent(q); run(); if(ao==='1'){ const first=(outEl.value||'').split(/\s+/).find(x=>/^https?:\/\//i.test(x)); if(first) location.href=first; } }
  if(v){ /* Cache-Buster */ }
})();
</script>
</body>
</html>