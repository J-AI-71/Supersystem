<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – Classic</title>
<style>
  :root{--bd:#ddd;--fg:#111;--muted:#666}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:16px;color:var(--fg)}
  textarea{width:100%;box-sizing:border-box;padding:10px;font-size:14px;border:1px solid var(--bd);border-radius:6px}
  #in{min-height:120px} #out{min-height:140px;margin-top:8px}
  .btn{display:inline-block;padding:10px 12px;margin:6px 8px 6px 0;border:1px solid var(--bd);border-radius:6px;text-decoration:none;color:var(--fg)}
  .muted{color:var(--muted);font-size:12px}
  .disabled{opacity:.5;pointer-events:none}
  #status{margin-top:8px;padding:8px;border:1px dashed var(--bd);border-radius:6px}
  #debug{white-space:pre-wrap;font-size:12px;color:#7f1d1d;margin-top:6px}

  /* Profil + Export/Import Panel */
  .panel{border:1px solid var(--bd);border-radius:10px;padding:12px;margin-top:14px}
  .panel h2{font-size:16px;margin:0 0 8px}
  .rowflex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=text]{padding:8px 10px;border:1px solid var(--bd);border-radius:8px;min-width:220px}
  .btn.small{padding:6px 8px;font-size:12px}
  label.rad{display:inline-flex;align-items:center;gap:6px;margin-right:12px;font-size:14px}
</style>
</head>
<body>
<h1>SafeShare – Classic</h1>
<p class="muted">Tracker raus. Optional Affiliate-Parameter behalten.</p>

<textarea id="in" placeholder="Link(s) hier einfügen …"></textarea>

<div>
  <button id="clean" class="btn" type="button">Säubern</button>
  <button id="copy"  class="btn" type="button">Kopieren</button>
  <a id="openA" class="btn disabled" href="#" rel="noopener">Öffnen</a>
  <a id="goA"   class="btn disabled" href="#" target="_blank" rel="noopener">1-Klick</a>
  <button id="clear" class="btn" type="button" title="Leeren" style="width:38px;padding:8px 0">&times;</button>
</div>

<label class="muted" style="display:inline-flex;align-items:center">
  <input id="keepAff" type="checkbox" checked style="margin-right:6px">Provisionen behalten
</label>

<textarea id="out" readonly placeholder="Bereinigte URL(s) erscheinen hier …"></textarea>
<div id="status" class="muted">Status: –</div>
<div id="debug" class="muted"></div>

<!-- Profil pro Domain -->
<section class="panel" id="profPanel">
  <h2>Profil pro Domain</h2>
  <div class="rowflex">
    <input id="ss-dom" type="text" placeholder="domain.tld (z. B. amazon.de)">
    <label class="rad"><input type="radio" name="ss-profmode" value="safe" checked>Safe (Affiliates behalten)</label>
    <label class="rad"><input type="radio" name="ss-profmode" value="strict">Strict (alles Tracking weg)</label>
  </div>
  <div class="rowflex">
    <button id="ss-save" class="btn small" type="button">Speichern</button>
    <button id="ss-del"  class="btn small" type="button">Löschen</button>
  </div>
  <div id="ss-prof-status" class="muted">–</div>
</section>

<!-- Export / Import -->
<section class="panel" id="backupPanel">
  <h2>Export / Import</h2>
  <div class="rowflex">
    <button id="ss-exp" class="btn small" type="button">Export</button>
    <label class="btn small" style="cursor:pointer">Import<input id="ss-imp" type="file" accept="application/json" hidden></label>
  </div>
  <p class="muted">Exportiert/Importiert Profile unter <code>ss_profiles</code> aus dem Browser-Speicher.</p>
</section>

<script>
/* Fehler sichtbar machen */
window.addEventListener('error', e => { const d=document.getElementById('debug'); if(d) d.textContent='JS-Fehler: '+e.message; });

/* Konstanten */
const killBase=new Set(['fbclid','gclid','twclid','msclkid','igshid','vero_id','wickedid','dclid','ref_src','ref_url','si','spm','mkt_tok','wtmc','wt_mc','wt_zmc','zmc','xtor','client','zx','no_sw_cr']);
const AFF={
  baseKeep:new Set(['coupon','code']),
  globalNames:new Set(['ref','refid','ref_id','referrer','aff','affid','aff_id','affiliate','affiliate_id','affsource','affsrc','affname','affcamp','affcampaign','campaign','campaignid','campaign_id','clickid','click_id','irclickid','tduid','admitad_uid','sscid','cjevent','clickref','clickref2','subid','sub_id','sid','u1','u2','u3','u4','u5','pid','aid','awinaffid','awinmid']),
  byHostRules:[
    {test:h=>/(^|\.)amazon\./i.test(h),     names:new Set(['tag','ascsubtag'])},
    {test:h=>/(^|\.)ebay\./i.test(h),       names:new Set(['campid','customid','mkcid','mkevt','mkrid'])},
    {test:h=>/(^|\.)rakuten\./i.test(h),    names:new Set(['ranmid','raneaid','ransiteid','ranlinkid'])},
    {test:h=>/(^|\.)aliexpress\./i.test(h), names:new Set(['aff_fcid','aff_fsk','aff_platform','aff_trace_key','aff_short_key'])}
  ],
  exactPairs:new Set([])
};
const $=id=>document.getElementById(id);
const inEl=$('in'), outEl=$('out'), statusEl=$('status'), openA=$('openA'), goA=$('goA');

/* Helpers */
function extractUrls(t){const rx=/\bhttps?:\/\/[^\s<>"')]+/gi,r=[];let m;while((m=rx.exec(t||'')))r.push(m[0]);return r.length?r:(t||'').split('\n').map(s=>s.trim()).filter(Boolean);}
function deepDecode(s){let a=s||'',b=s||'';for(let i=0;i<8;i++){try{b=decodeURIComponent(a)}catch(_){break}if(b===a)break;a=b}return a;}
function unwrapDeep(u){
  try{
    if(/(^|\.)google\./i.test(u.hostname)&&u.pathname.startsWith('/url')){const q=u.searchParams.get('q')||u.searchParams.get('url'); if(q) u=new URL(q);}
    if(/(^|\.)facebook\./i.test(u.hostname)&&u.pathname.startsWith('/l.php')){const q2=u.searchParams.get('u'); if(q2) u=new URL(q2);}
  }catch(_){}
  for(let i=0;i<6;i++){
    let found=null;
    for(const [,v] of u.searchParams){const dec=deepDecode(v||'');const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);if(m){found=m[0]);break;}}
    if(!found){const dec=deepDecode(u.hash||'');const m=(dec||'').match(/https?:\/\/[^\s"'<>)]+/i);if(m)found=m[0];}
    if(!found){const dec=deepDecode(u.href);const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);if(m&&m[0]!==u.href)found=m[0];}
    if(!found)break; try{u=new URL(found)}catch(_){break;}
  }
  return u;
}
function applyAmpCanonical(u){
  try{
    let path=u.pathname.replace(/\/amp\/?$/,'/').replace(/\/amp$/,'/');
    const sp=u.searchParams; if(sp.has('amp')) sp.delete('amp'); if((sp.get('output')||'').toLowerCase()==='amp') sp.delete('output');
    return new URL(u.origin+path+(sp.size?('?'+sp.toString()):''));
  }catch(_){return u;}
}
function buildAffNames(host){
  const names=new Set(AFF.globalNames);
  for(const r of AFF.byHostRules) if(r.test(host)) for(const n of r.names) names.add(n);
  return names;
}
function sortAndDedupe(out){
  const sorted=new URL(out.origin+out.pathname);
  [...new Set([...out.searchParams].map(([k,v])=>k+'\u0000'+v))]
    .map(s=>s.split('\u0000')).sort((a,b)=>a[0].localeCompare(b[0]))
    .forEach(([k,v])=>sorted.searchParams.append(k,v));
  out.search=sorted.search;
}
function tallyParams(sp){const set=new Set();for(const [k] of sp){const kl=k.toLowerCase();if(kl.startsWith('utm_')||killBase.has(kl)) set.add(kl);}return set;}
function tallyHash(h){const set=new Set();if(!h)return set;const s=h.replace(/^#/, '');if(!s.includes('='))return set;for(const [k] of new URLSearchParams(s)){const kl=k.toLowerCase();if(kl.startsWith('utm_')||killBase.has(kl)) set.add(kl);}return set;}
function sanitizeHash(u,affNames,keepOn,removed){
  if(!u.hash)return''; const s=u.hash.replace(/^#/,''); if(!s.includes('='))return'';
  const hp=new URLSearchParams(s);
  for(const [k,v] of [...hp]){
    const kl=k.toLowerCase();
    if(AFF.baseKeep.has(kl)) continue;
    const isAff=affNames.has(kl)||AFF.exactPairs.has(`${kl}:${v}`);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if((isAff && !keepOn) || (isTrack && !isAff)){ hp.delete(k); removed.add(kl); }
  }
  const nh=hp.toString(); return nh?('#'+nh):'';
}

/* Kernlogik */
let last={kept:new Set(),removed:new Set(),mode:'AN'};
function cleanOne(s){
  s=(s||'').trim().replace(/[,.;:)\]]$/,''); if(!s) return s;
  let u0; try{u0=new URL(s);}catch(_){ try{u0=new URL('https://'+s);}catch(__){return s;} }
  const remOuter=tallyParams(u0.searchParams), remOuterH=tallyHash(u0.hash);
  let u=unwrapDeep(u0); u=applyAmpCanonical(u);

  const keepOn=$('keepAff').checked;
  const host=u.hostname.toLowerCase();
  const affNames=buildAffNames(host);

  const out=new URL(u.origin+u.pathname);
  const kept=new Set(), removed=new Set([...remOuter,...remOuterH]);

  for(const [k,v] of u.searchParams){
    const kl=k.toLowerCase();
    if(AFF.baseKeep.has(kl)){ out.searchParams.append(k,v); kept.add(kl); continue; }
    const isAff=affNames.has(kl)||AFF.exactPairs.has(`${kl}:${v}`);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if(isAff){ if(keepOn){out.searchParams.append(k,v); kept.add(kl);} else removed.add(kl); continue; }
    if(isTrack){ removed.add(kl); continue; }
    out.searchParams.append(k,v);
  }
  out.hash=sanitizeHash(u,affNames,keepOn,removed);
  sortAndDedupe(out);

  last={kept,removed,mode:keepOn?'AN':'AUS'};
  return out.toString();
}
function summarize(){
  const first=(outEl.value||'').split(/\s+/).find(x=>/^https?:\/\//i.test(x))||'';
  if(first){ openA.href=first; openA.classList.remove('disabled'); goA.href=first; goA.classList.remove('disabled'); }
  else{ openA.href='#'; openA.classList.add('disabled'); goA.href='#'; goA.classList.add('disabled'); }
  const kept=Array.from(last.kept).sort().join(', ')||'–';
  const rem =Array.from(last.removed).sort().join(', ')||'–';
  statusEl.textContent=`Modus: ${last.mode} · Affiliates behalten: ${kept} · Entfernt: ${rem}`;
}
function run(){ try{ const lines=extractUrls(inEl.value); outEl.value=lines.map(cleanOne).join('\n'); summarize(); applyProfileForInput(); }catch(e){ const d=$('debug'); if(d) d.textContent='Laufzeitfehler: '+e.message; } }

/* Events */
$('clean').onclick=run; $('keepAff').onchange=run;
$('copy').onclick=async()=>{const m=(outEl.value||'').match(/https?:\/\/[^\s]+/);if(!m)return; try{await navigator.clipboard.writeText(m[0]);alert('Kopiert');}catch(_){}};
$('clear').onclick=()=>{inEl.value='';outEl.value='';statusEl.textContent='Status: –';$('debug').textContent='';inEl.focus();};

/* Auto-Param: ?u=&ao=1&aff=0|1 */
document.addEventListener('DOMContentLoaded', function(){
  const p=new URLSearchParams(location.search);
  let q=p.get('u')||p.get('url'); const ao=p.get('open')||p.get('ao'); const aff=p.get('aff')||p.get('mode');
  if(aff==='0'||/^strict$/i.test(aff)) $('keepAff').checked=false;
  if(aff==='1'||/^safe$/i.test(aff))  $('keepAff').checked=true;
  if(q){ try{q=decodeURIComponent(q);}catch(_){ } inEl.value=q; run(); if(ao==='1'){ const m=(outEl.value||'').match(/https?:\/\/[^\s]+/); if(m) location.href=m[0]; } }
});

/* ----- Profile + Export/Import ----- */
const LS_KEY='ss_profiles';
const S = {
  load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } },
  save(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }
};
function hostOfFirstUrl(text){
  if(!text) return '';
  const rx=/\bhttps?:\/\/([^\/\s?#:]+)[^\s]*/i;
  const m=(text+'').match(rx);
  if(m) return m[1].toLowerCase();
  try{ const u=new URL(text.includes('://')?text:('https://'+text)); return u.hostname.toLowerCase(); }catch(_){ return ''; }
}
function selectRad(v){ document.querySelectorAll('input[name="ss-profmode"]').forEach(r=>{ r.checked=(r.value===v); }); }
function applyProfileForInput(){
  const host = hostOfFirstUrl(inEl.value);
  if(!host){ $('ss-prof-status').textContent='–'; $('ss-dom').value=''; return; }
  const prof = S.load()[host];
  if(prof==='safe'){ $('keepAff').checked=true; $('ss-prof-status').textContent=`Profil: ${host} → SAFE`; $('ss-dom').value=host; selectRad('safe'); }
  else if(prof==='strict'){ $('keepAff').checked=false; $('ss-prof-status').textContent=`Profil: ${host} → STRICT`; $('ss-dom').value=host; selectRad('strict'); }
  else { $('ss-prof-status').textContent=`Kein Profil für ${host}`; $('ss-dom').value=host; }
}
$('ss-save').onclick=()=>{ const dom=($('ss-dom').value||'').trim().toLowerCase(); if(!dom){$('ss-prof-status').textContent='Bitte Domain eingeben.';return;}
  const mode=document.querySelector('input[name="ss-profmode"]:checked')?.value||'safe';
  const map=S.load(); map[dom]=mode; S.save(map); $('ss-prof-status').textContent=`Gespeichert: ${dom} → ${mode.toUpperCase()}`; applyProfileForInput(); };
$('ss-del').onclick =()=>{ const dom=($('ss-dom').value||'').trim().toLowerCase(); const map=S.load(); if(map[dom]){ delete map[dom]; S.save(map); $('ss-prof-status').textContent=`Gelöscht: ${dom}`; } else {$('ss-prof-status').textContent='Nichts zu löschen.';} applyProfileForInput(); };
$('ss-exp').onclick =()=>{ const payload={version:'v1',ts:new Date().toISOString(),profiles:S.load()}; const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='safeshare-settings.json'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),0); };
$('ss-imp').addEventListener('change', ev=>{ const f=ev.target.files&&ev.target.files[0]; if(!f)return; const rd=new FileReader(); rd.onload=()=>{
    try{ const obj=JSON.parse(rd.result); if(obj&&obj.profiles&&typeof obj.profiles==='object'){ S.save(obj.profiles); $('ss-prof-status').textContent='Import ok.'; applyProfileForInput(); } else { $('ss-prof-status').textContent='Datei ungültig.'; } }
    catch(e){ $('ss-prof-status').textContent='JSON fehlerhaft.'; }
  }; rd.readAsText(f); });

/* Live anwenden bei Eingabe */
inEl.addEventListener('input', ()=>{ clearTimeout(window.__ss_t); window.__ss_t=setTimeout(applyProfileForInput, 120); });
</script>
</body>
</html>