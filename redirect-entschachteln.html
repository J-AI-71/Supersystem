<!doctype html>
<html lang="de">
<head>
  <!-- redirect-entschachteln.html -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <base href="/Supersystem/">
  <title>Redirect entschachteln · SafeShare</title>
  <link rel="canonical" href="https://j-ai-71.github.io/Supersystem/redirect-entschachteln.html">

  <!-- hreflang / Locale -->
  <link rel="alternate" href="https://j-ai-71.github.io/Supersystem/redirect-entschachteln.html" hreflang="de">
  <link rel="alternate" href="https://j-ai-71.github.io/Supersystem/redirect-entschachteln.html" hreflang="x-default">
  <meta property="og:locale" content="de_DE">

  <!-- Sicherheits-CSP (sanft) -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 base-uri 'self';
                 form-action 'self';
                 frame-ancestors 'none';
                 object-src 'none';
                 img-src 'self' data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline';
                 font-src 'self';
                 worker-src 'self';
                 manifest-src 'self';
                 connect-src 'self'">

  <!-- Meta -->
  <meta name="description" content="Verschachtelte Weiterleitungen lokal entpacken: aus Google/Facebook/out.reddit.com & Co. die Ziel-URL extrahieren – optional Tracking entfernen.">

  <!-- Icons / Manifest -->
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon-180.png?v=29">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon-180.png?v=29">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32-kreis.png?v=29">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/icons/icon-16-kreis.png?v=29">
  <link rel="manifest" href="manifest.webmanifest?v=29">

  <!-- Basistyle (kein Weißbild) -->
  <style>
    :root{--bg:#0b0b0b;--fg:#eaeaea;--mut:#9a9a9a;--card:#121212;--line:#2a2a2a;--btn:#1b1b1b;--ok:#1e402f}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:22px 14px}
    h1{margin:.2em 0 .6em;font-size:1.9rem}
    .mut{color:var(--mut)}
    .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-top:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    input[type=text],textarea{width:100%;box-sizing:border-box;background:#0f0f0f;border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:12px}
    .btn{padding:.7rem 1rem;border-radius:10px;border:1px solid var(--line);background:var(--btn);color:var(--fg);text-decoration:none;cursor:pointer}
    .btn.ok{background:var(--ok)}
    code{background:#0f0f0f;border:1px solid #2a2a2a;border-radius:6px;padding:.1rem .35rem}
    footer{margin-top:18px}
    a{color:#cfe7ff}
    .pill{display:inline-block;margin:2px;padding:.2rem .45rem;border-radius:999px;background:#171717;border:1px solid #2a2a2a}
  </style>

  <!-- Optional Theme -->
  <link rel="stylesheet" href="css/theme.css?v=27">

  <!-- SW-Registrierung -->
  <script src="js/sw-register.js?v=29"></script>
</head>
<body>
  <div class="wrap">
    <h1>Redirect entschachteln</h1>
    <p class="mut">Extrahiert aus „Weiterleitungs-URLs“ (z. B. <code>google.com/url</code>, <code>l.facebook.com</code>, <code>out.reddit.com</code>) die echte Ziel-Adresse – lokal im Browser.</p>

    <section class="box">
      <label for="inUrl" class="mut">Eingabe-URL</label>
      <input id="inUrl" type="text" inputmode="url" placeholder="https://www.google.com/url?q=https%3A%2F%2Fziel.de%2F%3Futm_source%3Dmail&sa=D&usg=…"
             spellcheck="false" value="">
      <div class="row">
        <button class="btn" onclick="UI.unwrap()">Entschachteln</button>
        <label style="display:inline-flex;align-items:center;gap:8px">
          <input type="checkbox" id="optClean" checked> Tracking danach entfernen
        </label>
      </div>
    </section>

    <section class="box">
      <h2 style="margin-top:0">Ergebnis</h2>
      <input id="outUrl" type="text" readonly placeholder="Ziel-URL erscheint hier…">
      <div class="row">
        <button class="btn" onclick="UI.copy()">Kopieren</button>
        <button class="btn ok" onclick="UI.open()">Öffnen</button>
      </div>
      <details style="margin-top:10px">
        <summary class="mut">Schritte & Änderungen</summary>
        <div id="steps" style="margin-top:8px">–</div>
        <div id="changes" class="mut" style="margin-top:8px">–</div>
      </details>
      <p class="mut" style="margin-top:8px">
        Hinweis: Kurz-URL-Dienste ohne eingebettetes Ziel (z. B. <code>t.co</code>, <code>bit.ly</code>) können ohne Netzaufruf nicht lokal aufgelöst werden.
      </p>
    </section>

    <footer class="mut">
      <a href="index.html">Startseite</a> ·
      <a href="app.html">App</a> ·
      <a href="help.html">Hilfe</a> ·
      <a href="mailto:?subject=SafeShare%20Feedback&body=Bitte%20hier%20Feedback%20eintragen.">Feedback</a>
    </footer>
  </div>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const QS = { in: $('#inUrl'), out: $('#outUrl'), steps: $('#steps'), changes: $('#changes'), optClean: $('#optClean') };

    // ENTER startet
    QS.in.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); UI.unwrap(); } });

    window.UI = {
      unwrap(){
        const src = QS.in.value.trim();
        if (!src) return;

        // Normalisieren (Protokoll ergänzen)
        let cur = src;
        if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(cur)) cur = 'https://' + cur;

        const chain = [];
        let depth = 0, changed = false;
        let u;

        try { u = new URL(cur); }
        catch { QS.out.value = src; render(chain, {removed:[], kept:[], normalized:''}); return; }

        // Bis zu 10 Entschachtelungen
        while (depth < 10) {
          const step = unwrapOne(u);
          if (!step) break;
          chain.push(step.desc);
          u = new URL(step.next);
          changed = true;
          depth++;
        }

        // Optional Tracking danach entfernen
        let cleanInfo = {removed:[], kept:[], normalized:''};
        if (QS.optClean.checked) {
          cleanInfo = stripTracking(u);
          u = cleanInfo.urlObj;
        }

        QS.out.value = u.toString();
        render(chain, cleanInfo);
      },

      copy(){
        const v = QS.out.value.trim();
        if (!v) return;
        if (navigator.clipboard?.writeText) navigator.clipboard.writeText(v);
        else { QS.out.select(); document.execCommand('copy'); QS.out.blur(); }
      },

      open(){
        const v = QS.out.value.trim();
        if (!v) return;
        try { window.open(v, '_blank', 'noopener,noreferrer'); } catch(e) { location.href = v; }
      }
    };

    function render(chain, info){
      if (!chain.length) {
        QS.steps.innerHTML = '<p>Keine eingebettete Ziel-URL gefunden.</p>';
      } else {
        QS.steps.innerHTML = '<ol>' + chain.map(s=>'<li>'+s+'</li>').join('') + '</ol>';
      }
      const removed = info.removed?.length ? info.removed.map(k=>'<span class="pill">'+escapeHtml(k)+'</span>').join(' ') : '–';
      const kept    = info.kept?.length    ? info.kept.map(k=>'<span class="pill">'+escapeHtml(k)+'</span>').join(' ')    : '–';
      const norm    = info.normalized || '–';
      QS.changes.innerHTML = `
        <div>Entfernte Parameter: ${removed}</div>
        <div>Behalten (Whitelist): ${kept}</div>
        <div>Normalisierung: ${escapeHtml(norm)}</div>
      `;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }

    // — Ein Schritt entpacken —
    function unwrapOne(u){
      const host = u.hostname.replace(/^www\./,'').toLowerCase();
      const path = u.pathname || '/';

      // 1) Spezielle Hosts/Wege mit Ziel in Parametern
      // Google /url?q=… oder &url=&qurl=
      if (host.endsWith('google.com') && path === '/url') {
        const tgt = pickFirst(u, ['q','url','qurl']);
        if (isLikeUrl(tgt)) return { next: decodeLoop(tgt), desc: `Google-Redirect: q/url → <code>${escapeHtml(shorten(decodeLoop(tgt)))}</code>` };
      }

      // Facebook linker
      if (host.endsWith('facebook.com') || host.endsWith('l.facebook.com') || host.endsWith('lm.facebook.com')) {
        const tgt = pickFirst(u, ['u','l','href']);
        if (isLikeUrl(tgt)) return { next: decodeLoop(tgt), desc: `Facebook-Redirect: u/l/href → <code>${escapeHtml(shorten(decodeLoop(tgt)))}</code>` };
      }

      // Reddit outbound
      if (host === 'out.reddit.com') {
        const tgt = u.searchParams.get('url');
        if (isLikeUrl(tgt)) return { next: decodeLoop(tgt), desc: `Reddit-Redirect: url → <code>${escapeHtml(shorten(decodeLoop(tgt)))}</code>` };
      }

      // Tumblr t.umblr.com → u=
      if (host === 't.umblr.com') {
        const tgt = u.searchParams.get('u');
        if (isLikeUrl(tgt)) return { next: decodeLoop(tgt), desc: `Tumblr-Redirect: u → <code>${escapeHtml(shorten(decodeLoop(tgt)))}</code>` };
      }

      // 2) Generisch: erster Parameterwert, der (decodiert) mit http(s) beginnt
      for (const [k,v] of u.searchParams) {
        const dec = decodeLoop(v);
        if (isHttp(dec)) {
          return { next: dec, desc: `Parameter <code>${escapeHtml(k)}</code> → <code>${escapeHtml(shorten(dec))}</code>` };
        }
      }

      // 3) Letzter Versuch: in gesamter URL nach eingebetteter http(s) suchen
      const fullDec = decodeLoop(u.toString());
      const m = fullDec.match(/https?:\/\/[^\s"'<>]+/i);
      if (m && isHttp(m[0])) {
        const found = m[0];
        if (found !== u.toString()) {
          return { next: found, desc: `Eingebettete URL gefunden → <code>${escapeHtml(shorten(found))}</code>` };
        }
      }

      return null;
    }

    function pickFirst(u, keys){
      for (const k of keys) {
        const v = u.searchParams.get(k);
        if (v) return v;
      }
      return null;
    }

    function decodeLoop(s){
      if (typeof s !== 'string') return s;
      let prev = s, cur = s;
      for (let i=0;i<5;i++){
        try{
          cur = decodeURIComponent(prev.replace(/\+/g,'%20'));
        }catch{ cur = prev; }
        if (cur === prev) break;
        prev = cur;
      }
      // Entferne Anführungszeichen
      return cur.replace(/^['"]|['"]$/g,'');
    }

    function isHttp(s){ return typeof s === 'string' && /^https?:\/\//i.test(s); }
    function isLikeUrl(s){ if (!s) return false; const t = decodeLoop(s); return isHttp(t); }
    function shorten(s){ return s.length>120 ? s.slice(0,117)+'…' : s; }

    // — Nachbearbeitung: Tracking-Parameter entfernen —
    function stripTracking(u){
      const info = { removed:[], kept:[], normalized:'', urlObj: u };
      try{
        const allowRaw = localStorage.getItem('ss2_allow') || '';
        const allow = new Set(allowRaw.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean));

        const toRemove = [];
        for (const [k] of u.searchParams) {
          const key = k.toLowerCase();
          const rm =
            key.startsWith('utm_') ||
            key === 'gclid' || key === 'fbclid' || key === 'yclid' ||
            key === 'mc_eid' || key === 'mc_cid' || key === 'mkt_tok' ||
            key === 'igshid' || key === 'spm' ||
            key === 'vero_conv' || key === 'vero_id' || key === 'vero_campaign' ||
            key === 'ref' || key === 'ref_src' || key === 'ref_url';
          if (rm && !allow.has(key)) toRemove.push(k);
        }
        toRemove.forEach(k=>{ info.removed.push(k); u.searchParams.delete(k); });

        for (const [k,v] of Array.from(u.searchParams.entries())) {
          const kl = k.toLowerCase();
          if (v === '' && !allow.has(kl)) { u.searchParams.delete(k); info.removed.push(k); }
        }

        if ((u.protocol==='http:' && u.port==='80') || (u.protocol==='https:' && u.port==='443')) { u.port=''; info.normalized='Standard-Port entfernt'; }
        if (u.pathname === '') u.pathname = '/';

        info.kept = Array.from(allow);
      }catch{}
      return info;
    }
  })();
  </script>

  <noscript><div class="wrap"><p class="mut">Hinweis: JavaScript ist deaktiviert. Diese Seite benötigt JavaScript.</p></div></noscript>
</body>
</html>
