<!doctype html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – App v162</title>
<meta name="description" content="Links säubern: utm_*, fbclid, gclid … entfernen. SAFE/STRICT. Profile. 1-Klick.">
<link rel="icon" href="favicon-32.png">
<style>
:root{--bd:#e5e7eb;--fg:#111827;--muted:#6b7280;--accent:#0ea5e9;--ok:#065f46;--bad:#7f1d1d}
*{box-sizing:border-box}body{margin:16px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;color:var(--fg)}
h1{margin:0 0 8px;font-size:20px}.muted{color:var(--muted);font-size:12px}
.card{border:1px solid var(--bd);border-radius:12px;padding:12px;background:#fff;margin:10px 0}
input[type=text]{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px;font-size:15px}
.btn{border:1px solid var(--bd);border-radius:10px;padding:10px 12px;background:#fff;color:var(--fg);cursor:pointer;text-align:center}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.small{padding:8px 10px;font-size:13px}
.kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f8fafc;border:1px solid var(--bd);padding:1px 6px;border-radius:6px;font-size:12px}
.badge{display:inline-block;border:1px solid var(--bd);border-radius:999px;padding:3px 8px;font-size:12px;background:#f8fafc;margin-right:6px}
.good{color:var(--ok)}.bad{color:var(--bad)}
table{border-collapse:collapse;width:100%}td,th{border:1px solid var(--bd);padding:6px;font-size:12px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:860px){.grid2{grid-template-columns:1fr}}
#io{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.btn-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:8px}
@media(min-width:760px){.btn-grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
@media(max-width:390px){.btn-grid{grid-template-columns:1fr}}
#log{margin-top:8px;font:12px ui-monospace,Menlo,Consolas,monospace;color:#7f1d1d;white-space:pre-wrap}
</style>
</head><body>
<h1>SafeShare – App <span class="muted">v162</span></h1>
<p class="muted">Auto-Öffnen entfernt. Öffnen nur per Button-Klick (iPad-sicher).</p>

<div class="card">
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    <label><input id="ckSafe" type="checkbox" checked> Provisionen behalten <span class="muted">(SAFE)</span></label>
    <label><input id="ckSticky" type="checkbox"> als Standard merken</label>
    <label><input id="ckReload" type="checkbox"> nach Öffnen neu laden</label>
    <label><input id="ckNoref" type="checkbox"> referrer-frei öffnen</label>
  </div>
  <div class="muted" id="modeInfo" style="margin-top:6px">Modus: <strong>SAFE</strong> · Affiliates behalten: <strong>ja</strong></div>
</div>

<div class="card">
  <div id="io">
    <input id="in" type="text" inputmode="url" placeholder="link hier einfügen…">
    <button id="btnClear" type="button" class="btn" aria-label="Feld leeren">×</button>
  </div>
  <div class="btn-grid">
    <button class="btn primary" id="btnClean"   type="button">Säubern</button>
    <button class="btn"          id="btnCopy"    type="button">Kopieren</button>
    <button class="btn"          id="btnOpen"    type="button">Ergebnis öffnen (neu)</button>
    <button class="btn"          id="btnOpenNew" type="button">1-Klick (säubern+öffnen)</button>
  </div>
  <p class="muted" style="margin-top:6px">Tipp: Auf iPad ggf. Pop-up-Blocker deaktivieren.</p>
  <div id="log"></div>
</div>

<div class="grid2">
  <div class="card">
    <h2 style="margin:0 0 6px">Ergebnis</h2>
    <div id="outURL" class="kbd">–</div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn small" id="btnCopyOut" type="button">Ergebnis kopieren</button>
      <button class="btn small" id="btnOpenOut" type="button">Ergebnis öffnen (neu)</button>
    </div>
    <div style="margin-top:8px">
      <span class="badge" id="bMode">Modus: SAFE</span>
      <span class="badge" id="bAff">Affiliates behalten: ja</span>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <div class="badge good" id="rem">Entfernt: –</div>
      <div class="badge" id="kept">Affiliates behalten: –</div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 6px">Profil pro Domain</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button class="btn small" id="btnSaveProfile" type="button">Für diese Domain speichern</button>
      <button class="btn small" id="btnDelProfile"  type="button">Profil löschen</button>
      <button class="btn small" id="btnExport"      type="button">Export</button>
      <label class="btn small"><input type="file" id="fileImport" hidden> Import</label>
    </div>
    <table id="tblProfiles" style="margin-top:8px"><thead><tr><th>Domain</th><th>Modus</th><th>Aktion</th></tr></thead><tbody></tbody></table>
    <p class="muted">Gespeichert nur lokal in deinem Browser.</p>
  </div>
</div>

<script>
const $=s=>document.querySelector(s), byId=id=>document.getElementById(id);
const LS_MODE='ss_mode_default', LS_PROFILES='ss_profiles_v1';
const log=(m)=>{ const el=byId('log'); if(el) el.textContent=(el.textContent?el.textContent+"\n":"")+m; };

function toURLMaybe(s){ if(!s) return null; s=s.trim(); if(/^www\./i.test(s)) s='https://'+s; try{return new URL(s);}catch{return null;} }
function cloneURL(u){ return new URL(u.toString()); }
function decodeMaybe(v){ try{return decodeURIComponent(v);}catch{return v;} }
function copyText(t){ if(!t) return; if(navigator.clipboard&&navigator.clipboard.writeText){ navigator.clipboard.writeText(t).catch(()=>fallback()); } else { fallback(); }
  function fallback(){ const ta=document.createElement('textarea'); ta.value=t; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta); ta.select(); try{document.execCommand('copy');}catch{} document.body.removeChild(ta); } }

function affiliateKeysForHost(host){ host=host.toLowerCase(); if(/\bamazon\./.test(host)) return new Set(['tag']); return new Set(); }

function unwrap(u){
  let url=cloneURL(u), changed=true, hops=0;
  try{
    while(changed && hops<5){
      changed=false; hops++;
      const h=url.hostname.toLowerCase(), p=url.pathname, sp=url.searchParams;
      if((h.endsWith('google.com')||h.endsWith('google.de')) && p==='/url' && sp.get('q')){ try{ url=new URL(sp.get('q')); changed=true; continue; }catch{} }
      if(/\bfacebook\.com$/.test(h) && p==='/l.php' && sp.get('u')){ try{ url=new URL(sp.get('u')); changed=true; continue; }catch{} }
      if(/\bpinterest\./.test(h)){ const cand=sp.get('url')||sp.get('link')||sp.get('to'); if(cand){ const dv=decodeMaybe(decodeMaybe(cand)); if(/^https?:\/\//i.test(dv)){ try{ url=new URL(dv); changed=true; continue; }catch{} } }
      for(const k of ['url','u','redirect','redir','r','target','to','link']){
        const v=sp.get(k); if(!v) continue; const dv=decodeMaybe(decodeMaybe(v));
        if(/^https?:\/\//i.test(dv)){ try{ url=new URL(dv); changed=true; break; }catch{} }
      }
      if(changed) continue;
      if(/\/amp(\/|$)/i.test(p)){ url.pathname=p.replace(/\/amp(\/|$)/ig,'$1'); changed=true; }
      if(sp.has('amp')){ sp.delete('amp'); changed=true; }
    }
  }catch(e){ log('unwrap: '+e.message); }
  return url;
}

function clean(u, keepAffiliates){
  const removed=[], keptAff=[]; let url=unwrap(u);
  url.hostname=url.hostname.toLowerCase();
  const sp=url.searchParams;
  const trackPrefixes=['utm_'];
  const trackExact=new Set(['fbclid','gclid','dclid','msclkid','twclid','yclid','igshid','mc_eid','mc_cid','oly_anon_id','oly_enc_id','vero_conv','vero_id','spm','sc_channel','sc_campaign','sc_content','sc_medium','sc_outcome','ref_src','ref_url','ttclid','wbraid','gbraid','epik','ef_id','pk_campaign','pk_kwd']);
  const affKeys=affiliateKeysForHost(url.hostname);
  try{
    for(const k of [...sp.keys()]){
      const lk=k.toLowerCase();
      const isTrack = trackPrefixes.some(p=>lk.startsWith(p)) || trackExact.has(lk);
      const isAff   = affKeys.has(lk);
      if(isTrack){ removed.push(k); sp.delete(k); continue; }
      if(!keepAffiliates && isAff){ removed.push(k); sp.delete(k); continue; }
      if(keepAffiliates && isAff){ keptAff.push(k); continue; }
    }
  }catch(e){ log('clean: '+e.message); }
  if (url.hostname==='j-ai-71.github.io' && url.pathname.startsWith('/Supersystem/')){
    if (sp.has('v')){ sp.delete('v'); removed.push('v'); }
  }
  const q=sp.toString();
  const out=url.origin+url.pathname+(q?('?'+q):'')+(url.hash||'');
  return {url:out, removed, keptAff, host:url.hostname};
}

/* Profile */
function loadProfiles(){ try{return JSON.parse(localStorage.getItem(LS_PROFILES)||'{}');}catch{return{};} }
function saveProfiles(o){ localStorage.setItem(LS_PROFILES, JSON.stringify(o)); }
function renderProfiles(){
  const tbody=byId('tblProfiles')?.querySelector('tbody'); if(!tbody) return;
  tbody.innerHTML='';
  const p=loadProfiles(), hosts=Object.keys(p).sort();
  if(!hosts.length){ const tr=document.createElement('tr'); tr.innerHTML='<td colspan="3" class="muted">Keine Profile gespeichert.</td>'; tbody.appendChild(tr); return; }
  for(const h of hosts){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${h}</td><td>${p[h]==='safe'?'SAFE':'STRICT'}</td><td><button class="btn small" data-del="${h}" type="button">X</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('button[data-del]').forEach(b=>{
    b.onclick=()=>{ const host=b.getAttribute('data-del'); const p=loadProfiles(); delete p[host]; saveProfiles(p); renderProfiles(); };
  });
}

/* UI-State */
const elIn=byId('in'), elSafe=byId('ckSafe'), elSticky=byId('ckSticky'), elReload=byId('ckReload'), elNoref=byId('ckNoref');
let lastHost=null;
function updateModeLabels(){
  const safe=elSafe.checked;
  byId('modeInfo').innerHTML=`Modus: <strong>${safe?'SAFE':'STRICT'}</strong> · Affiliates behalten: <strong>${safe?'ja':'nein'}</strong>`;
  byId('bMode')&&(byId('bMode').textContent='Modus: '+(safe?'SAFE':'STRICT'));
  byId('bAff') &&(byId('bAff').textContent ='Affiliates behalten: '+(safe?'ja':'nein'));
  if(elSticky.checked){ localStorage.setItem(LS_MODE, safe?'safe':'strict'); }
}

function doClean(){
  try{
    const raw=(elIn.value||'').trim(); if(!raw){ alert('Bitte einen Link einfügen.'); return null; }
    let url=raw; if(/^www\./i.test(url)) url='https://'+url;
    const u=toURLMaybe(url); if(!u){ alert('Ungültige URL.'); return null; }

    const profiles=loadProfiles(); const tmp=unwrap(u); const prof=profiles[tmp.hostname.toLowerCase()];
    if(prof==='strict') elSafe.checked=false; if(prof==='safe') elSafe.checked=true;

    const {url:out,removed,keptAff,host}=clean(u, elSafe.checked);
    lastHost=host;
    byId('outURL').textContent=out;
    byId('rem')  &&(byId('rem').textContent  ='Entfernt: '+(removed.length?removed.join(', '):'–'));
    byId('kept') &&(byId('kept').textContent ='Affiliates behalten: '+(keptAff.length?keptAff.join(', '):'–'));
    updateModeLabels();
    return out;
  }catch(e){ log('doClean: '+e.message); return null; }
}

/* Popup-sicheres Öffnen */
function openNewTab(out){
  if(!out) return;
  const noRef=elNoref.checked;
  const w = window.open('about:blank','_blank');   // 1) neuen Tab sofort erzeugen
  if(!w){                                          // Fallback
    const a=document.createElement('a'); a.href=out; a.target='_blank'; a.rel=noRef?'noreferrer noopener':'noopener'; a.click(); return;
  }
  try{ if(noRef) w.opener=null; }catch{}
  w.location = out;                                // 2) erst danach URL setzen
}

byId('btnClean').onclick   = ()=>doClean();
byId('btnCopy').onclick    = ()=>{ const s=doClean(); if(!s) return; copyText(s); };
byId('btnOpen').onclick    = ()=>{ const s=byId('outURL').textContent||doClean(); if(s && s!=='–') openNewTab(s); };
byId('btnOpenNew').onclick = ()=>{ const s=doClean(); if(s) openNewTab(s); };
byId('btnCopyOut').onclick = ()=>{ const t=byId('outURL').textContent||''; if(t && t!=='–') copyText(t); };
byId('btnOpenOut').onclick = ()=>{ const t=byId('outURL').textContent||''; if(t && t!=='–') openNewTab(t); };
byId('btnClear').onclick   = ()=>{ elIn.value=''; elIn.focus(); byId('outURL').textContent='–'; byId('rem')&&(byId('rem').textContent='Entfernt: –'); byId('kept')&&(byId('kept').textContent='Affiliates behalten: –'); };

(function init(){
  const m=(localStorage.getItem(LS_MODE)||'').toLowerCase();
  if(m==='safe'||m==='strict'){ byId('ckSticky').checked=true; elSafe.checked=(m==='safe'); }
  updateModeLabels(); renderProfiles();
  const q=new URLSearchParams(location.search);
  const v=q.get('u')||q.get('url'); const aff=q.get('aff');
  if(aff==='1') elSafe.checked=true; if(aff==='0') elSafe.checked=false; updateModeLabels();
  if(v){ elIn.value=decodeMaybe(v); doClean(); }  // kein Auto-Open mehr
})();
if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js?v=7').catch(()=>{});}
</script>
</body></html>