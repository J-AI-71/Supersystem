<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SafeShare • App</title>

  <!-- Wichtig: Projektpfad auf GitHub Pages -->
  <base href="/Supersystem/">

  <!-- PWA-Grundlagen -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/svg+xml" href="logo.svg">
  <meta name="theme-color" content="#0b6ef7">
  <meta name="color-scheme" content="light dark">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="SafeShare">

  <style>
    :root { --max: 900px; --gap: 1rem; --radius: 12px; }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; background: Canvas; color: CanvasText; }
    body { font: 16px/1.55 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;
           padding: 1.5rem 1rem 3rem; display: grid; place-items: start center; }
    main { width: 100%; max-width: var(--max); }
    header { display: grid; grid-template-columns: 56px 1fr auto; gap: 1rem; align-items: center; margin-bottom: .5rem; }
    header h1 { margin: 0; font-size: clamp(1.5rem, 3vw, 2.1rem); }
    header p { margin: .15rem 0 0 0; opacity: .8; }
    .logo { width: 56px; height: 56px; }
    .card { border: 1px solid color-mix(in oklab, CanvasText 15%, transparent); border-radius: var(--radius); padding: 1rem; margin: 1rem 0;
            background: color-mix(in oklab, Canvas 92%, CanvasText 0%); }
    .row { display: grid; grid-template-columns: 1fr auto; gap: .6rem; align-items: center; }
    .row-3 { display: grid; grid-template-columns: 1fr auto auto auto; gap: .6rem; align-items: center; }
    input[type="url"], input[type="text"], textarea {
      width: 100%; padding: .7rem .9rem; border-radius: 10px;
      border: 1px solid color-mix(in oklab, CanvasText 18%, transparent); background: Canvas; color: CanvasText;
    }
    input[readonly] { opacity: .95; }
    .btn {
      display:inline-flex; align-items:center; gap:.5rem; padding:.6rem 1rem; border:1px solid color-mix(in oklab, CanvasText 20%, transparent);
      border-radius:10px; background:none; cursor:pointer; white-space: nowrap; text-decoration: none; color: inherit;
    }
    .btn[hidden] { display:none; }
    .hint { font-size: .92rem; opacity: .85; }
    code, .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Roboto Mono", monospace; font-size: .95em; }
    details { margin-top: .5rem; }
    .chips { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem; }
    .chip { padding:.35rem .6rem; border-radius:999px; border:1px solid color-mix(in oklab, CanvasText 20%, transparent); cursor:pointer; font-size:.9rem; }
    footer { margin-top: 1.5rem; opacity: .8; font-size: .9rem; display:flex; gap:.75rem; flex-wrap:wrap; }
    .ok { color: green; } .warn { color: #b8860b; }
  </style>
</head>
<body>
  <main>
    <header>
      <img class="logo" src="logo.svg" alt="SafeShare Logo">
      <div>
        <h1>SafeShare • App</h1>
        <p>URL einfügen → säubern → öffnen/teilen/kopieren. Läuft lokal im Browser.</p>
      </div>
      <a class="btn" href="index.html">Start</a>
    </header>

    <!-- Eingabe -->
    <section class="card" aria-labelledby="eingabe">
      <h2 id="eingabe">Eingabe</h2>
      <div class="row">
        <input id="inUrl" type="url" inputmode="url" placeholder="https://…  Link hier einfügen oder einfügen + Enter" autocomplete="off">
        <button id="cleanBtn" class="btn" type="button">Säubern</button>
      </div>
      <div class="chips" id="examples">
        <button class="chip" data-url="https://example.com/?utm_source=newsletter&fbclid=abc123">UTM entfernen</button>
        <button class="chip" data-url="https://www.google.com/url?q=https%3A%2F%2Fexample.org%2Fpost%3Futm_medium%3Dsocial&sa=D">Google-Redirect</button>
        <button class="chip" data-url="https://l.facebook.com/l.php?u=https%3A%2F%2Fexample.net%2F%3Fgclid%3Dxyz">Facebook-Redirect</button>
        <button class="chip" data-url="https://www.instagram.com/reel/xyz/?utm_source=ig_web_copy_link&igsh=abc">Instagram</button>
      </div>
      <p class="hint">Tipp: Einfügen und Enter drückten. Domains ohne Protokoll werden automatisch zu <span class="mono">https://</span> ergänzt.</p>
    </section>

    <!-- Ausgabe + Aktionen -->
    <section class="card" aria-labelledby="ausgabe">
      <h2 id="ausgabe">Ausgabe</h2>
      <div class="row-3">
        <input id="outUrl" type="url" readonly aria-label="Bereinigte URL">
        <a id="openBtn" class="btn" target="_blank" rel="noopener">Öffnen</a>
        <button id="copyBtn" class="btn" type="button">Kopieren</button>
        <button id="shareBtn" class="btn" type="button" hidden>Teilen</button>
      </div>
      <details>
        <summary>Was wird entfernt?</summary>
        <p class="hint">Beispiele: <span class="mono">utm_*</span>, <span class="mono">fbclid</span>, <span class="mono">gclid</span>, <span class="mono">igshid</span>, <span class="mono">mc_eid</span>, <span class="mono">spm</span>, <span class="mono">vero_id</span>, u. a. Außerdem werden verschachtelte Redirect-Ziele aus Parametern wie <span class="mono">url</span>, <span class="mono">u</span>, <span class="mono">q</span>, <span class="mono">destination</span> extrahiert.</p>
      </details>
    </section>

    <!-- Diagnose / Technik -->
    <section class="card">
      <h2>Diagnose</h2>
      <pre id="diag" class="mono">bereit…</pre>
      <p class="hint" id="iosHint" hidden>iOS: Zum Teilen nutze den System-Dialog über den Button „Teilen“. Für Installation: Teilen-Menü → „Zum Home-Bildschirm“.</p>
    </section>

    <footer>
      <a href="impressum.html">Impressum</a>
      <a href="datenschutz.html">Datenschutz</a>
      <span>© <span id="year"></span> SafeShare</span>
    </footer>
  </main>

  <script>
  // ---- Utils ---------------------------------------------------------------

  // Robustes Normalisieren: fügt https:// hinzu, wenn Schema fehlt.
  function normalizeInput(raw) {
    const s = String(raw || '').trim();
    if (!s) return '';
    if (/^[a-z]+:\/\//i.test(s)) return s;
    if (/^[\w.-]+\.[a-z]{2,}(?:[/:?#]|$)/i.test(s)) return 'https://' + s;
    return s; // kann auch Text sein; URL-Parser wird später ggf. scheitern
  }

  // Liste bekannter Tracking-Parameter (Name-Matches)
  const TRACK_PARAM_RULES = [
    /^utm_/i, /^icid$/i, /^mc_eid$/i, /^mkt_tok$/i, /^fbclid$/i, /^gclid$/i, /^dclid$/i,
    /^yclid$/i, /^gbraid$/i, /^wbraid$/i, /^ttclid$/i, /^twclid$/i, /^igshid$/i,
    /^si$/i, /^spm$/i, /^vero_id$/i, /^aff_id$/i, /^affid$/i, /^ref$/i, /^ref_id$/i,
    /^campaign$/i, /^source$/i, /^pk_[a-z]+$/i, /^sc_.+/i, /^msclkid$/i, /^_hs/i,
    /^soc_.*$/i, /^sr_[a-z]+$/i
  ];

  function isTrackingParam(name) {
    return TRACK_PARAM_RULES.some(rx => rx.test(name));
  }

  // Entfernt Tracking-Parameter aus URLSearchParams
  function stripParams(urlObj) {
    const sp = urlObj.searchParams;
    // Entferne Tracking-Parameter
    for (const name of Array.from(sp.keys())) {
      if (isTrackingParam(name)) sp.delete(name);
    }
    // Sort optional stabilisieren
    const kept = new URLSearchParams(sp); // Kopie
    urlObj.search = kept.toString() ? '?' + kept.toString() : '';
    // Hash-Bereinigung, falls Fragment Query-ähnlich ist
    if (urlObj.hash && /[=&]/.test(urlObj.hash)) {
      const frag = urlObj.hash.replace(/^#/, '');
      const fragParams = new URLSearchParams(frag);
      let changed = false;
      for (const k of Array.from(fragParams.keys())) {
        if (isTrackingParam(k)) { fragParams.delete(k); changed = true; }
      }
      if (changed) {
        const s = fragParams.toString();
        urlObj.hash = s ? '#' + s : '';
      }
    }
    return urlObj;
  }

  // Extrahiert Ziel-URL aus typischen Redirect-Parametern
  const REDIR_PARAM_CANDIDATES = ['url','u','q','target','to','dest','destination','redirect','redir','r','next','continue','continueUrl','link','l'];

  function extractNested(u) {
    try {
      const urlObj = new URL(u);
      // Spezielle Host-Pfade (Google, Facebook, LinkedIn, etc.)
      const h = urlObj.hostname;
      const p = urlObj.pathname;
      if (/^www\.google\./i.test(h) && (p.startsWith('/url') || p.startsWith('/amp/s/'))) {
        // /url?url=... oder ?q=...
        for (const key of ['url','q']) {
          const v = urlObj.searchParams.get(key);
          if (v) return v;
        }
      }
      if (/^l\.facebook\.com$/i.test(h) || /^www\.facebook\.com$/i.test(h)) {
        const v = urlObj.searchParams.get('u');
        if (v) return v;
      }
      if (/^lnkd\.in$/i.test(h) || /^www\.linkedin\.com$/i.test(h)) {
        // oft ?url= oder ?redirect=
        for (const key of ['url','redirect']) {
          const v = urlObj.searchParams.get(key);
          if (v) return v;
        }
      }
      // Generisch: erster passende Kandidat
      for (const key of REDIR_PARAM_CANDIDATES) {
        const v = urlObj.searchParams.get(key);
        if (v && /^[a-z]+:\/\//i.test(v)) return v;
      }
      return u;
    } catch { return u; }
  }

  // Hauptfunktion: entpackt Redirects und entfernt Tracking (mehrere Durchläufe)
  function cleanUrl(input) {
    let current = normalizeInput(input);
    if (!current) return '';
    // Max. 3 Durchläufe, um Verschachtelungen zu entpacken
    for (let i = 0; i < 3; i++) {
      const nested = extractNested(current);
      if (nested !== current) current = nested; else break;
    }
    // URL parsen und bereinigen
    let urlObj;
    try { urlObj = new URL(current); }
    catch { return current; } // Falls keine gültige URL, unverändert zurück
    stripParams(urlObj);

    // Entferne leere ? und überflüssige & oder ?#
    let out = urlObj.toString();
    out = out.replace(/\?($|#)/, '$1').replace(/\?#/, '#');
    return out;
  }

  // ---- UI/Flow -------------------------------------------------------------

  const $in = document.getElementById('inUrl');
  const $out = document.getElementById('outUrl');
  const $clean = document.getElementById('cleanBtn');
  const $open = document.getElementById('openBtn');
  const $copy = document.getElementById('copyBtn');
  const $share = document.getElementById('shareBtn');
  const $diag = document.getElementById('diag');
  const $examples = document.getElementById('examples');

  function setOutput(url) {
    $out.value = url || '';
    // Korrekte Weiterleitung: Button zeigt IMMER auf die bereinigte URL
    $open.href = url || 'about:blank';
    $open.target = '_blank';
    $open.rel = 'noopener';
    // Share-Button nur zeigen, wenn URL vorhanden
    $share.hidden = !(url && navigator.share);
  }

  function runClean() {
    const raw = $in.value;
    const cleaned = cleanUrl(raw);
    setOutput(cleaned);
    $diag.textContent = [
      'Input : ' + (raw || '—'),
      'Result: ' + (cleaned || '—'),
      'Share : ' + (navigator.share ? 'unterstützt' : 'nicht verfügbar'),
      'Scope : ' + (document.querySelector('base')?.href || '(kein base)'),
    ].join('\n');
  }

  // Events
  $clean.addEventListener('click', runClean);
  $in.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); runClean(); }
  });
  $examples.addEventListener('click', (e) => {
    const t = e.target.closest('[data-url]');
    if (!t) return;
    $in.value = t.dataset.url;
    runClean();
  });

  $copy.addEventListener('click', async () => {
    const url = $out.value;
    if (!url) return;
    try {
      await navigator.clipboard.writeText(url);
      $copy.textContent = 'Kopiert';
      setTimeout(() => { $copy.textContent = 'Kopieren'; }, 1200);
    } catch {
      // Fallback: markieren
      $out.select();
      document.execCommand?.('copy');
    }
  });

  $share.addEventListener('click', async () => {
    const url = $out.value;
    if (!url || !navigator.share) return;
    try {
      await navigator.share({ title: 'SafeShare', url });
    } catch { /* abgebrochen */ }
  });

  // iOS-Hinweis
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if (isIOS && !isStandalone) document.getElementById('iosHint').hidden = false;

  // Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  }

  // Jahr
  document.getElementById('year').textContent = new Date().getFullYear();

  // Initial
  setOutput('');
  $diag.textContent = 'bereit…';
  </script>

  <noscript>JavaScript ist deaktiviert. Die App benötigt JavaScript.</noscript>
</body>
</html>