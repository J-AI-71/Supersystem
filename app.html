<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – Link-Reiniger v19 (Affiliate-safe)</title>

<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="safeshare-180.png">
<meta name="theme-color" content="#111827">

<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:16px;line-height:1.45}
  h1{font-size:18px;margin:0 0 8px}
  textarea,input{width:100%;box-sizing:border-box;padding:10px;font-size:14px}
  textarea{min-height:140px;resize:vertical}
  .btn{padding:10px 12px;font-size:14px;margin-right:8px}
  .muted{color:#666;font-size:12px}
  #out{min-height:140px}
</style>
</head>
<body>
<h1>SafeShare – Link-Reiniger <small style="font-weight:normal;color:#666">v19 • Provisionen bleiben</small></h1>
<p class="muted">Entfernt <code>utm_</code>, <code>gclid</code>, <code>fbclid</code>, <code>twclid</code>. Entschachtelt Redirects. Behaltet Affiliate-Parameter für Amazon/eBay und deine Whitelist.</p>

<textarea id="in" placeholder="Link(s) einfügen. Eine Zeile pro Link. Beliebiger Text wird erkannt."></textarea>

<div style="margin:10px 0;">
  <button id="clean" class="btn">Säubern</button>
  <button id="copy"  class="btn">Kopieren</button>
  <button id="open"  class="btn">Öffnen</button>
  <button id="go"    class="btn">1-Klick</button>
  <button id="clear" class="btn" aria-label="Leeren" title="Leeren" style="width:38px;padding:8px 0">&times;</button>
</div>
<p class="muted">„1-Klick“ säubert und öffnet sofort im neuen Tab.</p>

<textarea id="out" readonly placeholder="Bereinigte URL(s) erscheinen hier..."></textarea>

<p style="margin-top:10px">
  <a href="https://payhip.com/b/VDm3B" target="_blank" rel="noopener" class="btn">Projekt unterstützen</a>
</p>

<p class="muted">Bookmarklet: <a id="bm" href="#">UTM jetzt säubern (Affiliate-safe)</a></p>
<p class="muted"><a href="impressum.html">Impressum</a> · <a href="datenschutz.html">Datenschutz</a></p>

<script>
const $ = id => document.getElementById(id);
const inEl = $('in'), outEl = $('out');

// Entfernen-Liste (Tracking)
const kill = new Set([
  'fbclid','gclid','twclid','msclkid',
  'mc_cid','mc_eid','igshid','vero_id','wickedid',
  'ref_src','ref_url','si','spm','mkt_tok'
]);

// Behalten-Liste (Provisionen)
/* Passe hier an, falls nötig:
   - globalNames: Namen, die IMMER bleiben (z.B. coupon, code)
   - byHostRules: domainspezifische Namen (Regex-Test auf Host)
   - exactPairs: exakte name:value-Paare, die bleiben (z.B. "ref:jana")
*/
const AFF = {
  globalNames: new Set(['coupon','code']),
  byHostRules: [
    { test: h => /(^|\.)amazon\./i.test(h), names: new Set(['tag','ascsubtag']) },
    { test: h => /(^|\.)ebay\./i.test(h),   names: new Set(['campid','customid','mkcid','mkevt','mkrid']) }
    // Beispiel für eigenen Shop: { test: h => h==='shop.de', names: new Set(['ref']) }
  ],
  exactPairs: new Set([
    // Beispiel: 'ref:jana'
  ])
};

// Utils
function extractUrls(t){
  const rx=/\bhttps?:\/\/[^\s<>"')]+/gi, r=[]; let m;
  while((m=rx.exec(t||''))) r.push(m[0]);
  return r.length? r : (t||'').split('\n').map(s=>s.trim()).filter(Boolean);
}
function deepDecode(s){
  let a=s||'', b=s||'';
  for(let i=0;i<8;i++){ try{ b=decodeURIComponent(a);}catch(_){ break;} if(b===a) break; a=b; }
  return a;
}
function unwrapDeep(u){
  for(let i=0;i<6;i++){
    let found=null;
    for(const [,v] of u.searchParams){
      const dec=deepDecode(v||''); const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);
      if(m){ found=m[0]; break; }
    }
    if(!found){
      const dec=deepDecode(u.hash||''); const m=(dec||'').match(/https?:\/\/[^\s"'<>)]+/i);
      if(m) found=m[0];
    }
    if(!found){
      const dec=deepDecode(u.href); const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);
      if(m && m[0]!==u.href) found=m[0];
    }
    if(!found) break; try{ u=new URL(found);}catch(_){ break; }
  } return u;
}

// Hauptlogik
function cleanOne(s){
  s=(s||'').trim().replace(/[,.;:)\]]$/,'');
  if(!s) return s;

  let u;
  try{ u=new URL(s); }
  catch(_){ try{ u=new URL('https://'+s); }catch(__){ return s; } }

  u=unwrapDeep(u);

  const host=u.hostname.toLowerCase();
  const keepNames=new Set(AFF.globalNames);
  for(const rule of AFF.byHostRules){ if(rule.test(host)) for(const n of rule.names) keepNames.add(n); }

  const out=new URL(u.origin+u.pathname);
  for(const [k,v] of u.searchParams){
    const kl=k.toLowerCase();
    const isKill = kl.startsWith('utm_') || kill.has(kl);
    const whitelisted = keepNames.has(kl) || AFF.exactPairs.has(`${kl}:${v}`);
    if(isKill && !whitelisted) continue; // Tracking raus, Provisionen whitelisted bleiben
    out.searchParams.append(k,v);
  }
  return out.toString();
}

// UI
function runClean(){ const lines=extractUrls(inEl.value); outEl.value=lines.map(cleanOne).join('\n'); }
function firstOutUrl(){ return (outEl.value||'').split(/\s+/).find(x=>/^https?:\/\//i.test(x))||''; }

$('clean').onclick=runClean;
$('copy').onclick=async()=>{const t=outEl.value;if(!t)return;try{await navigator.clipboard.writeText(t);alert('Kopiert');}catch(_){}};
$('open').onclick=()=>{runClean();const t=firstOutUrl();if(!t){alert('Kein Ziel gefunden');return;}window.location.assign(t);};
$('go').onclick=()=>{runClean();const t=firstOutUrl();if(!t){alert('Kein Ziel gefunden');return;}window.open(t,'_blank','noopener,noreferrer');};
$('clear').onclick=()=>{inEl.value='';outEl.value='';inEl.focus();};

// Bookmarklet (Affiliate-safe)
$('bm').href = "javascript:(function(){try{var u=new URL(location.href);var host=u.hostname.toLowerCase();var del=[],keep=new Set(['coupon','code']);if((/(^|\\.)amazon\\./i).test(host)){['tag','ascsubtag'].forEach(x=>keep.add(x));}if((/(^|\\.)ebay\\./i).test(host)){['campid','customid','mkcid','mkevt','mkrid'].forEach(x=>keep.add(x));}u.hash='';u.searchParams.forEach(function(v,k){var kl=k.toLowerCase();if(kl.indexOf('utm_')===0||['fbclid','gclid','twclid','msclkid','mc_cid','mc_eid','igshid','vero_id','wickedid','ref_src','ref_url','si','spm','mkt_tok'].indexOf(kl)>-1){if(!keep.has(kl)) del.push(k);}});del.forEach(k=>u.searchParams.delete(k));location.replace(u.toString());}catch(e){alert('Kein gültiger Link')}})()";

// Auto-Input per ?u=… und optional &open=1
(function(){
  const p=new URLSearchParams(location.search);
  const q=p.get('u')||p.get('url'); const ao=p.get('open')||p.get('ao');
  if(q){ inEl.value=decodeURIComponent(q); runClean(); if(ao==='1'){ const t=firstOutUrl(); if(t) window.location.assign(t); } }
})();
</script>
</body>
</html>