<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – App v41</title>
<meta name="description" content="Links ohne Tracking. Optional Affiliates behalten. Referrer-frei öffnen. Profile pro Domain.">
<style>
  :root{--bd:#e5e7eb;--fg:#111827;--muted:#6b7280;--ok:#065f46;--chip:#ecfdf5}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;margin:16px;color:var(--fg)}
  h1{font-size:20px;margin:0 0 8px}
  .muted{color:var(--muted);font-size:12px}
  .row{margin:10px 0}
  textarea{width:100%;min-height:120px;padding:10px;border:1px solid var(--bd);border-radius:8px;font-size:14px}
  #out{min-height:140px;margin-top:8px}
  .btn{display:inline-block;padding:10px 12px;margin:6px 8px 0 0;border:1px solid var(--bd);border-radius:8px;background:#fff;color:var(--fg);cursor:pointer}
  .btn.small{padding:6px 8px;font-size:12px}
  .btn[disabled]{opacity:.5;pointer-events:none}
  #status{margin-top:8px;padding:8px;border:1px dashed var(--bd);border-radius:8px;font-size:12px}
  #chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{background:var(--chip);border:1px solid #a7f3d0;color:var(--ok);border-radius:999px;padding:2px 10px;font-size:12px}
  #panels{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
  .panel{border:1px solid var(--bd);border-radius:10px;padding:12px}
  .panel h2{font-size:16px;margin:0 0 8px}
  .rowflex{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type=text]{padding:8px 10px;border:1px solid var(--bd);border-radius:8px;min-width:220px}
  label.rad{display:inline-flex;align-items:center;gap:6px;margin-right:12px;font-size:14px}
  code{background:#f8fafc;padding:2px 6px;border-radius:6px}
  #debug{white-space:pre-wrap;font-size:12px;color:#7f1d1d;margin-top:6px}
  /* Domain-X */
  .input-wrap{position:relative;display:inline-block}
  #ss-dom{padding-right:34px}
  #ss-x{
    position:absolute;right:6px;top:50%;transform:translateY(-50%);
    width:26px;height:26px;line-height:24px;text-align:center;
    border:1px solid var(--bd);border-radius:999px;background:#fff;cursor:pointer
  }
</style>
</head>
<body>

<h1>SafeShare – App v41</h1>
<p class="muted">Tracker raus. Optional Affiliates behalten. Referrer-frei öffnen. Profile pro Domain.</p>

<div id="chips">
  <span id="chip-mode" class="chip">Modus: SAFE</span>
  <span id="chip-prof" class="chip">Profil: –</span>
</div>

<textarea id="in" placeholder="Link(s) hier einfügen …"></textarea>

<div class="row">
  <button id="clean" class="btn" type="button">Säubern</button>
  <button id="copy"  class="btn" type="button">Kopieren</button>
  <button id="openA" class="btn" type="button" disabled>Öffnen</button>
  <button id="goA"   class="btn" type="button" disabled>1-Klick (neu)</button>
  <button id="openNR" class="btn" type="button" title="In neuem Tab ohne Referrer öffnen" disabled>Referrer-frei (neu)</button>
  <button id="clear" class="btn" type="button" title="Leeren" style="width:42px;padding:8px 0">&times;</button>
</div>

<label class="muted" style="display:inline-flex;align-items:center">
  <input id="keepAff" type="checkbox" checked style="margin-right:6px">Provisionen behalten (SAFE)
</label>

<textarea id="out" readonly placeholder="Bereinigte URL(s) erscheinen hier …"></textarea>
<div id="status" class="muted">Status: –</div>
<div id="debug" class="muted"></div>

<div id="panels">
  <section class="panel" id="profPanel">
    <h2>Profil pro Domain</h2>
    <div class="rowflex">
      <div class="input-wrap">
        <input id="ss-dom" type="text" placeholder="domain.tld (z. B. amazon.de)">
        <button id="ss-x" type="button" title="Profil löschen" aria-label="Profil löschen">&times;</button>
      </div>
      <label class="rad"><input type="radio" name="ss-profmode" value="safe" checked>Safe</label>
      <label class="rad"><input type="radio" name="ss-profmode" value="strict">Strict</label>
    </div>
    <div class="rowflex">
      <button id="ss-save" class="btn small" type="button">Speichern</button>
      <button id="ss-del"  class="btn small" type="button">Löschen</button>
    </div>
    <div id="ss-prof-status" class="muted">–</div>
  </section>

  <section class="panel" id="backupPanel">
    <h2>Export / Import</h2>
    <div class="rowflex">
      <button id="ss-exp" class="btn small" type="button">Export</button>
      <label class="btn small" style="cursor:pointer">Import<input id="ss-imp" type="file" accept="application/json" hidden></label>
    </div>
    <p class="muted">Exportiert/Importiert Profile unter <code>ss_profiles</code>.</p>
  </section>
</div>

<script>
window.addEventListener('error', e => { const d=document.getElementById('debug'); if(d) d.textContent='JS-Fehler: '+e.message; });

/* Listen */
const killBase=new Set(['fbclid','gclid','twclid','msclkid','igshid','vero_id','wickedid','dclid','ref_src','ref_url','si','spm','mkt_tok','wtmc','wt_mc','wt_zmc','zmc','xtor','client','zx','no_sw_cr']);
const AFF={
  baseKeep:new Set(['coupon','code']),
  globalNames:new Set(['ref','refid','ref_id','referrer','aff','affid','aff_id','affiliate','affiliate_id','affsource','affsrc','affname','affcamp','affcampaign','campaign','campaignid','campaign_id','clickid','click_id','irclickid','tduid','admitad_uid','sscid','cjevent','clickref','clickref2','subid','sub_id','sid','u1','u2','u3','u4','u5','pid','aid','awinaffid','awinmid']),
  byHostRules:[
    {test:h=>/(^|\.)amazon\./i.test(h),     names:new Set(['tag','ascsubtag'])},
    {test:h=>/(^|\.)ebay\./i.test(h),       names:new Set(['campid','customid','mkcid','mkevt','mkrid'])},
    {test:h=>/(^|\.)rakuten\./i.test(h),    names:new Set(['ranmid','raneaid','ransiteid','ranlinkid'])},
    {test:h=>/(^|\.)aliexpress\./i.test(h), names:new Set(['aff_fcid','aff_fsk','aff_platform','aff_trace_key','aff_short_key'])}
  ],
  exactPairs:new Set([])
};

/* Shortcuts */
const $=id=>document.getElementById(id);
const inEl=$('in'), outEl=$('out'), statusEl=$('status'), chipMode=$('chip-mode'), chipProf=$('chip-prof');
const openNR=$('openNR');

/* Helpers */
function firstUrl(){ const m=(outEl.value||'').match(/https?:\/\/[^\s]+/); return m?m[0]:''; }
function extractUrls(t){const rx=/\bhttps?:\/\/[^\s<>"')]+/gi,r=[];let m;while((m=rx.exec(t||'')))r.push(m[0]);return r.length?r:(t||'').split('\n').map(s=>s.trim()).filter(Boolean);}
function deepDecode(s){let a=s||'',b=s||'';for(let i=0;i<8;i++){try{b=decodeURIComponent(a)}catch(_){break}if(b===a)break;a=b}return a;}
function unwrapDeep(u){
  try{
    if(/(^|\.)google\./i.test(u.hostname)&&u.pathname.startsWith('/url')){const q=u.searchParams.get('q')||u.searchParams.get('url'); if(q) u=new URL(q);}
    if(/(^|\.)facebook\./i.test(u.hostname)&&u.pathname.startsWith('/l.php')){const q2=u.searchParams.get('u'); if(q2) u=new URL(q2);}
  }catch(_){}
  for(let i=0;i<6;i++){
    let found=null;
    for(const [_,v] of u.searchParams){const dec=deepDecode(v||'');const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);if(m){found=m[0];break;}}
    if(!found){const dec=deepDecode(u.hash||'');const m=(dec||'').match(/https?:\/\/[^\s"'<>)]+/i);if(m)found=m[0];}
    if(!found){const dec=deepDecode(u.href);const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);if(m&&m[0]!==u.href)found=m[0];}
    if(!found)break; try{u=new URL(found)}catch(_){break;}
  }
  return u;
}
function applyAmpCanonical(u){
  try{
    let path=u.pathname.replace(/\/amp\/?$/,'/').replace(/\/amp$/,'/');
    const sp=u.searchParams; if(sp.has('amp')) sp.delete('amp'); if((sp.get('output')||'').toLowerCase()==='amp') sp.delete('output');
    return new URL(u.origin+path+(sp.size?('?'+sp.toString()):''));
  }catch(_){return u;}
}
function buildAffNames(host){
  const names=new Set(AFF.globalNames);
  for(const r of AFF.byHostRules) if(r.test(host)) for(const n of r.names) names.add(n);
  return names;
}
function sortAndDedupe(out){
  const sorted=new URL(out.origin+out.pathname);
  [...new Set([...out.searchParams].map(([k,v])=>k+'\u0000'+v))]
    .map(s=>s.split('\u0000')).sort((a,b)=>a[0].localeCompare(b[0]))
    .forEach(([k,v])=>sorted.searchParams.append(k,v));
  out.search=sorted.search;
}
function tallyParams(sp){const set=new Set();for(const [k] of sp){const kl=k.toLowerCase();if(kl.startsWith('utm_')||killBase.has(kl)) set.add(kl);}return set;}
function tallyHash(h){const set=new Set();if(!h)return set;const s=h.replace(/^#/,'');if(!s.includes('='))return set;for(const [k] of new URLSearchParams(s)){const kl=k.toLowerCase();if(kl.startsWith('utm_')||killBase.has(kl)) set.add(kl);}return set;}
function sanitizeHash(u,affNames,keepOn,removed){
  if(!u.hash)return''; const s=u.hash.replace(/^#/,''); if(!s.includes('='))return'';
  const hp=new URLSearchParams(s);
  for(const [k,v] of [...hp]){
    const kl=k.toLowerCase();
    if(AFF.baseKeep.has(kl)) continue;
    const isAff=affNames.has(kl)||AFF.exactPairs.has(`${kl}:${v}`);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if((isAff && !keepOn) || (isTrack && !isAff)){ hp.delete(k); removed.add(kl); }
  }
  const nh=hp.toString(); return nh?('#'+nh):'';
}

/* Clean */
let last={kept:new Set(),removed:new Set(),mode:'SAFE'};
function cleanOne(s){
  s=(s||'').trim().replace(/[,.;:)\]]$/,''); if(!s) return s;
  let u0; try{u0=new URL(s);}catch(_){ try{u0=new URL('https://'+s);}catch(__){return s;} }
  const remOuter=tallyParams(u0.searchParams), remOuterH=tallyHash(u0.hash);
  let u=unwrapDeep(u0); u=applyAmpCanonical(u);

  const keepOn=document.getElementById('keepAff').checked;
  const host=u.hostname.toLowerCase();
  const affNames=buildAffNames(host);

  const out=new URL(u.origin+u.pathname);
  const kept=new Set(), removed=new Set([...remOuter,...remOuterH]);

  for(const [k,v] of u.searchParams){
    const kl=k.toLowerCase();
    if(AFF.baseKeep.has(kl)){ out.searchParams.append(k,v); kept.add(kl); continue; }
    const isAff=affNames.has(kl)||AFF.exactPairs.has(`${kl}:${v}`);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if(isAff){ if(keepOn){out.searchParams.append(k,v); kept.add(kl);} else removed.add(kl); continue; }
    if(isTrack){ removed.add(kl); continue; }
    out.searchParams.append(k,v);
  }
  out.hash=sanitizeHash(u,affNames,keepOn,removed);
  sortAndDedupe(out);

  last={kept,removed,mode:keepOn?'SAFE':'STRICT'};
  return out.toString();
}
function summarize(){
  const u=firstUrl();
  document.getElementById('openA').disabled = !u;
  document.getElementById('goA').disabled   = !u;
  document.getElementById('openNR').disabled= !u;
  const kept=Array.from(last.kept).sort().join(', ')||'–';
  const rem =Array.from(last.removed).sort().join(', ')||'–';
  statusEl.textContent=`Modus: ${last.mode} · Affiliates behalten: ${kept} · Entfernt: ${rem}`;
  document.getElementById('chip-mode').textContent=`Modus: ${last.mode}`;
}

/* Aktionen */
function run(){ try{ const lines=extractUrls(inEl.value); outEl.value=lines.map(cleanOne).join('\n'); summarize(); applyProfileForInput(); }catch(e){ const d=document.getElementById('debug'); if(d) d.textContent='Laufzeitfehler: '+e.message; } }
document.getElementById('clean').onclick=run;
document.getElementById('keepAff').onchange=run;
document.getElementById('copy').onclick=async()=>{const u=firstUrl(); if(!u)return; try{await navigator.clipboard.writeText(u);alert('Kopiert');}catch(_){}};
document.getElementById('openA').onclick=()=>{const u=firstUrl(); if(u) location.href=u;};
document.getElementById('goA').onclick=()=>{const u=firstUrl(); if(u) window.open(u,'_blank','noopener');};
document.getElementById('openNR').onclick=()=>{const u=firstUrl(); if(u){ const a=document.createElement('a'); a.href=u; a.target='_blank'; a.rel='noreferrer noopener'; document.body.appendChild(a); a.click(); a.remove(); } };
document.getElementById('clear').onclick=()=>{inEl.value='';outEl.value='';statusEl.textContent='Status: –';document.getElementById('debug').textContent='';document.getElementById('chip-prof').textContent='Profil: –';inEl.focus();};

/* Profile + Backup */
const LS_KEY='ss_profiles';
const S = { load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(_){ return {}; } },
            save(obj){ localStorage.setItem(LS_KEY, JSON.stringify(obj)); } };
function hostOfFirstUrl(text){
  if(!text) return '';
  const rx=/\bhttps?:\/\/([^\/\s?#:]+)[^\s]*/i;
  const m=(text+'').match(rx);
  if(m) return m[1].toLowerCase();
  try{ const u=new URL(text.includes('://')?text:('https://'+text)); return u.hostname.toLowerCase(); }catch(_){ return ''; }
}
function selectRad(v){ document.querySelectorAll('input[name="ss-profmode"]').forEach(r=>{ r.checked=(r.value===v); }); }
function applyProfileForInput(){
  const host = hostOfFirstUrl(inEl.value);
  if(!host){ document.getElementById('chip-prof').textContent='Profil: –'; document.getElementById('ss-prof-status').textContent='–'; return; }
  const prof = S.load()[host];
  if(prof==='safe'){ document.getElementById('keepAff').checked=true; document.getElementById('chip-prof').textContent=`Profil: ${host} = SAFE`; document.getElementById('ss-dom').value=host; selectRad('safe'); }
  else if(prof==='strict'){ document.getElementById('keepAff').checked=false; document.getElementById('chip-prof').textContent=`Profil: ${host} = STRICT`; document.getElementById('ss-dom').value=host; selectRad('strict'); }
  else { document.getElementById('chip-prof').textContent=`Profil: ${host} = keines`; document.getElementById('ss-dom').value=host; }
  document.getElementById('chip-mode').textContent=`Modus: ${document.getElementById('keepAff').checked?'SAFE':'STRICT'}`;
}
document.getElementById('ss-save').onclick=()=>{ const dom=(document.getElementById('ss-dom').value||'').trim().toLowerCase(); if(!dom){document.getElementById('ss-prof-status').textContent='Bitte Domain eingeben.';return;}
  const mode=document.querySelector('input[name="ss-profmode"]:checked')?.value||'safe';
  const map=S.load(); map[dom]=mode; S.save(map); document.getElementById('ss-prof-status').textContent=`Gespeichert: ${dom} → ${mode.toUpperCase()}`; applyProfileForInput(); };
document.getElementById('ss-del').onclick =()=>{ const dom=(document.getElementById('ss-dom').value||'').trim().toLowerCase(); const map=S.load(); if(map[dom]){ delete map[dom]; S.save(map); document.getElementById('ss-prof-status').textContent=`Gelöscht: ${dom}`; } else { document.getElementById('ss-prof-status').textContent='Nichts zu löschen.'; } applyProfileForInput(); };
document.getElementById('ss-x').onclick = () => {
  const dom = (document.getElementById('ss-dom').value||'').trim().toLowerCase();
  if(dom){
    const map = S.load();
    if(map[dom]){ delete map[dom]; S.save(map); document.getElementById('ss-prof-status').textContent = `Gelöscht: ${dom}`; }
    else { document.getElementById('ss-prof-status').textContent = 'Kein Profil vorhanden.'; }
  }
  document.getElementById('ss-dom').value = '';
  applyProfileForInput();
};

/* Autofill */
document.addEventListener('DOMContentLoaded', function(){
  const p=new URLSearchParams(location.search);
  let q=p.get('u')||p.get('url');
  const ao=p.get('open')||p.get('ao');
  const aff=p.get('aff')||p.get('mode');
  if(aff==='0'||/^strict$/i.test(aff)) document.getElementById('keepAff').checked=false;
  if(aff==='1'||/^safe$/i.test(aff))   document.getElementById('keepAff').checked=true;
  if(q){ try{q=decodeURIComponent(q);}catch(_){ } inEl.value=q; run();
    if(ao==='1'){ const u=firstUrl(); if(u) location.href=u; }
  }
});
</script>
</body>
</html>