<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SafeShare – Link säubern (ohne Tracking)</title>
  <meta name="description" content="SafeShare entfernt Tracking-Parameter aus Links – lokal im Browser. Saubere Links kopieren oder teilen." />

  <!-- Google Search Console -->
  <meta name="google-site-verification" content="3-mi6zLHRdFC14-RdTIF6GY90jKWfyLNLsFBhGLqQB0" />
  <!-- Bing Webmaster Tools -->
  <meta name="msvalidate.01" content="B18ACE18875F9614DAA5CF69EED40ACE" />

  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b0c10;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.09);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --border: rgba(255,255,255,.14);
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
      --pad: 16px;
      --max: 980px;
      --btn: rgba(255,255,255,.10);
      --btn2: rgba(255,255,255,.16);
      --ok: rgba(87, 226, 170, .18);
      --warn: rgba(255, 197, 84, .18);
      --bad: rgba(255, 95, 95, .16);
      --focus: 0 0 0 3px rgba(87, 226, 170, .25);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f6f7fb;
        --card: #ffffff;
        --card2: #f3f5ff;
        --text: rgba(17, 24, 39, .95);
        --muted: rgba(17, 24, 39, .65);
        --border: rgba(17, 24, 39, .12);
        --shadow: 0 10px 30px rgba(17,24,39,.08);
        --btn: rgba(17,24,39,.06);
        --btn2: rgba(17,24,39,.10);
        --ok: rgba(87, 226, 170, .20);
        --warn: rgba(255, 197, 84, .22);
        --bad: rgba(255, 95, 95, .18);
        --focus: 0 0 0 3px rgba(17, 130, 98, .22);
      }
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    a{ color: inherit; }
    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 20px 16px 42px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 6px 2px 18px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .logo{
      width: 36px; height: 36px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(87,226,170,.40), rgba(255,197,84,.28));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      line-height: 1.1;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand .sub{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .topActions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1.1fr .9fr; }
    }
    label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 8px;
    }
    textarea, input[type="text"]{
      width: 100%;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--card2);
      color: var(--text);
      padding: 12px 12px;
      font-size: 15px;
      line-height: 1.3;
      outline: none;
    }
    textarea:focus, input[type="text"]:focus{
      box-shadow: var(--focus);
      border-color: rgba(87,226,170,.45);
    }
    textarea{
      min-height: 92px;
      resize: vertical;
    }
    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      margin-top: 12px;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: var(--btn);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 14px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{ background: var(--btn2); }
    .btn.primary{
      background: rgba(87,226,170,.18);
      border-color: rgba(87,226,170,.35);
    }
    .btn.primary:hover{ background: rgba(87,226,170,.24); }
    .btn.danger{
      background: rgba(255,95,95,.14);
      border-color: rgba(255,95,95,.30);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--btn);
      color: var(--muted);
      font-size: 12px;
    }
    .muted{ color: var(--muted); }
    .msg{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .msg.ok{ color: rgba(87,226,170,.95); }
    .msg.bad{ color: rgba(255,95,95,.95); }
    .resultBox{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:flex-start;
    }
    .resultBox input{ flex: 1 1 420px; }
    .mini{
      font-size: 12px;
      color: var(--muted);
    }
    details{
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    details > summary{
      cursor:pointer;
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
      list-style: none;
      outline: none;
    }
    details > summary::-webkit-details-marker{ display:none; }
    .receiptBlock{
      margin-top: 10px;
      display:grid;
      gap: 10px;
    }
    .rcItem{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .rcItem strong{
      display:block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .rcItem .keys{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: var(--muted);
      word-break: break-word;
    }
    .hint{
      border-left: 3px solid rgba(255,197,84,.55);
      background: var(--warn);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
    }
    .footer{
      margin-top: 16px;
      font-size: 12px;
      color: var(--muted);
    }
    .sep{ height: 1px; background: var(--border); margin: 12px 0; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>SafeShare</h1>
          <span class="sub">Link säubern · lokal · ohne Tracking</span>
        </div>
      </div>

      <div class="topActions">
        <a class="btn" href="pro-app.html" id="topProLink">Pro</a>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Input -->
      <section class="card">
        <label for="urlInput">Link</label>
        <textarea id="urlInput" placeholder="Link einfügen… (https://…)" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>

        <div class="row">
          <button class="btn" id="pasteBtn" type="button">Aus Zwischenablage</button>
          <button class="btn primary" id="cleanBtn" type="button">Säubern</button>
          <button class="btn danger" id="clearBtn" type="button">Leeren</button>
        </div>

        <div class="msg" id="statusMsg"></div>

        <div class="sep"></div>

        <div class="mini">
          Standard-Modus: <strong>Privat</strong> (entfernt Klick-IDs/UTM/Newsletter-Tracker; unbekannte Parameter werden behalten, damit Links nicht kaputtgehen).
        </div>
      </section>

      <!-- RIGHT: Output -->
      <section class="card" aria-live="polite">
        <div class="pill" id="modePill">Ergebnis</div>

        <div id="outputSection" hidden>
          <div style="margin-top:10px;">
            <label for="cleanedOutput">Bereinigter Link</label>
            <div class="resultBox">
              <input id="cleanedOutput" type="text" readonly />
              <a class="btn" id="openBtn" href="#" target="_blank" rel="noopener">Öffnen</a>
            </div>

            <div class="row">
              <button class="btn" id="copyBtn" type="button">Kopieren</button>
              <button class="btn" id="shareBtn" type="button">Teilen</button>
              <a class="btn" id="goPro" href="pro-app.html">Details & Regeln (Pro)</a>
              <button class="btn danger" id="undoBtn" type="button">Undo (Original)</button>
            </div>

            <section id="receipt" style="margin-top:12px;">
              <div id="receiptSummary" class="muted"></div>

              <details>
                <summary>Was wurde geändert?</summary>

                <div class="receiptBlock">
                  <div class="rcItem" id="receiptRemovedBox">
                    <strong>Entfernt</strong>
                    <div id="receiptRemoved" class="keys"></div>
                  </div>

                  <div class="rcItem" id="receiptKeptBox">
                    <strong>Behalten</strong>
                    <div id="receiptKept" class="keys"></div>
                  </div>

                  <div class="hint" id="receiptHint" hidden>
                    Hinweis: Manche Seiten nutzen signierte Parameter. Wenn etwas nicht funktioniert, nutze <strong>Undo (Original)</strong>.
                  </div>
                </div>
              </details>

              <div class="footer">
                Pro zeigt Presets, Domain-Regeln und Parameter-Toggles. Alles lokal gespeichert (localStorage).
              </div>
            </section>
          </div>
        </div>

        <div id="emptyState" class="muted" style="margin-top:10px;">
          Hier erscheint der bereinigte Link.
        </div>
      </section>
    </div>
  </div>

  <script>
    // ---------------------------
    // SafeShare (app.html) – Free/Basis
    // - Clean: utm_* + Click IDs + gängige Newsletter/Marketing IDs
    // - Keep unknowns to avoid breaking links
    // - Show compact "Receipt" (entfernt/behalten)
    // - Pro deep control lives in pro-app.html (next step)
    // ---------------------------

    const $ = (id) => document.getElementById(id);

    const ui = {
      input: $("urlInput"),
      paste: $("pasteBtn"),
      clean: $("cleanBtn"),
      clear: $("clearBtn"),
      msg: $("statusMsg"),

      outputSection: $("outputSection"),
      emptyState: $("emptyState"),
      cleanedOutput: $("cleanedOutput"),
      openBtn: $("openBtn"),
      copyBtn: $("copyBtn"),
      shareBtn: $("shareBtn"),
      undoBtn: $("undoBtn"),
      goPro: $("goPro"),
      topProLink: $("topProLink"),

      receiptSummary: $("receiptSummary"),
      receiptRemoved: $("receiptRemoved"),
      receiptKept: $("receiptKept"),
      receiptHint: $("receiptHint"),
      modePill: $("modePill"),
    };

    let lastOriginal = "";
    let lastCleaned = "";
    let lastResult = null;

    // --- Categories (for human-readable receipt) ---
    const CATEGORY_LABEL = {
      CLICK_ID: "Werbe-Klick-IDs",
      UTM: "Kampagnen-Tracking",
      EMAIL: "E-Mail/Newsletter",
      EXPERIMENT: "A/B/Experimente",
      AFFILIATE: "Affiliate/Referral",
      OTHER_TRACK: "Allgemeines Tracking",
      UNKNOWN: "Unbekannt (behalten)"
    };

    function categorizeParam(k){
      const key = String(k || "");
      if (/^utm_/i.test(key)) return "UTM";
      if (/(^|_)(gclid|dclid|gbraid|wbraid|msclkid|fbclid|ttclid|twclid|igshid)$/i.test(key)) return "CLICK_ID";
      if (/^(mc_cid|mc_eid|mkt_tok|oly_anon_id|oly_enc_id|vero_id|vero_conv)$/i.test(key)) return "EMAIL";
      if (/^(abtest|variant|experiment|bucket|hsctatracking|__hsfp|__hssc|__hstc)$/i.test(key)) return "EXPERIMENT";
      if (/^(ref|tag|aff|aff_id|affid|partner|partner_id|ascsubtag|clickref|irclickid)$/i.test(key)) return "AFFILIATE";
      if (/^(source|spm|scm|cmpid|campaignid|ad_id|adgroupid|creative|keyword|matchtype|device|gclsrc|fb_action_ids|fb_action_types)$/i.test(key)) return "OTHER_TRACK";
      return "UNKNOWN";
    }

    function shouldRemoveInFree(key){
      const k = String(key || "");
      if (/^utm_/i.test(k)) return true;
      if (/(^|_)(gclid|dclid|gbraid|wbraid|msclkid|fbclid|ttclid|twclid|igshid)$/i.test(k)) return true;
      if (/^(mc_cid|mc_eid|mkt_tok|oly_anon_id|oly_enc_id|vero_id|vero_conv)$/i.test(k)) return true;
      if (/^(abtest|variant|experiment|bucket|hsctatracking|__hsfp|__hssc|__hstc)$/i.test(k)) return true;
      // Affiliate: im Free/Privat standardmäßig entfernen (Pro kann es behalten)
      if (/^(ref|tag|aff|aff_id|affid|partner|partner_id|ascsubtag|clickref|irclickid)$/i.test(k)) return true;
      // sonst nicht entfernen (unknowns behalten)
      return false;
    }

    function normalizeUrl(raw){
      let s = String(raw || "").trim();
      if (!s) return "";
      // If user pasted without scheme, try https://
      if (!/^https?:\/\//i.test(s) && /^[a-z0-9.-]+\.[a-z]{2,}(\/|$)/i.test(s)) {
        s = "https://" + s;
      }
      return s;
    }

    function cleanUrl(rawUrl){
      const url = new URL(rawUrl);
      const removed = [];
      const kept = [];

      // Collect first (URLSearchParams is live while mutating)
      const entries = Array.from(url.searchParams.entries());

      // Reset and rebuild
      url.search = "";

      for (const [k,v] of entries){
        const cat = categorizeParam(k);
        if (shouldRemoveInFree(k)){
          removed.push({ key: k, value: v, category: cat });
        } else {
          kept.push({ key: k, value: v, category: cat });
          url.searchParams.append(k, v);
        }
      }

      return {
        cleaned: url.toString(),
        removed,
        kept,
        host: url.host
      };
    }

    function setMsg(text, kind=""){
      ui.msg.textContent = text || "";
      ui.msg.className = "msg" + (kind ? " " + kind : "");
    }

    function renderResult(original, result){
      lastOriginal = original;
      lastCleaned = result.cleaned;
      lastResult = result;

      ui.outputSection.hidden = false;
      ui.emptyState.hidden = true;

      ui.cleanedOutput.value = result.cleaned;
      ui.openBtn.href = result.cleaned;

      // Pro links: pass ORIGINAL (so Pro kann komplett entscheiden)
      const encoded = encodeURIComponent(original);
      ui.goPro.href = `pro-app.html?url=${encoded}`;
      ui.topProLink.href = `pro-app.html?url=${encoded}`;

      // Summary
      ui.receiptSummary.textContent =
        `${result.removed.length} entfernt · ${result.kept.length} behalten · Domain: ${result.host}`;

      // Removed grouped by category
      const removedByCat = {};
      for (const r of result.removed){
        removedByCat[r.category] ||= [];
        removedByCat[r.category].push(r.key);
      }
      const removedLines = Object.entries(removedByCat).map(([cat, keys]) => {
        const uniq = [...new Set(keys)];
        const short = uniq.slice(0, 10).join(", ") + (uniq.length > 10 ? " …" : "");
        return `${CATEGORY_LABEL[cat] || cat}: ${short}`;
      });

      ui.receiptRemoved.textContent = removedLines.length ? removedLines.join(" · ") : "—";

      // Kept (compact)
      const keptKeys = [...new Set(result.kept.map(p => p.key))];
      ui.receiptKept.textContent =
        keptKeys.length ? (keptKeys.slice(0, 18).join(", ") + (keptKeys.length > 18 ? " …" : "")) : "—";

      // Hint: show if many removed or affiliate removed (common “why?”)
      const removedAffiliate = result.removed.some(r => r.category === "AFFILIATE");
      ui.receiptHint.hidden = !(result.removed.length >= 6 || removedAffiliate);

      // Mode pill
      ui.modePill.textContent = "Ergebnis · Privat";
    }

    async function pasteFromClipboard(){
      try{
        if (navigator.clipboard && navigator.clipboard.readText){
          const text = await navigator.clipboard.readText();
          if (text) {
            ui.input.value = text.trim();
            setMsg("Aus Zwischenablage eingefügt.", "ok");
          } else {
            setMsg("Zwischenablage ist leer.", "");
          }
        } else {
          setMsg("Zwischenablage nicht verfügbar. Bitte manuell einfügen.", "");
        }
      }catch(e){
        setMsg("Zugriff auf Zwischenablage nicht erlaubt. Bitte manuell einfügen.", "bad");
      }
    }

    async function copyToClipboard(text){
      try{
        if (navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(text);
          setMsg("Kopiert.", "ok");
          return true;
        }
      }catch(e){}
      // Fallback
      try{
        ui.cleanedOutput.focus();
        ui.cleanedOutput.select();
        document.execCommand("copy");
        setMsg("Kopiert.", "ok");
        return true;
      }catch(e){
        setMsg("Kopieren nicht verfügbar. Bitte manuell markieren.", "bad");
        return false;
      }
    }

    async function shareLink(url){
      try{
        if (navigator.share){
          await navigator.share({ title: "SafeShare", text: "Bereinigter Link", url });
          setMsg("Geteilt.", "ok");
          return true;
        }
        // fallback
        await copyToClipboard(url);
        return true;
      }catch(e){
        // user cancelled share is not an error
        setMsg("Teilen abgebrochen.", "");
        return false;
      }
    }

    function runClean(){
      const raw = normalizeUrl(ui.input.value);
      if (!raw){
        setMsg("Bitte einen Link einfügen.", "bad");
        return;
      }
      if (!/^https?:\/\//i.test(raw)){
        setMsg("Nur http/https-Links werden unterstützt.", "bad");
        return;
      }

      try{
        const result = cleanUrl(raw);
        renderResult(raw, result);

        // If nothing removed, be explicit
        if (result.removed.length === 0){
          setMsg("Keine typischen Tracking-Parameter gefunden.", "ok");
        } else {
          setMsg("Link bereinigt.", "ok");
        }
      }catch(e){
        setMsg("Das sieht nicht wie ein gültiger Link aus.", "bad");
      }
    }

    function clearAll(){
      ui.input.value = "";
      ui.cleanedOutput.value = "";
      ui.outputSection.hidden = true;
      ui.emptyState.hidden = false;
      ui.modePill.textContent = "Ergebnis";
      lastOriginal = "";
      lastCleaned = "";
      lastResult = null;
      setMsg("");
    }

    // --- Events ---
    ui.paste.addEventListener("click", pasteFromClipboard);
    ui.clean.addEventListener("click", runClean);
    ui.clear.addEventListener("click", clearAll);

    ui.copyBtn.addEventListener("click", () => {
      if (!lastCleaned) return;
      copyToClipboard(lastCleaned);
    });

    ui.shareBtn.addEventListener("click", () => {
      if (!lastCleaned) return;
      shareLink(lastCleaned);
    });

    ui.undoBtn.addEventListener("click", async () => {
      if (!lastOriginal) return;
      ui.cleanedOutput.value = lastOriginal;
      ui.openBtn.href = lastOriginal;
      await copyToClipboard(lastOriginal);
      setMsg("Original wiederhergestellt (kopiert).", "ok");
    });

    // Auto-load if URL param provided (optional)
    (function initFromQuery(){
      const qs = new URLSearchParams(location.search);
      const u = qs.get("url");
      if (u){
        try{
          const decoded = decodeURIComponent(u);
          ui.input.value = decoded;
          runClean();
        }catch(e){}
      }
    })();
  </script>
</body>
</html>
