<!doctype html><html lang="de"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – Link-Reiniger v7</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:16px;line-height:1.4}
h1{font-size:18px;margin:0 0 8px}
textarea,input{width:100%;box-sizing:border-box;padding:10px;font-size:14px}
textarea{min-height:140px;resize:vertical}
.btn{padding:10px 12px;font-size:14px;margin-right:8px}
.muted{color:#666;font-size:12px}
#out{min-height:140px}
</style></head><body>
<h1>SafeShare – Link-Reiniger <small style="font-weight:normal;color:#666">v7</small></h1>
<p class="muted">Entfernt <code>utm_</code>, <code>gclid</code>, <code>fbclid</code>, <code>twclid</code>. Verschachtelte Links werden entpackt.</p>

<textarea id="in" placeholder="Link(s) einfügen. Eine Zeile pro Link."></textarea>
<div style="margin:10px 0;">
  <button id="clean" class="btn">Säubern</button>
  <button id="copy"  class="btn">Kopieren</button>
  <button id="open"  class="btn">Öffnen</button>
  <button id="clear" class="btn" aria-label="Leeren" title="Leeren" style="width:38px;padding:8px 0">&times;</button>
</div>
<textarea id="out" readonly placeholder="Bereinigte URL(s) erscheinen hier..."></textarea>

<p class="muted">Bookmarklet: <a id="bm" href="#">UTM jetzt säubern</a></p>
<p class="muted"><a href="impressum.html">Impressum</a> · <a href="datenschutz.html">Datenschutz</a></p>

<script>
const $=id=>document.getElementById(id);
const inEl=$('in'), outEl=$('out');

function extractUrls(t){
  const rx=/\bhttps?:\/\/[^\s<>"')]+/gi; const r=[]; let m;
  while((m=rx.exec(t||''))) r.push(m[0]);
  return r.length? r : (t||'').split('\n').map(s=>s.trim()).filter(Boolean);
}

function deepDecode(str){
  let prev=str||'', curr=str||'';
  for(let i=0;i<5;i++){
    try{ curr=decodeURIComponent(prev); }catch(e){ break; }
    if(curr===prev) break;
    prev=curr;
  }
  return curr;
}

function unwrapNested(u){
  // prüfe alle Parameter: mehrfach dekodieren und http(s) extrahieren
  for(const [k,v] of u.searchParams){
    const dec=deepDecode(v||'');
    const m=dec.match(/https?:\/\/[^\s"'<>]+/i);
    if(m){
      try{ return new URL(m[0]); }catch(e){}
    }
  }
  return u;
}

function cleanOne(s){
  s=(s||'').trim().replace(/[,.;:)\]]$/,'');
  if(!s) return s;
  let u;
  try{ u=new URL(s); }
  catch(e){ try{ u=new URL('https://'+s); } catch(e2){ return s; } }

  u=unwrapNested(u);

  const kill=new Set(['fbclid','gclid','twclid','msclkid','mc_cid','mc_eid','igshid','vero_id','wickedid']);
  const out=new URL(u.origin+u.pathname);
  for(const [k,v] of u.searchParams){
    const kl=k.toLowerCase();
    if(kl.startsWith('utm_')||kill.has(kl)) continue;
    out.searchParams.append(k,v);
  }
  return out.toString(); // Fragment entfernt
}

function runClean(){
  const lines=extractUrls(inEl.value);
  outEl.value=lines.map(cleanOne).join('\n');
}

$('clean').onclick=runClean;
$('copy').onclick=async()=>{const t=outEl.value;if(!t)return;try{await navigator.clipboard.writeText(t);alert('Kopiert')}catch(e){}};
$('open').onclick=()=>{const t=(outEl.value||'').split('\n').find(Boolean); if(t) location.assign(t);};
$('clear').onclick=()=>{inEl.value='';outEl.value='';inEl.focus();};

$('bm').href="javascript:(function(){try{var u=new URL(location.href);var kill=['fbclid','gclid','twclid','msclkid','mc_cid','mc_eid','igshid','vero_id','wickedid'];u.hash='';u.searchParams.forEach(function(v,k){var kl=k.toLowerCase();if(kl.indexOf('utm_')===0||kill.indexOf(kl)>-1)u.searchParams.delete(k)});location.replace(u.toString())}catch(e){alert('Kein gültiger Link')}})()";

// Auto per ?u= oder ?url=
(function(){const p=new URLSearchParams(location.search);const q=p.get('u')||p.get('url');if(q){inEl.value=decodeURIComponent(q);runClean();}})();
</script>
</body></html>