<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – Link-Reiniger v35</title>

<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="apple-touch-icon" sizes="180x180" href="safeshare-180.png">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#111827">

<style>
  :root{--fg:#111827;--muted:#666;--bd:#ddd}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:16px;line-height:1.45;color:var(--fg)}
  h1{font-size:18px;margin:0 0 8px}
  textarea,input{width:100%;box-sizing:border-box;padding:10px;font-size:14px}
  textarea{min-height:140px;resize:vertical}
  .btn{display:inline-block;padding:10px 12px;font-size:14px;margin:6px 8px 6px 0;text-decoration:none;border:1px solid var(--bd);border-radius:6px;cursor:pointer}
  .muted{color:var(--muted);font-size:12px}
  #out{min-height:140px}
  #status{margin-top:8px;padding:8px;border:1px dashed var(--bd);border-radius:6px}
  .disabled{opacity:.5;pointer-events:none}
  label.inline{display:inline-flex;align-items:center;gap:0}
  label.inline input{margin-right:4px}
  .opts{margin:2px 0 10px}
  details{margin:10px 0}
  details summary{cursor:pointer;user-select:none}
  details[open]{border:1px solid var(--bd);border-radius:6px;padding:8px}

  /* Chips */
  .row{margin-top:6px}
  .label{display:inline-block;min-width:150px;font-size:12px;color:var(--muted)}
  .chips{display:inline-flex;flex-wrap:wrap;gap:6px;vertical-align:middle}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid;line-height:1.6}
  .chip.keep{background:#f0fdf4;border-color:#86efac;color:#065f46}
  .chip.rm{background:#fef2f2;border-color:#fca5a5;color:#7f1d1d}
  .badge{display:inline-block;padding:0 6px;border-radius:4px;background:#f3f4f6;margin-left:6px;font-size:12px;color:#374151}
</style>
</head>
<body>
<h1>SafeShare – Link-Reiniger <small style="font-weight:normal;color:#666">v35</small></h1>
<p class="muted">Entfernt <code>utm_</code>, <code>gclid</code>, <code>fbclid</code>, <code>twclid</code>, <code>wtmc</code>, <code>wt_mc</code>, <code>xtor</code> u. a. Entschachtelt Redirects. Optional: Affiliate-Provisionen behalten.</p>

<textarea id="in" placeholder="Link(s) einfügen. Eine Zeile pro Link. Beliebiger Text wird erkannt."></textarea>

<div>
  <button id="clean" class="btn" type="button">Säubern</button>
  <button id="copy"  class="btn" type="button">Kopieren</button>
  <a id="openA" class="btn disabled" href="#" role="button">Öffnen</a>
  <a id="goA"   class="btn disabled" href="#" target="_blank" rel="noopener" role="button">1-Klick</a>
  <button id="clear" class="btn" type="button" aria-label="Leeren" title="Leeren" style="width:38px;padding:8px 0">&times;</button>
</div>
<div class="opts">
  <label class="inline muted"><input type="checkbox" id="keepAff" checked>Provisionen behalten</label>
</div>

<div>
  <button id="share"   class="btn" type="button">Teilen</button>
  <button id="copyAdv" class="btn" type="button">Kopieren (1. Link)</button>
</div>

<p class="muted">„1-Klick“ öffnet im neuen Tab. „Öffnen“ im selben Tab.</p>

<textarea id="out" readonly placeholder="Bereinigte URL(s) erscheinen hier..."></textarea>
<div id="status" class="muted">Status: –</div>

<details id="help">
  <summary>Kurzanleitung / Buttons</summary>
  <ul style="margin:8px 0 0 18px;font-size:13px">
    <li><strong>Säubern</strong>: Entfernt Tracking-Parameter, entschachtelt Redirects.</li>
    <li><strong>Kopieren</strong>: Kopiert <em>alle</em> bereinigten Links aus dem Ausgabefeld.</li>
    <li><strong>Öffnen</strong>: Ersten bereinigten Link im selben Tab öffnen.</li>
    <li><strong>1-Klick</strong>: Ersten bereinigten Link in neuem Tab öffnen.</li>
    <li><strong>× Leeren</strong>: Eingabe, Ausgabe, Status zurücksetzen.</li>
    <li><strong>Provisionen behalten</strong>: AN = Affiliate-Parameter bleiben; AUS = fast alles weg, <code>coupon/code</code> bleiben.</li>
    <li><strong>Teilen</strong>: Sauberen Link per Share-Sheet teilen; Fallback: kopiert Text.</li>
    <li><strong>Kopieren (1. Link)</strong>: Kopiert nur den ersten bereinigten Link.</li>
  </ul>
</details>

<p style="margin-top:10px">
  <a href="https://payhip.com/b/VDm3B" target="_blank" rel="noopener" class="btn">Projekt unterstützen</a>
  <a href="https://payhip.com/auth/register/af69075ca4efafa" target="_blank" rel="noopener" class="btn">Partner werden</a>
  <a href="bookmarklets.html" class="btn">Bookmarklets</a>
</p>

<p class="muted">Bookmarklets in dieser Seite:
  <a id="bm" href="#">Affiliate-safe</a> ·
  <a id="bmStrict" href="#">Strict</a>
</p>

<p class="muted"><a href="impressum.html">Impressum</a> · <a href="datenschutz.html">Datenschutz</a></p>

<script>
const $ = id => document.getElementById(id);
const inEl = $('in'), outEl = $('out'), statusEl = $('status'), openA = $('openA'), goA = $('goA');

// bekannte Tracking-Parameter
const kill = new Set([
  'fbclid','gclid','twclid','msclkid','igshid','vero_id','wickedid','ref_src','ref_url','si','spm','mkt_tok',
  'wtmc','wt_mc','wt_zmc','zmc','xtor'
]);

// Affiliate-Whitelists
const AFF = {
  baseKeep: new Set(['coupon','code']),
  globalNames: new Set([
    'ref','refid','ref_id','referrer',
    'aff','affid','aff_id','affiliate','affiliate_id','affsource','affsrc','affname','affcamp','affcampaign',
    'campaign','campaignid','campaign_id',
    'clickid','click_id','irclickid','tduid','admitad_uid','sscid','cjevent','clickref','clickref2',
    'subid','sub_id','sid','u1','u2','u3','u4','u5','pid','aid','awinaffid','awinmid'
  ]),
  byHostRules: [
    { test: h => /(^|\.)amazon\./i.test(h),   names: new Set(['tag','ascsubtag']) },
    { test: h => /(^|\.)ebay\./i.test(h),     names: new Set(['campid','customid','mkcid','mkevt','mkrid']) },
    { test: h => /(^|\.)rakuten\./i.test(h),  names: new Set(['ranmid','raneaid','ransiteid','ranlinkid']) },
    { test: h => /(^|\.)aliexpress\./i.test(h), names: new Set(['aff_fcid','aff_fsk','aff_platform','aff_trace_key','aff_short_key']) }
  ],
  exactPairs: new Set([])
};

let lastInfo = [];

function extractUrls(t){
  const rx=/\bhttps?:\/\/[^\s<>"')]+/gi, r=[]; let m;
  while((m=rx.exec(t||''))) r.push(m[0]);
  return r.length? r : (t||'').split('\n').map(s=>s.trim()).filter(Boolean);
}
function deepDecode(s){
  let a=s||'', b=s||'';
  for(let i=0;i<8;i++){ try{ b=decodeURIComponent(a);}catch(_){ break;} if(b===a) break; a=b; }
  return a;
}
function unwrapDeep(u){
  for(let i=0;i<6;i++){
    let found=null;
    for(const [,v] of u.searchParams){
      const dec=deepDecode(v||''); const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);
      if(m){ found=m[0]; break; }
    }
    if(!found){
      const dec=deepDecode(u.hash||''); const m=(dec||'').match(/https?:\/\/[^\s"'<>)]+/i);
      if(m) found=m[0];
    }
    if(!found){
      const dec=deepDecode(u.href); const m=dec.match(/https?:\/\/[^\s"'<>)]+/i);
      if(m && m[0]!==u.href) found=m[0];
    }
    if(!found) break; try{ u=new URL(found);}catch(_){ break; }
  } return u;
}
function buildKeepNames(host){
  const keep=new Set(AFF.baseKeep);
  if ($('keepAff')?.checked){
    for (const n of AFF.globalNames) keep.add(n);
    for (const rule of AFF.byHostRules) if (rule.test(host)) for (const n of rule.names) keep.add(n);
  }
  return keep;
}

function cleanOne(s){
  s=(s||'').trim().replace(/[,.;:)\]]$/,''); if(!s) return s;
  let u; try{ u=new URL(s);}catch(_){ try{ u=new URL('https://'+s);}catch(__){ return s; } }
  u=unwrapDeep(u);

  const host=u.hostname.toLowerCase();
  const keepNames=buildKeepNames(host);

  const out=new URL(u.origin+u.pathname);
  const affKept=new Set(), removed=new Set();

  for(const [k,v] of u.searchParams){
    const kl=k.toLowerCase();
    const isAffiliate = keepNames.has(kl) || AFF.exactPairs.has(`${kl}:${v}`);
    const isTracking  = kl.startsWith('utm_') || kill.has(kl);

    if(isAffiliate){
      if ($('keepAff')?.checked){ out.searchParams.append(k,v); affKept.add(kl); }
      else { removed.add(kl); }
      continue;
    }
    if(isTracking){
      removed.add(kl);
      continue;
    }
    out.searchParams.append(k,v);
  }

  lastInfo.push({affKept,removed});
  return out.toString();
}

function firstOutUrl(){ return (outEl.value||'').split(/\s+/).find(x=>/^https?:\/\//i.test(x))||''; }

function chipList(items, cls){
  if(!items || !items.size) return '<span class="muted">–</span>';
  return Array.from(items).sort().map(x=>`<span class="chip ${cls}">${x}</span>`).join(' ');
}

function summarizeAndAnchors(){
  const first = firstOutUrl();
  if(!lastInfo.length){
    statusEl.textContent='Status: –';
  }else{
    const kept=new Set(), removed=new Set();
    lastInfo.forEach(i=>{ i.affKept.forEach(x=>kept.add(x)); i.removed.forEach(x=>removed.add(x)); });
    const on=$('keepAff')?.checked;
    statusEl.innerHTML =
      `Modus: Provisionen ${on?'AN':'AUS'} <span class="badge">${on?'Affiliate-safe':'Strict'}</span>`+
      `<div class="row"><span class="label">Affiliates erlaubt:</span> <strong>${on?'Ja':'Nein'}</strong></div>`+
      `<div class="row"><span class="label">Affiliates behalten:</span> <span class="chips">${chipList(kept,'keep')}</span></div>`+
      `<div class="row"><span class="label">Entfernt:</span> <span class="chips">${chipList(removed,'rm')}</span></div>`;
  }
  if(first){
    openA.href = first;  openA.classList.remove('disabled');
    goA.href   = first;  goA.classList.remove('disabled');
  }else{
    openA.href = '#';    openA.classList.add('disabled');
    goA.href   = '#';    goA.classList.add('disabled');
  }
  updateCopyButtons();
}

function runClean(){
  lastInfo=[];
  const lines=extractUrls(inEl.value);
  outEl.value=lines.map(cleanOne).join('\n');
  summarizeAndAnchors();
}

function updateCopyButtons(){
  const lines=(outEl.value||'').split(/\n+/).map(s=>s.trim()).filter(s=>/^https?:\/\//i.test(s));
  $('copy').textContent = lines.length>1 ? `Kopieren (alle ${lines.length})` : 'Kopieren';
  $('copyAdv').textContent = 'Kopieren (1. Link)';
}

// UI
$('clean').onclick=runClean;
$('copy').onclick=async()=>{const t=outEl.value;if(!t)return;try{await navigator.clipboard.writeText(t);alert('Kopiert');}catch(_){}};
$('clear').onclick=()=>{inEl.value='';outEl.value='';lastInfo=[];summarizeAndAnchors();updateCopyButtons();inEl.focus();};
$('keepAff').onchange=runClean;
let tmr=null; inEl.addEventListener('input',()=>{ clearTimeout(tmr); tmr=setTimeout(runClean,150); });

// Teilen und Kopieren (1. Link)
const appLink="https://j-ai-71.github.io/Supersystem/app.html";
function currentMsg(){
  const t=firstOutUrl(); if(!t) return '';
  return `Sauberer Link:\n${t}\n— gereinigt mit SafeShare: ${appLink}`;
}
$('share').onclick=async()=>{
  runClean();
  const msg=currentMsg(); if(!msg){ alert('Kein Ziel'); return; }
  const t=firstOutUrl();
  if(navigator.share){ try{ await navigator.share({title:'SafeShare',text:msg,url:t}); }catch(_){ } }
  else{ try{ await navigator.clipboard.writeText(msg); alert('In Zwischenablage'); }catch(_){ } }
};
$('copyAdv').onclick=async()=>{
  runClean();
  const t=firstOutUrl(); if(!t){ alert('Kein Ziel'); return; }
  try{ await navigator.clipboard.writeText(t); alert('Kopiert'); }catch(_){}
};

// Bookmarklets (inkl. neuer Keys)
$('bm').href="javascript:(function(){try{var u=new URL(location.href);var h=u.hostname.toLowerCase();var keep=new Set(['coupon','code','ref','refid','ref_id','referrer','aff','affid','aff_id','affiliate','affiliate_id','affsource','affsrc','affname','affcamp','affcampaign','campaign','campaignid','campaign_id','clickid','click_id','irclickid','tduid','admitad_uid','sscid','cjevent','clickref','clickref2','subid','sub_id','sid','u1','u2','u3','u4','u5','pid','aid','awinaffid','awinmid']);if((/(^|\\.)amazon\\./i).test(h)){['tag','ascsubtag'].forEach(function(x){keep.add(x);});}if((/(^|\\.)ebay\\./i).test(h)){['campid','customid','mkcid','mkevt','mkrid'].forEach(function(x){keep.add(x);});}if((/(^|\\.)rakuten\\./i).test(h)){['ranmid','raneaid','ransiteid','ranlinkid'].forEach(function(x){keep.add(x);});}if((/(^|\\.)aliexpress\\./i).test(h)){['aff_fcid','aff_fsk','aff_platform','aff_trace_key','aff_short_key'].forEach(function(x){keep.add(x);});}u.hash='';var del=[];u.searchParams.forEach(function(v,k){var kl=k.toLowerCase();if(kl.indexOf('utm_')===0||['fbclid','gclid','twclid','msclkid','igshid','vero_id','wickedid','ref_src','ref_url','si','spm','mkt_tok','wtmc','wt_mc','wt_zmc','zmc','xtor'].indexOf(kl)>-1){if(!keep.has(kl)) del.push(k);}});del.forEach(function(k){u.searchParams.delete(k);});location.replace(u.toString());}catch(e){alert('Kein gültiger Link');}})()";

$('bmStrict').href="javascript:(function(){try{var u=new URL(location.href);u.hash='';var keep=new Set(['coupon','code']);var rm=['fbclid','gclid','twclid','msclkid','igshid','vero_id','wickedid','ref','refid','ref_id','referrer','aff','affid','aff_id','affiliate','affiliate_id','affsource','affsrc','affname','affcamp','affcampaign','campaign','campaignid','campaign_id','clickid','click_id','irclickid','tduid','admitad_uid','sscid','cjevent','clickref','clickref2','subid','sub_id','sid','u1','u2','u3','u4','u5','pid','aid','awinaffid','awinmid','tag','ascsubtag','campid','customid','mkcid','mkevt','mkrid','ranmid','raneaid','ransiteid','ranlinkid','aff_fcid','aff_fsk','aff_platform','aff_trace_key','aff_short_key','ref_src','ref_url','si','spm','mkt_tok','wtmc','wt_mc','wt_zmc','zmc','xtor'];var del=[];u.searchParams.forEach(function(v,k){var kl=k.toLowerCase();if(kl.indexOf('utm_')===0||rm.indexOf(kl)>-1){if(!keep.has(kl)) del.push(k);}});del.forEach(function(k){u.searchParams.delete(k);});location.replace(u.toString());}catch(e){alert('Kein gültiger Link');}})()";

// Auto per ?u=… (&open=1 navigiert im selben Tab)
(function(){
  const p=new URLSearchParams(location.search);
  const q=p.get('u')||p.get('url'); const ao=p.get('open')||p.get('ao');
  if(q){
    inEl.value=decodeURIComponent(q);
    runClean();
    if(ao==='1'){
      const t=firstOutUrl();
      if(t) location.href=t;
    }
  }
})();

// Hilfe automatisch öffnen: .../app.html?help=1
(function(){
  const p=new URLSearchParams(location.search);
  if(p.get('help')==='1'){ const d=document.getElementById('help'); if(d) d.open=true; }
})();

// Optional Service Worker
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
</script>
</body>
</html>