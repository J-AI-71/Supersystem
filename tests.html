<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <base href="/Supersystem/">
  <title>SafeShare2 · Tests</title>
  <style>
    body{font-family:system-ui;margin:0;background:#0b0b0b;color:#eaeaea}
    .wrap{max-width:980px;margin:auto;padding:20px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #1f1f1f;padding:8px;vertical-align:top}
    th{background:#111}
    .ok{color:#29c07e;font-weight:600}
    .fail{color:#ff7575;font-weight:600}
    .btn{padding:.6rem 1rem;border:0;border-radius:10px;background:#29c07e;color:#07130c;font-weight:600;margin-right:8px}
    .mut{color:#9a9a9a}
    textarea{width:100%;height:120px;background:#111;color:#eaeaea;border:1px solid #2a2a2a;border-radius:10px;padding:.7rem}
  </style>
</head>
<body>
<div class="wrap">
  <h2>SafeShare2 · Tests</h2>
  <p class="mut">Vergleicht Original vs. Clean und prüft Weiterleitung.</p>

  <textarea id="cases"></textarea>
  <div style="margin:8px 0">
    <button id="run" class="btn">Tests ausführen</button>
    <a class="btn" href="index.html">Zurück</a>
  </div>

  <table id="tbl">
    <thead><tr>
      <th>#</th><th>Original</th><th>Clean</th><th>Diff</th><th>Status</th><th>Open</th>
    </tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
// gleiche Clean-Funktion wie in app.html
const TRACKERS=new Set(["utm_source","utm_medium","utm_campaign","utm_term","utm_content","utm_id","gclid","fbclid","msclkid","yclid","mc_cid","mc_eid","_hsenc","_hsmi","vero_id","igshid","si","spm"]);
function cleanUrl(raw){
  try{
    const u=new URL(String(raw).trim());
    if(/\bamazon\.(de|com|co\.uk|it|fr|es)\b/.test(u.hostname)){
      ["tag","ascsubtag","ref","pf_rd_r","pf_rd_p"].forEach(k=>u.searchParams.delete(k));
      if(u.hash) u.hash="";
    }
    for(const k of [...u.searchParams.keys()]){
      if(k.startsWith("utm_")||TRACKERS.has(k)) u.searchParams.delete(k);
    }
    u.pathname=u.pathname.replace(/\/{2,}/g,"/");
    if(u.pathname!=="/"&&u.pathname.endsWith("/")) u.pathname=u.pathname.slice(0,-1);
    return u.toString();
  }catch{return raw;}
}

// Standardfälle
const DEFAULTS = [
 "https://www.amazon.de/abc?tag=aff-21&ref=abc#hash",
 "https://example.com/path/?utm_source=x&utm_medium=y&id=42#sec",
 "https://www.google.com/search?q=test&gclid=ABC123",
 "https://www.instagram.com/p/123/?igshid=MzRlODBiNWFlZA==",
 "https://shop.tld/prod?utm_campaign=fall&utm_id=7&cid=999",
 "https://example.com///a//b///?x=1&utm_term=z",
];
document.getElementById('cases').value = DEFAULTS.join("\n");

function diff(a,b){
  if(a===b) return "";
  try{
    const ua=new URL(a), ub=new URL(b);
    let d=[];
    if(ua.hostname!==ub.hostname) d.push("Host: "+ua.hostname+" → "+ub.hostname);
    if(ua.pathname!==ub.pathname) d.push("Path: "+ua.pathname+" → "+ub.pathname);
    if(ua.search!==ub.search) d.push("Query: "+ua.search+" → "+ub.search);
    if(ua.hash!==ub.hash) d.push("Hash: "+ua.hash+" → "+ub.hash);
    return d.join("\n");
  }catch{return "changed";}
}

document.getElementById('run').onclick=()=>{
  const tbody=document.querySelector('#tbl tbody'); tbody.innerHTML="";
  const lines=document.getElementById('cases').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  lines.forEach((src,i)=>{
    const dst=cleanUrl(src);
    const tr=document.createElement('tr');
    const changed = src!==dst;
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><div style="max-width:280px;word-break:break-all">${src}</div></td>
      <td><div style="max-width:280px;word-break:break-all">${dst}</div></td>
      <td><pre style="white-space:pre-wrap;max-width:260px">${diff(src,dst)}</pre></td>
      <td class="${changed?'ok':'fail'}">${changed?'bereinigt':'keine Änderung'}</td>
      <td><a target="_blank" rel="noopener" href="Redirect-entschachteln.html?u=${encodeURIComponent(src)}">Wrap</a> ·
          <a target="_blank" rel="noopener" href="${dst}">Open</a></td>
    `;
    tbody.appendChild(tr);
  });
};

// SW registrieren
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js?v=2025-11-12');
}
</script>
</body>
</html>