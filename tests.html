<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – Tests</title>
<meta name="description" content="Automatisierte Smoke-Tests für die URL-Reinigung.">
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;margin:16px}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
  th{background:#f8fafc}
  .ok{color:#065f46}
  .fail{color:#991b1b;font-weight:600}
  code{background:#f8fafc;border:1px solid #e5e7eb;padding:2px 6px;border-radius:6px}
  .muted{color:#6b7280;font-size:12px}
</style>
</head>
<body>
<h1>SafeShare – Tests</h1>
<p class="muted">Vergleicht erwartete mit tatsächlicher Ausgabe. SAFE lässt Affiliate-Parameter, STRICT entfernt sie.</p>
<div id="summary" class="muted">–</div>
<table id="t">
  <thead><tr><th>#</th><th>Modus</th><th>Eingabe</th><th>Erwartet</th><th>Ergebnis</th><th>Status</th></tr></thead>
  <tbody></tbody>
</table>

<script>
/* Minimale Kopie zentraler Funktionen aus app.html */
const killBase=new Set(['fbclid','gclid','twclid','msclkid','igshid','vero_id','wickedid','dclid','ref_src','ref_url','si','spm','mkt_tok','wtmc','wt_mc','wt_zmc','zmc','xtor','client','zx','no_sw_cr']);
const AFF={globalNames:new Set(['ref','refid','ref_id','referrer','aff','affid','aff_id','affiliate','affiliate_id','affsource','affsrc','affname','affcamp','affcampaign','campaign','campaignid','campaign_id','clickid','click_id','irclickid','tduid','admitad_uid','sscid','cjevent','clickref','clickref2','subid','sub_id','sid','u1','u2','u3','u4','u5','pid','aid','awinaffid','awinmid']),
byHostRules:[{test:h=>/(^|\.)amazon\./i.test(h),names:new Set(['tag','ascsubtag'])},{test:h=>/(^|\.)ebay\./i.test(h),names:new Set(['campid','customid','mkcid','mkevt','mkrid'])}]};
function deepDecode(s){let a=s||'',b=s||'';for(let i=0;i<6;i++){try{b=decodeURIComponent(a)}catch(_){break}if(b===a)break;a=b}return a;}
function unwrapDeep(u){
  try{ if(/(^|\.)google\./i.test(u.hostname)&&u.pathname.startsWith('/url')){const q=u.searchParams.get('q')||u.searchParams.get('url'); if(q) u=new URL(q);} }catch(_){}
  try{ if(/(^|\.)facebook\./i.test(u.hostname)&&u.pathname.startsWith('/l.php')){const q2=u.searchParams.get('u'); if(q2) u=new URL(q2);} }catch(_){}
  for(let i=0;i<5;i++){
    let found=null;
    for(const [_,v] of u.searchParams){const m=deepDecode(v||'').match(/https?:\/\/[^\s"'<>)]+/i); if(m){found=m[0];break;}}
    if(!found){const m=deepDecode(u.hash||'').match(/https?:\/\/[^\s"'<>)]+/i); if(m)found=m[0];}
    if(!found)break; try{u=new URL(found)}catch(_){break;}
  }
  return u;
}
function applyAmpCanonical(u){
  try{ let path=u.pathname.replace(/\/amp\/?$/,'/').replace(/\/amp$/,'/'); const sp=u.searchParams; if(sp.has('amp')) sp.delete('amp'); if((sp.get('output')||'').toLowerCase()==='amp') sp.delete('output'); return new URL(u.origin+path+(sp.size?('?'+sp.toString()):'')); }catch(_){return u;}
}
function buildAffNames(host){ const names=new Set(AFF.globalNames); for(const r of AFF.byHostRules) if(r.test(host)) for(const n of r.names) names.add(n); return names; }
function sortAndDedupe(out){
  const sorted=new URL(out.origin+out.pathname);
  [...new Set([...out.searchParams].map(([k,v])=>k+'\u0000'+v))].map(s=>s.split('\u0000')).sort((a,b)=>a[0].localeCompare(b[0])).forEach(([k,v])=>sorted.searchParams.append(k,v));
  out.search=sorted.search;
}
function sanitizeHash(u,affNames,keepOn){
  if(!u.hash)return''; const s=u.hash.replace(/^#/,''); if(!s.includes('='))return'';
  const hp=new URLSearchParams(s);
  for(const [k,v] of [...hp]){
    const kl=k.toLowerCase();
    const isAff=affNames.has(kl);
    const isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if(isAff && !keepOn) hp.delete(k);
    else if(isTrack && !isAff) hp.delete(k);
  }
  const nh=hp.toString(); return nh?('#'+nh):'';
}
function clean(s, keepAff=true){
  s=(s||'').trim(); let u0; try{u0=new URL(s);}catch(_){try{u0=new URL('https://'+s);}catch(__){return s;}}
  let u=unwrapDeep(u0); u=applyAmpCanonical(u);
  try{u.protocol=(u.protocol||'https:').toLowerCase(); u.hostname=u.hostname.toLowerCase();}catch(_){}
  const host=u.hostname.toLowerCase(), affNames=buildAffNames(host);
  const out=new URL(u.origin+u.pathname);
  for(const [k,v] of u.searchParams){
    const kl=k.toLowerCase(), isAff=affNames.has(kl), isTrack=kl.startsWith('utm_')||killBase.has(kl);
    if(isAff){ if(keepAff) out.searchParams.append(k,v); continue; }
    if(isTrack){ continue; }
    out.searchParams.append(k,v);
  }
  out.hash=sanitizeHash(u,affNames,keepAff);
  sortAndDedupe(out);
  return out.toString();
}

/* Testfälle */
const cases=[
  {mode:'SAFE', in:'https://www.amazon.de/dp/TEST?tag=deintag-21&utm_source=x', out:'https://www.amazon.de/dp/TEST?tag=deintag-21'},
  {mode:'STRICT', in:'https://www.amazon.de/dp/TEST?tag=deintag-21&utm_medium=email', out:'https://www.amazon.de/dp/TEST'},
  {mode:'SAFE', in:'https://l.facebook.com/l.php?u=https%3A%2F%2Fnews.site%2Fa%3Futm_campaign%3Dx%26fbclid%3Dabc', out:'https://news.site/a'},
  {mode:'SAFE', in:'https://www.google.com/url?q=https%3A%2F%2Fshop.de%2Fa%3Futm_source%3Dtwitter%26gclid%3D123', out:'https://shop.de/a'},
  {mode:'SAFE', in:'https://redir.site/go?url=https%253A%252F%252Fshop.de%252Fa%253Futm_campaign%253Dx%2526fbclid%253Dabc', out:'https://shop.de/a'},
  {mode:'STRICT', in:'https://example.tld/a#utm_source=mail&aff=xyz', out:'https://example.tld/a'},
  {mode:'SAFE', in:'https://example.tld/a#utm_source=mail&aff=xyz', out:'https://example.tld/a#aff=xyz'}
];

function run(){
  const tb=document.querySelector('#t tbody'); tb.innerHTML='';
  let pass=0;
  cases.forEach((c,i)=>{
    const keep = c.mode==='SAFE';
    const got = clean(c.in, keep);
    const ok  = got===c.out;
    if(ok) pass++;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${c.mode}</td><td><code>${c.in}</code></td><td><code>${c.out}</code></td><td><code>${got}</code></td><td class="${ok?'ok':'fail'}">${ok?'OK':'FAIL'}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('summary').textContent = `Erfolg: ${pass}/${cases.length}`;
}
run();
</script>
</body>
</html>