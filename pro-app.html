<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SafeShare Pro – Bulk-Cleaning & eigene Regeln</title>
  <meta name="description" content="SafeShare Pro bereinigt mehrere Links auf einmal und erlaubt eigene Regeln (Whitelist/Blacklist) – lokal im Browser, ohne Konto." />
  <meta name="robots" content="index,follow" />
  <meta name="color-scheme" content="dark light" />

  <!-- Google Search Console -->
  <meta name="google-site-verification" content="3-mi6zLHRdFC14-RdTIF6GY90jKWfyLNLsFBhGLqQB0" />
  <!-- Bing Webmaster Tools -->
  <meta name="msvalidate.01" content="B18ACE18875F9614DAA5CF69EED40ACE" />

  <style>
    :root{
      --bg0:#070a12;
      --bg1:#070b14;
      --bg2:#0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.60);
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 18px;
      --mint: #2fe3b7;
      --mint2: rgba(47,227,183,.18);
      --mint3: rgba(47,227,183,.28);
      --warn: rgba(255,197,84,.16);
      --bad: rgba(255,95,95,.16);
      --focus: 0 0 0 3px rgba(47,227,183,.22);
      --max: 1060px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg0:#f6f7fb;
        --bg1:#ffffff;
        --bg2:#f2f6ff;
        --card:#ffffff;
        --card2:#f5f7ff;
        --border: rgba(17,24,39,.12);
        --text: rgba(17,24,39,.95);
        --muted: rgba(17,24,39,.72);
        --muted2: rgba(17,24,39,.62);
        --shadow: 0 18px 45px rgba(17,24,39,.10);
        --warn: rgba(255,197,84,.22);
        --bad: rgba(255,95,95,.18);
        --focus: 0 0 0 3px rgba(17,130,98,.22);
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(47,227,183,.18), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(255,197,84,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, var(--bg2));
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:var(--max); margin:0 auto; padding: 12px 16px 44px; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 10px 2px 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .logoWrap{
      width: 38px; height: 38px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(47,227,183,.22), rgba(255,197,84,.10));
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      overflow:hidden;
    }
    .logoWrap img{ width: 28px; height: 28px; display:block; }
    .logoFallback{ font-weight: 800; color: var(--mint); font-size: 14px; line-height: 1; }
    .brandText{ min-width:0; }
    .brandText .title{
      font-size: 16px;
      font-weight: 780;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .sub{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tabsBar{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 8px 0 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,0));
    }
    .tabs{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow-x:auto;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{
      font-size: 13px;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .tab:hover{ border-color: var(--border); background: rgba(255,255,255,.04); color: var(--text); }
    .tab.active{
      color: var(--text);
      border-color: rgba(47,227,183,.35);
      background: rgba(47,227,183,.12);
    }

    .card{
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{
      width: 10px; height:10px;
      border-radius: 999px;
      background: rgba(47,227,183,.85);
      box-shadow: 0 0 0 4px rgba(47,227,183,.12);
    }

    h1{
      margin: 10px 0 8px;
      font-size: clamp(22px, 3.8vw, 34px);
      line-height: 1.15;
      letter-spacing: -0.2px;
    }
    h2{ margin: 0 0 8px; font-size: 20px; letter-spacing: -0.1px; }
    p{ margin: 0 0 12px; color: var(--muted); line-height: 1.55; }

    .cols{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 8px;
    }
    @media(min-width: 920px){
      .cols{ grid-template-columns: 1fr 1fr; }
    }

    label{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 8px;
    }
    .labelHint{ color: var(--muted2); font-weight: 500; }

    textarea, input[type="text"]{
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--card2);
      color: var(--text);
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
    }
    textarea:focus, input[type="text"]:focus{
      box-shadow: var(--focus);
      border-color: rgba(47,227,183,.35);
    }
    .big{
      min-height: 140px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      line-height: 1.35;
    }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; margin-top: 12px; }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{
      background: var(--mint2);
      border-color: rgba(47,227,183,.35);
    }
    .btn.primary:hover{ background: var(--mint3); }
    .btn.ghost{ background: transparent; color: var(--muted); }
    .btn.ghost:hover{ color: var(--text); background: rgba(255,255,255,.04); }

    .status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }
    .status.ok{ color: rgba(47,227,183,.95); }
    .status.bad{ color: rgba(255,95,95,.95); }

    .hintBox{
      margin-top: 12px;
      border-left: 3px solid rgba(255,197,84,.55);
      background: var(--warn);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
    }

    details{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    details > summary{
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      color: var(--text);
      list-style: none;
    }
    details > summary::-webkit-details-marker{ display:none; }

    .small{ font-size: 12px; color: var(--muted2); line-height: 1.45; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sep{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    .kv{ display:grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; }
    .kv .line{ color: var(--muted); line-height: 1.5; }
    .kv .line strong{ color: var(--text); font-weight: 700; }
    .scrollKeys{
      display:block;
      max-height: 180px;
      overflow:auto;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      line-height: 1.5;
      word-break: break-word;
    }

    footer{
      margin-top: 18px;
      padding: 18px 4px 10px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.55;
    }
    .footGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 14px;
    }
    @media(min-width: 920px){
      .footGrid{ grid-template-columns: 1.2fr .8fr; }
    }
    .footLinks{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-start;
    }
    .footLinks a{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .footLinks a:hover{ color: var(--text); background: rgba(255,255,255,.06); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logoWrap" aria-label="SafeShare Logo">
          <!-- Lege logo.svg in denselben Ordner wie pro-app.html -->
          <img src="logo.svg" alt="SafeShare" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';">
          <span id="logoFallback" class="logoFallback" style="display:none;">8</span>
        </div>
        <div class="brandText">
          <div class="title">SafeShare</div>
          <div class="sub">Pro App · Bulk-Cleaning & Regeln</div>
        </div>
      </div>
      <div class="small">Alles lokal · keine Accounts</div>
    </header>

    <div class="tabsBar">
      <div class="tabs" role="navigation" aria-label="SafeShare Navigation">
        <a class="tab" href="app.html">App</a>
        <a class="tab active" href="pro-app.html">Pro</a>
        <a class="tab" href="utm-parameter-entfernen.html">UTM</a>
        <a class="tab" href="tracking-parameter.html">Tracking</a>
        <a class="tab" href="url-cleaner-tool-vergleich.html">Tool-Vergleich</a>
        <a class="tab" href="hilfe.html">Hilfe</a>
        <a class="tab" href="bookmarklets.html">Bookmarklets</a>
      </div>
    </div>

    <section class="card">
      <div class="badge"><span class="dot" aria-hidden="true"></span> SafeShare Pro App · praxisgerecht</div>

      <h1>Mehrere Links bereinigen (egal wie eingefügt)</h1>
      <p>
        Du kannst Links als Liste, Textblock, Nummerierung oder aus Mails einfügen – SafeShare Pro extrahiert alle URLs.
        Danach siehst du vollständig, was entfernt oder behalten wurde (Standard/Blacklist/Affiliate/Whitelist).
      </p>

      <div class="cols">
        <div>
          <label for="inputList">
            <span>Eingabe</span>
            <span class="labelHint">Text oder Links einfügen</span>
          </label>
          <textarea id="inputList" class="big" placeholder="1) https://example.com/?utm_source=newsletter&fbclid=EXAMPLE&#10;2) https://www.amazon.de/dp/B000000000?tag=dein-tag-21&ref=abc&utm_source=newsletter" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>

          <div class="row">
            <button class="btn" id="pasteBtn" type="button">Aus Zwischenablage</button>
            <button class="btn primary" id="cleanBtn" type="button">Bereinigen</button>
            <button class="btn" id="clearInputBtn" type="button">Eingabe leeren</button>
            <button class="btn ghost" id="clearOutputBtn" type="button">Ergebnis leeren</button>
          </div>

          <div class="status" id="statusMsg"></div>

          <div class="sep"></div>

          <label>
            <span>Modus</span>
            <span class="labelHint">2 Klicks – fertig</span>
          </label>

          <div class="row" style="margin-top:6px;">
            <button class="btn" id="modePrivateBtn" type="button">Privat</button>
            <button class="btn" id="modePublisherBtn" type="button">Publisher</button>
          </div>

          <div class="small" id="modeHelp" style="margin-top:8px;"></div>

          <details style="margin-top:10px;">
            <summary>Erweitert</summary>
            <div class="small" style="margin-top:10px;">
              <label style="margin:0; display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px;">
                <input type="checkbox" id="removeAffiliate" checked />
                Affiliate entfernen (tag/ref/aff_…)
              </label>
              <div class="small" style="margin-top:8px;">
                Whitelist hat immer Vorrang. Groß/Klein ist egal.
              </div>
            </div>
          </details>
        </div>

        <div>
          <label for="outputList">
            <span>Ausgabe – bereinigte Links</span>
            <span class="labelHint">je Zeile ein Link</span>
          </label>
          <textarea id="outputList" class="big" placeholder="Die bereinigte Liste erscheint hier." readonly></textarea>

          <div class="row">
            <button class="btn primary" id="copyBtn" type="button">Liste kopieren</button>
            <button class="btn" id="openFirstBtn" type="button">Ersten Link öffnen</button>
          </div>

          <div class="small" id="statsLine"></div>

          <details id="receiptDetails" hidden>
            <summary>Was wurde geändert? (vollständig)</summary>
            <div class="kv">
              <div class="line"><strong>Entfernt (Standard):</strong></div>
              <div class="scrollKeys mono" id="removedStd">—</div>

              <div class="line"><strong>Entfernt (Blacklist):</strong></div>
              <div class="scrollKeys mono" id="removedBlacklist">—</div>

              <div class="line"><strong>Entfernt (Affiliate-Regel):</strong></div>
              <div class="scrollKeys mono" id="removedAffiliateBox">—</div>

              <div class="line"><strong>Behalten (Whitelist):</strong></div>
              <div class="scrollKeys mono" id="keptWhitelist">—</div>

              <div class="line"><strong>Behalten (sonst):</strong></div>
              <div class="scrollKeys mono" id="keptOther">—</div>

              <div class="small" style="margin-top:6px;">
                Keys sind dedupliziert (nur Parameternamen, ohne Werte).
              </div>
            </div>
          </details>

          <div class="hintBox">
            Wenn ein Link „kaputt“ wird: benötigten Parameter whitelisten (z. B. <span class="mono">token</span>, <span class="mono">sig</span>, <span class="mono">state</span>).
            Publisher unterstützen: Modus „Publisher“ (Affiliate bleibt).
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Eigene Regeln (Whitelist/Blacklist)</h2>
      <p>
        Standard entfernt UTM/Click-IDs/Newsletter-IDs usw. – zusätzlich kannst du eigene Regeln setzen.
        Eintrag je Zeile, nur Parameternamen (ohne „?“/„=“). Regeln werden lokal gespeichert.
      </p>

      <div class="cols">
        <div>
          <label for="blacklist">
            <span>Blacklist</span>
            <span class="labelHint">immer entfernen (zusätzlich)</span>
          </label>
          <textarea id="blacklist" class="big" placeholder="z. B.&#10;ref_src&#10;source&#10;spm"></textarea>
        </div>

        <div>
          <label for="whitelist">
            <span>Whitelist</span>
            <span class="labelHint">immer behalten (Vorrang)</span>
          </label>
          <textarea id="whitelist" class="big" placeholder="z. B.&#10;tag&#10;ref&#10;t&#10;token"></textarea>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="saveRulesBtn" type="button">Regeln speichern</button>
        <button class="btn" id="resetRulesBtn" type="button">Regeln zurücksetzen</button>
        <button class="btn ghost" id="exportRulesBtn" type="button">Regeln exportieren</button>
        <button class="btn ghost" id="importRulesBtn" type="button">Regeln importieren</button>
      </div>

      <div class="status" id="rulesMsg"></div>

      <details style="margin-top:10px;">
        <summary>Test-Beispiele (copy/paste)</summary>
        <div class="small" style="margin-top:10px;">
          <div class="mono scrollKeys" style="max-height:260px;">
https://example.com/artikel?utm_source=newsletter&utm_medium=email&utm_campaign=dezember&fbclid=EXAMPLE
https://shop.example.com/p/123?gclid=EXAMPLE&utm_source=google&utm_medium=cpc&utm_campaign=brand
https://www.amazon.de/dp/B000000000?tag=dein-tag-21&ref=abc&utm_source=newsletter
https://www.youtube.com/watch?v=dQw4w9WgXcQ&t=43s&utm_source=twitter&fbclid=EXAMPLE
https://app.example.io/open?token=SIGNED_TOKEN_123&state=abc123&utm_source=newsletter
          </div>
        </div>
      </details>
    </section>

    <footer>
      <div class="footGrid">
        <div>
          <div><strong>SafeShare Pro</strong> – Link-Hygiene, lokal im Browser.</div>
          <div>Keine Accounts. Keine Server-Logs. Regeln bleiben auf deinem Gerät (localStorage).</div>
        </div>
        <div class="footLinks">
          <a href="app.html">App</a>
          <a href="pro-app.html">Pro</a>
          <a href="hilfe.html">Hilfe</a>
          <a href="bookmarklets.html">Bookmarklets</a>
          <a href="datenschutz.html">Datenschutz</a>
          <a href="impressum.html">Impressum</a>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const ui = {
      input: $("inputList"),
      output: $("outputList"),
      paste: $("pasteBtn"),
      clean: $("cleanBtn"),
      clearInput: $("clearInputBtn"),
      clearOutput: $("clearOutputBtn"),
      copy: $("copyBtn"),
      openFirst: $("openFirstBtn"),
      status: $("statusMsg"),
      stats: $("statsLine"),

      modePrivateBtn: $("modePrivateBtn"),
      modePublisherBtn: $("modePublisherBtn"),
      modeHelp: $("modeHelp"),

      removeAffiliate: $("removeAffiliate"),

      receiptDetails: $("receiptDetails"),
      removedStd: $("removedStd"),
      removedBlacklist: $("removedBlacklist"),
      removedAffiliateBox: $("removedAffiliateBox"),
      keptWhitelist: $("keptWhitelist"),
      keptOther: $("keptOther"),

      blacklist: $("blacklist"),
      whitelist: $("whitelist"),
      saveRules: $("saveRulesBtn"),
      resetRules: $("resetRulesBtn"),
      exportRules: $("exportRulesBtn"),
      importRules: $("importRulesBtn"),
      rulesMsg: $("rulesMsg"),
    };

    const LS_BLACK = "ss_pro_blacklist_v4";
    const LS_WHITE = "ss_pro_whitelist_v4";
    const LS_MODE  = "ss_pro_mode_v1"; // private|publisher
    const LS_AFF   = "ss_pro_remove_affiliate_v2";

    // Standard Tracking Rules (conservative)
    const STD_REMOVE_EXACT = new Set([
      "gclid","dclid","gbraid","wbraid","msclkid","fbclid","ttclid","twclid","igshid","yclid",
      "mc_cid","mc_eid","mkt_tok","oly_anon_id","oly_enc_id","vero_id","vero_conv",
      "gclsrc","ref_src","ref_url","fb_action_ids","fb_action_types"
    ]);
    const STD_REMOVE_REGEX = [
      /^utm_/i,
      /(^|_)(clickid|clkid)$/i,
      /^(ad|ads|adid|ad_id|adgroup|adgroupid|campaign|campaignid|cmp|cmpid|creative|keyword|matchtype|device)$/i,
      /^(abtest|variant|experiment|bucket)$/i,
      /^(scm|spm|srsltid)$/i
    ];

    function setMsg(el, text, kind=""){
      el.textContent = text || "";
      el.className = "status" + (kind ? " " + kind : "");
    }

    // Extract ALL URLs from any text block (lists, bullets, paragraphs)
    function extractUrlsFromText(text){
      const t = String(text || "");

      const httpMatches = t.match(/https?:\/\/[^\s<>"')]+/gi) || [];

      let domainMatches = [];
      if (httpMatches.length === 0){
        domainMatches = t.match(/\b[a-z0-9.-]+\.[a-z]{2,}(?:\/[^\s<>"')]+)?/gi) || [];
        domainMatches = domainMatches.map(x => "https://" + x);
      }

      const cleaned = [...httpMatches, ...domainMatches]
        .map(u => u.replace(/[),.;]+$/g, "").trim())
        .filter(Boolean);

      return Array.from(new Set(cleaned));
    }

    // Case-insensitive rules: store lowercase
    function parseRulesTextarea(text){
      return new Set(
        String(text || "")
          .split(/\r?\n/)
          .map(x => x.trim())
          .filter(x => x && !x.startsWith("#"))
          .map(x => x.replace(/^[?&]/,"").replace(/=.*$/,""))
          .map(x => x.toLowerCase())
      );
    }

    function loadRules(){
      const b = localStorage.getItem(LS_BLACK) || "";
      const w = localStorage.getItem(LS_WHITE) || "";
      ui.blacklist.value = b;
      ui.whitelist.value = w;
      return { blacklist: parseRulesTextarea(b), whitelist: parseRulesTextarea(w) };
    }

    function saveRules(){
      localStorage.setItem(LS_BLACK, ui.blacklist.value || "");
      localStorage.setItem(LS_WHITE, ui.whitelist.value || "");
      setMsg(ui.rulesMsg, "Regeln gespeichert.", "ok");
    }

    function resetRules(){
      localStorage.removeItem(LS_BLACK);
      localStorage.removeItem(LS_WHITE);
      ui.blacklist.value = "";
      ui.whitelist.value = "";
      setMsg(ui.rulesMsg, "Regeln zurückgesetzt.", "ok");
    }

    function exportRules(){
      const obj = {
        mode: localStorage.getItem(LS_MODE) || "private",
        removeAffiliate: !!ui.removeAffiliate.checked,
        blacklist: ui.blacklist.value || "",
        whitelist: ui.whitelist.value || ""
      };
      const text = JSON.stringify(obj, null, 2);
      // dialog fallback
      prompt("Regeln (JSON) – kopieren:", text);
      navigator.clipboard?.writeText(text).then(
        () => setMsg(ui.rulesMsg, "Regeln exportiert (in Zwischenablage).", "ok"),
        () => setMsg(ui.rulesMsg, "Export: bitte aus dem Dialog kopieren.", "bad")
      );
    }

    function importRules(){
      const raw = prompt("Regeln (JSON) einfügen:");
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        if (obj.mode) setMode(obj.mode);
        if (typeof obj.removeAffiliate === "boolean") ui.removeAffiliate.checked = obj.removeAffiliate;
        if (typeof obj.blacklist === "string") ui.blacklist.value = obj.blacklist;
        if (typeof obj.whitelist === "string") ui.whitelist.value = obj.whitelist;
        localStorage.setItem(LS_AFF, ui.removeAffiliate.checked ? "1" : "0");
        saveRules();
      }catch(e){
        setMsg(ui.rulesMsg, "Ungültiges JSON.", "bad");
      }
    }

    function isStdTrackingParam(keyLower){
      if (STD_REMOVE_EXACT.has(keyLower)) return true;
      for (const rx of STD_REMOVE_REGEX) if (rx.test(keyLower)) return true;
      return false;
    }

    function isAffiliateParam(keyLower){
      return /^(tag|ref|ref_|aff|aff_id|affid|affiliate|partner|partner_id|ascsubtag|clickref|irclickid|utm_referrer)$/i.test(keyLower);
    }

    function cleanOneUrl(rawUrl, rules, removeAffiliate){
      const url = new URL(rawUrl);

      const removedStd = new Set();
      const removedBlack = new Set();
      const removedAff = new Set();
      const keptWhite = new Set();
      const keptOther = new Set();

      const entries = Array.from(url.searchParams.entries());
      url.search = "";

      for (const [k,v] of entries){
        const keyLower = String(k).toLowerCase();

        if (rules.whitelist.has(keyLower)){
          keptWhite.add(keyLower);
          url.searchParams.append(k, v);
          continue;
        }

        if (removeAffiliate && isAffiliateParam(keyLower)){
          removedAff.add(keyLower);
          continue;
        }

        if (rules.blacklist.has(keyLower)){
          removedBlack.add(keyLower);
          continue;
        }

        if (isStdTrackingParam(keyLower)){
          removedStd.add(keyLower);
          continue;
        }

        keptOther.add(keyLower);
        url.searchParams.append(k, v);
      }

      return { cleaned: url.toString(), removedStd, removedBlack, removedAff, keptWhite, keptOther };
    }

    function formatSet(s){
      const arr = Array.from(s);
      arr.sort();
      return arr.length ? arr.join(", ") : "—";
    }

    function setMode(mode){
      const m = (mode === "publisher") ? "publisher" : "private";
      localStorage.setItem(LS_MODE, m);

      // Mode defaults:
      if (m === "private") ui.removeAffiliate.checked = true;
      if (m === "publisher") ui.removeAffiliate.checked = false;

      // UI highlight
      ui.modePrivateBtn.classList.toggle("primary", m === "private");
      ui.modePublisherBtn.classList.toggle("primary", m === "publisher");

      ui.modeHelp.textContent =
        m === "private"
          ? "Privat: entfernt UTM/Click-IDs + Affiliate (Standard)."
          : "Publisher: entfernt UTM/Click-IDs, behält Affiliate-Links (fair).";

      // persist affiliate checkbox state as user-visible setting
      localStorage.setItem(LS_AFF, ui.removeAffiliate.checked ? "1" : "0");
    }

    function loadMode(){
      const m = localStorage.getItem(LS_MODE) || "private";
      const a = localStorage.getItem(LS_AFF);
      if (a === "1" || a === "0") ui.removeAffiliate.checked = (a === "1");
      setMode(m); // also refreshes UI/help text (and sets defaults for checkbox)
      // If user had explicit checkbox saved, restore it after defaults:
      if (a === "1" || a === "0") {
        ui.removeAffiliate.checked = (a === "1");
        localStorage.setItem(LS_AFF, a);
      }
    }

    function cleanList(){
      const rules = loadRules();
      const removeAffiliate = !!ui.removeAffiliate.checked;

      const urls = extractUrlsFromText(ui.input.value);
      const out = [];

      let total = urls.length;
      let ok = 0;
      let removedCount = 0;

      const removedStdAll = new Set();
      const removedBlackAll = new Set();
      const removedAffAll = new Set();
      const keptWhiteAll = new Set();
      const keptOtherAll = new Set();

      for (const raw of urls){
        try{
          const res = cleanOneUrl(raw, rules, removeAffiliate);
          out.push(res.cleaned);
          ok++;

          res.removedStd.forEach(k => removedStdAll.add(k));
          res.removedBlack.forEach(k => removedBlackAll.add(k));
          res.removedAff.forEach(k => removedAffAll.add(k));
          res.keptWhite.forEach(k => keptWhiteAll.add(k));
          res.keptOther.forEach(k => keptOtherAll.add(k));

          removedCount += res.removedStd.size + res.removedBlack.size + res.removedAff.size;
        }catch(e){
          // skip invalid URL silently (already extracted)
        }
      }

      ui.output.value = out.join("\n");

      if (total === 0){
        setMsg(ui.status, "Keine URLs gefunden. Füge Links ein (Text reicht).", "bad");
        ui.stats.textContent = "";
        ui.receiptDetails.hidden = true;
        return;
      }

      setMsg(ui.status, "Bereinigt.", "ok");
      ui.stats.textContent = `${ok}/${total} Links bereinigt · ${removedCount} Parameter entfernt`;

      ui.receiptDetails.hidden = false;
      ui.removedStd.textContent = formatSet(removedStdAll);
      ui.removedBlacklist.textContent = formatSet(removedBlackAll);
      ui.removedAffiliateBox.textContent = formatSet(removedAffAll);
      ui.keptWhitelist.textContent = formatSet(keptWhiteAll);
      ui.keptOther.textContent = formatSet(keptOtherAll);
    }

    async function pasteFromClipboard(){
      try{
        if (navigator.clipboard?.readText){
          const text = await navigator.clipboard.readText();
          if (text){
            ui.input.value = text.trim();
            setMsg(ui.status, "Aus Zwischenablage eingefügt.", "ok");
          } else {
            setMsg(ui.status, "Zwischenablage ist leer.");
          }
        } else {
          setMsg(ui.status, "Zwischenablage nicht verfügbar.", "bad");
        }
      }catch(e){
        setMsg(ui.status, "Zwischenablage-Zugriff nicht erlaubt.", "bad");
      }
    }

    async function copyOutput(){
      const text = String(ui.output.value || "").trim();
      if (!text){
        setMsg(ui.status, "Kein Ergebnis zum Kopieren.", "bad");
        return;
      }
      try{
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
          setMsg(ui.status, "Liste kopiert.", "ok");
          return;
        }
      }catch(e){}
      ui.output.focus();
      ui.output.select();
      try{
        document.execCommand("copy");
        setMsg(ui.status, "Liste kopiert.", "ok");
      }catch(e){
        setMsg(ui.status, "Kopieren nicht verfügbar – bitte manuell markieren.", "bad");
      }
    }

    function openFirst(){
      const first = String(ui.output.value || "").split(/\r?\n/).map(x=>x.trim()).find(Boolean);
      if (!first){
        setMsg(ui.status, "Kein Link zum Öffnen vorhanden.", "bad");
        return;
      }
      window.open(first, "_blank", "noopener");
    }

    function clearInput(){
      ui.input.value = "";
      setMsg(ui.status, "");
    }
    function clearOutput(){
      ui.output.value = "";
      ui.stats.textContent = "";
      ui.receiptDetails.hidden = true;
      setMsg(ui.status, "");
    }

    // autosave rules (local only)
    let saveTimer = null;
    function scheduleAutoSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        localStorage.setItem(LS_BLACK, ui.blacklist.value || "");
        localStorage.setItem(LS_WHITE, ui.whitelist.value || "");
        setMsg(ui.rulesMsg, "Regeln gespeichert (lokal).", "ok");
      }, 450);
    }

    // Events
    ui.paste.addEventListener("click", pasteFromClipboard);
    ui.clean.addEventListener("click", cleanList);
    ui.clearInput.addEventListener("click", clearInput);
    ui.clearOutput.addEventListener("click", clearOutput);
    ui.copy.addEventListener("click", copyOutput);
    ui.openFirst.addEventListener("click", openFirst);

    ui.modePrivateBtn.addEventListener("click", () => setMode("private"));
    ui.modePublisherBtn.addEventListener("click", () => setMode("publisher"));
    ui.removeAffiliate.addEventListener("change", () => {
      localStorage.setItem(LS_AFF, ui.removeAffiliate.checked ? "1" : "0");
    });

    ui.blacklist.addEventListener("input", scheduleAutoSave);
    ui.whitelist.addEventListener("input", scheduleAutoSave);

    ui.saveRules.addEventListener("click", saveRules);
    ui.resetRules.addEventListener("click", resetRules);
    ui.exportRules.addEventListener("click", exportRules);
    ui.importRules.addEventListener("click", importRules);

    // Init
    loadMode();
    loadRules();

    // If coming from app.html with ?url=..., prefill and clean once
    (function initFromQuery(){
      const qs = new URLSearchParams(location.search);
      const u = qs.get("url");
      if (!u) return;
      try{
        const decoded = decodeURIComponent(u);
        ui.input.value = decoded;
        cleanList();
      }catch(e){}
    })();
  </script>
</body>
</html>
