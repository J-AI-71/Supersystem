<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SafeShare Pro – mehrere Links & eigene Regeln</title>
  <meta name="description" content="SafeShare Pro bereinigt mehrere Links auf einmal und erlaubt eigene Regeln (Blacklist/Whitelist). Alles läuft lokal im Browser – ohne Konto." />
  <meta name="robots" content="index,follow" />
  <meta name="color-scheme" content="dark light" />

  <!-- Google Search Console -->
  <meta name="google-site-verification" content="3-mi6zLHRdFC14-RdTIF6GY90jKWfyLNLsFBhGLqQB0" />
  <!-- Bing Webmaster Tools -->
  <meta name="msvalidate.01" content="B18ACE18875F9614DAA5CF69EED40ACE" />

  <style>
    :root{
      --bg0:#070a12;
      --bg1:#070b14;
      --bg2:#0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.60);
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 18px;
      --mint: #2fe3b7;
      --mint2: rgba(47,227,183,.18);
      --mint3: rgba(47,227,183,.28);
      --warn: rgba(255,197,84,.16);
      --bad: rgba(255,95,95,.16);
      --focus: 0 0 0 3px rgba(47,227,183,.22);
      --max: 1060px;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg0:#f6f7fb;
        --bg1:#ffffff;
        --bg2:#f2f6ff;
        --card:#ffffff;
        --card2:#f5f7ff;
        --border: rgba(17,24,39,.12);
        --text: rgba(17,24,39,.95);
        --muted: rgba(17,24,39,.72);
        --muted2: rgba(17,24,39,.62);
        --shadow: 0 18px 45px rgba(17,24,39,.10);
        --warn: rgba(255,197,84,.22);
        --bad: rgba(255,95,95,.18);
        --focus: 0 0 0 3px rgba(17, 130, 98, .22);
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(47,227,183,.18), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(255,197,84,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, var(--bg2));
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:var(--max); margin:0 auto; padding: 12px 16px 44px; }

    /* Header */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 10px 2px 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .logoWrap{
      width: 38px; height: 38px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(47,227,183,.22), rgba(255,197,84,.10));
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      overflow:hidden;
    }
    .logoWrap img{
      width: 28px; height: 28px;
      display:block;
    }
    .logoFallback{
      font-weight: 800;
      color: var(--mint);
      font-size: 14px;
      line-height: 1;
    }
    .brandText{ min-width:0; }
    .brandText .title{
      font-size: 16px;
      font-weight: 780;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .sub{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Tabs bar (wie Screenshot) */
    .tabsBar{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 8px 0 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,0));
    }
    .tabs{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: nowrap;
      padding: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow-x:auto;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{
      font-size: 13px;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .tab:hover{ border-color: var(--border); background: rgba(255,255,255,.04); color: var(--text); }
    .tab.active{
      color: var(--text);
      border-color: rgba(47,227,183,.35);
      background: rgba(47,227,183,.12);
    }

    .card{
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{
      width: 10px; height:10px;
      border-radius: 999px;
      background: rgba(47,227,183,.85);
      box-shadow: 0 0 0 4px rgba(47,227,183,.12);
    }

    h1{
      margin: 10px 0 8px;
      font-size: clamp(22px, 3.8vw, 34px);
      line-height: 1.15;
      letter-spacing: -0.2px;
    }
    h2{
      margin: 0 0 8px;
      font-size: 20px;
      letter-spacing: -0.1px;
    }
    p{ margin: 0 0 12px; color: var(--muted); line-height: 1.55; }

    .cols{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 8px;
    }
    @media(min-width: 920px){
      .cols{ grid-template-columns: 1fr 1fr; }
    }

    label{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 8px;
    }
    .labelHint{ color: var(--muted2); font-weight: 500; }

    textarea, input[type="text"]{
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--card2);
      color: var(--text);
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
    }
    textarea:focus, input[type="text"]:focus{ box-shadow: var(--focus); border-color: rgba(47,227,183,.35); }
    .big{
      min-height: 140px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      line-height: 1.35;
    }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; margin-top: 12px; }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{
      background: var(--mint2);
      border-color: rgba(47,227,183,.35);
    }
    .btn.primary:hover{ background: var(--mint3); }
    .btn.ghost{
      background: transparent;
      color: var(--muted);
    }
    .btn.ghost:hover{ color: var(--text); background: rgba(255,255,255,.04); }

    .status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }
    .status.ok{ color: rgba(47,227,183,.95); }
    .status.bad{ color: rgba(255,95,95,.95); }

    .hintBox{
      margin-top: 12px;
      border-left: 3px solid rgba(255,197,84,.55);
      background: var(--warn);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
    }

    .list{
      margin: 10px 0 0;
      padding-left: 18px;
      color: var(--muted);
      line-height: 1.55;
    }
    .list li{ margin: 6px 0; }

    .small{
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.45;
    }

    .sep{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    details{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    details > summary{
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      color: var(--text);
      list-style: none;
    }
    details > summary::-webkit-details-marker{ display:none; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Footer */
    footer{
      margin-top: 18px;
      padding: 18px 4px 10px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.55;
    }
    .footGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 14px;
    }
    @media(min-width: 920px){
      .footGrid{ grid-template-columns: 1.2fr .8fr; }
    }
    .footLinks{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-start;
    }
    .footLinks a{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .footLinks a:hover{ color: var(--text); background: rgba(255,255,255,.06); }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Header: SafeShare + Logo -->
    <header>
      <div class="brand">
        <div class="logoWrap" aria-label="SafeShare Logo">
          <!-- Wenn du dein Logo als logo.svg neben diese Datei legst, wird es hier angezeigt -->
          <img id="logoImg" src="logo.svg" alt="SafeShare" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';">
          <span id="logoFallback" class="logoFallback" style="display:none;">8</span>
        </div>
        <div class="brandText">
          <div class="title">SafeShare</div>
          <div class="sub">Links teilen. Ohne Ballast.</div>
        </div>
      </div>
      <div class="small">Pro App</div>
    </header>

    <!-- Navi Tabs -->
    <div class="tabsBar">
      <div class="tabs" role="navigation" aria-label="SafeShare Navigation">
        <a class="tab" href="app.html">App</a>
        <a class="tab active" href="pro-app.html">Pro</a>
        <a class="tab" href="utm-parameter-entfernen.html">UTM</a>
        <a class="tab" href="tracking-parameter.html">Tracking</a>
        <a class="tab" href="url-cleaner-tool-vergleich.html">Tool-Vergleich</a>
        <a class="tab" href="hilfe.html">Hilfe</a>
        <a class="tab" href="bookmarklets.html">Bookmarklets</a>
      </div>
    </div>

    <!-- Pro App Main -->
    <section class="card">
      <div class="badge"><span class="dot" aria-hidden="true"></span> SafeShare Pro App · mehrere Links &amp; eigene Regeln</div>

      <h1>Mehrere Links in einem Rutsch bereinigen</h1>
      <p>
        Füge unten eine Liste von Links ein (je Zeile ein Link), lege bei Bedarf eigene Regeln für Parameter fest und kopiere die bereinigte Liste wieder heraus.
        Alles läuft lokal in deinem Browser.
      </p>

      <div class="cols">
        <div>
          <label for="inputList">
            <span>Eingabe – Links (einer pro Zeile)</span>
            <span class="labelHint">z. B. aus Newsletter, Social Media, Dokumenten</span>
          </label>
          <textarea id="inputList" class="big" placeholder="https://example.com/?utm_source=newsletter&#10;https://www.beispiel.de/artikel?fbclid=ABC123&utm_medium=social" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>

          <div class="row">
            <button class="btn primary" id="cleanBtn" type="button">Liste bereinigen</button>
            <button class="btn" id="clearInputBtn" type="button">Eingabe leeren</button>
            <button class="btn ghost" id="clearOutputBtn" type="button">Ergebnis leeren</button>
          </div>

          <div class="status" id="statusMsg"></div>

          <div class="small">
            Hinweis: Unbekannte Parameter bleiben standardmäßig erhalten (stabiler). Mit Whitelist kannst du funktionale Parameter gezielt erlauben.
          </div>
        </div>

        <div>
          <label for="outputList">
            <span>Ausgabe – bereinigte Links</span>
            <span class="labelHint">werden ohne Tracking-Parameter ausgegeben</span>
          </label>
          <textarea id="outputList" class="big" placeholder="Die bereinigte Liste erscheint hier – je Zeile ein Link." readonly></textarea>

          <div class="row">
            <button class="btn primary" id="copyBtn" type="button">Bereinigte Liste kopieren</button>
            <button class="btn" id="openFirstBtn" type="button">Ersten Link öffnen</button>
          </div>

          <div class="small" id="statsLine"></div>

          <details id="receiptDetails" hidden>
            <summary>Was wurde geändert? (Zusammenfassung)</summary>
            <div class="small" style="margin-top:10px;">
              <div><strong>Entfernt (Kategorien):</strong> <span id="removedCats" class="mono"></span></div>
              <div style="margin-top:6px;"><strong>Beispiel entfernte Keys:</strong> <span id="removedKeys" class="mono"></span></div>
              <div style="margin-top:10px;"><strong>Behalten (Whitelist):</strong> <span id="keptWhitelist" class="mono"></span></div>
              <div style="margin-top:6px;"><strong>Entfernt (Blacklist):</strong> <span id="removedBlacklist" class="mono"></span></div>
              <div style="margin-top:10px;">
                Tipp: Wenn du <span class="mono">tag</span>/<span class="mono">ref</span> whitelisten willst, schreibe sie einfach – Groß/Klein ist egal.
              </div>
            </div>
          </details>

          <div class="hintBox">
            Tipp: Nutze <strong>Whitelist</strong>, wenn ein Parameter bleiben muss (z. B. Token).
            Nutze <strong>Blacklist</strong>, wenn du etwas immer entfernen willst – zusätzlich zur Standardliste.
          </div>
        </div>
      </div>
    </section>

    <!-- Rules -->
    <section class="card">
      <h2>Eigene Regeln für Tracking-Parameter</h2>
      <p>
        SafeShare Pro kennt bereits eine Standardliste üblicher Tracking-Parameter (UTM, fbclid, gclid usw.).
        Zusätzlich kannst du eigene Regeln ergänzen:
      </p>
      <ul class="list">
        <li><strong>Blacklist:</strong> wird entfernt (zusätzlich zur Standardliste), außer es steht auf der Whitelist.</li>
        <li><strong>Whitelist:</strong> darf bleiben – hat Vorrang (auch wenn es wie Tracking aussieht).</li>
      </ul>
      <p class="small">
        Eintrag je Zeile, nur Parameternamen ohne „?“ oder „=“ (z. B. <span class="mono">utm_source</span>).
        Regeln werden lokal im Browser (<span class="mono">localStorage</span>) gespeichert – nicht auf einem Server.
      </p>

      <div class="sep"></div>

      <h2 style="margin-top:0;">Regeln bearbeiten</h2>

      <div class="cols">
        <div>
          <label for="blacklist">
            <span>Blacklist</span>
            <span class="labelHint">immer entfernen (zusätzlich zur Standardliste)</span>
          </label>
          <textarea id="blacklist" class="big" placeholder="z. B.&#10;ref_src&#10;source&#10;spm"></textarea>
        </div>

        <div>
          <label for="whitelist">
            <span>Whitelist</span>
            <span class="labelHint">immer behalten (hat Vorrang)</span>
          </label>
          <textarea id="whitelist" class="big" placeholder="z. B.&#10;tag&#10;ref&#10;t&#10;token"></textarea>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="saveRulesBtn" type="button">Regeln speichern</button>
        <button class="btn" id="resetRulesBtn" type="button">Regeln zurücksetzen</button>
      </div>

      <div class="status" id="rulesMsg"></div>
    </section>

    <!-- Footer -->
    <footer>
      <div class="footGrid">
        <div>
          <div><strong>SafeShare Pro</strong> – Link-Hygiene, lokal im Browser.</div>
          <div>Keine Accounts. Keine Server-Logs. Regeln &amp; Verlauf bleiben auf deinem Gerät.</div>
        </div>
        <div class="footLinks">
          <a href="app.html">App</a>
          <a href="pro-app.html">Pro</a>
          <a href="hilfe.html">Hilfe</a>
          <a href="bookmarklets.html">Bookmarklets</a>
          <a href="datenschutz.html">Datenschutz</a>
          <a href="impressum.html">Impressum</a>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const ui = {
      input: $("inputList"),
      output: $("outputList"),
      clean: $("cleanBtn"),
      clearInput: $("clearInputBtn"),
      clearOutput: $("clearOutputBtn"),
      copy: $("copyBtn"),
      openFirst: $("openFirstBtn"),
      status: $("statusMsg"),
      stats: $("statsLine"),

      receiptDetails: $("receiptDetails"),
      removedCats: $("removedCats"),
      removedKeys: $("removedKeys"),
      keptWhitelist: $("keptWhitelist"),
      removedBlacklist: $("removedBlacklist"),

      blacklist: $("blacklist"),
      whitelist: $("whitelist"),
      saveRules: $("saveRulesBtn"),
      resetRules: $("resetRulesBtn"),
      rulesMsg: $("rulesMsg"),
    };

    const LS_BLACK = "ss_pro_blacklist_v2";
    const LS_WHITE = "ss_pro_whitelist_v2";

    // Standardliste: bewusst konservativ (weitere Keys kannst du später ergänzen)
    const STD_REMOVE_EXACT = new Set([
      "gclid","dclid","gbraid","wbraid","msclkid","fbclid","ttclid","twclid","igshid",
      "mc_cid","mc_eid","mkt_tok","oly_anon_id","oly_enc_id","vero_id","vero_conv",
      "gclsrc","ref_src","ref_url"
    ]);

    const STD_REMOVE_REGEX = [
      /^utm_/i,
      /(^|_)(clickid|clkid)$/i,
      /^(ad|ads|adid|ad_id|adgroup|adgroupid|campaign|campaignid|cmp|cmpid|creative|keyword|matchtype|device)$/i,
      /^(abtest|variant|experiment|bucket)$/i
    ];

    function setMsg(el, text, kind=""){
      el.textContent = text || "";
      el.className = "status" + (kind ? " " + kind : "");
    }

    function normalizeUrl(raw){
      let s = String(raw || "").trim();
      if (!s) return "";
      if (!/^https?:\/\//i.test(s) && /^[a-z0-9.-]+\.[a-z]{2,}(\/|$)/i.test(s)) s = "https://" + s;
      return s;
    }

    // Case-insensitive rules: alles lowercase speichern/vergleichen
    function parseRulesTextarea(text){
      return new Set(
        String(text || "")
          .split(/\r?\n/)
          .map(x => x.trim())
          .filter(x => x && !x.startsWith("#"))
          .map(x => x.replace(/^[?&]/,"").replace(/=.*$/,""))
          .map(x => x.toLowerCase())
      );
    }

    function loadRules(){
      const b = localStorage.getItem(LS_BLACK) || "";
      const w = localStorage.getItem(LS_WHITE) || "";
      ui.blacklist.value = b;
      ui.whitelist.value = w;
      return {
        blacklist: parseRulesTextarea(b),
        whitelist: parseRulesTextarea(w),
      };
    }

    function saveRules(){
      localStorage.setItem(LS_BLACK, ui.blacklist.value || "");
      localStorage.setItem(LS_WHITE, ui.whitelist.value || "");
      setMsg(ui.rulesMsg, "Regeln gespeichert.", "ok");
    }

    function resetRules(){
      localStorage.removeItem(LS_BLACK);
      localStorage.removeItem(LS_WHITE);
      ui.blacklist.value = "";
      ui.whitelist.value = "";
      setMsg(ui.rulesMsg, "Regeln zurückgesetzt.", "ok");
    }

    function isStdTrackingParam(keyLower){
      if (STD_REMOVE_EXACT.has(keyLower)) return true;
      for (const rx of STD_REMOVE_REGEX) if (rx.test(keyLower)) return true;
      return false;
    }

    function categorizeKey(keyLower){
      if (/^utm_/i.test(keyLower)) return "UTM";
      if (/(^|_)(gclid|dclid|gbraid|wbraid|msclkid|fbclid|ttclid|twclid|igshid)$/i.test(keyLower)) return "CLICK_ID";
      if (/^(mc_cid|mc_eid|mkt_tok|oly_anon_id|oly_enc_id|vero_id|vero_conv)$/i.test(keyLower)) return "EMAIL";
      if (/^(abtest|variant|experiment|bucket)$/i.test(keyLower)) return "EXPERIMENT";
      if (/^(ref|tag|aff|aff_id|affid|partner|partner_id|ascsubtag|clickref|irclickid)$/i.test(keyLower)) return "AFFILIATE";
      if (/^(source|spm|scm|cmpid|campaignid|ad_id|adgroupid|creative|keyword|matchtype|device|gclsrc|ref_src|ref_url)$/i.test(keyLower)) return "OTHER";
      return "UNKNOWN";
    }

    function cleanOneUrl(rawUrl, rules){
      const url = new URL(rawUrl);
      const removed = [];
      const kept = [];
      const keptByWhitelist = new Set();
      const removedByBlacklist = new Set();

      const entries = Array.from(url.searchParams.entries());
      url.search = "";

      for (const [k,v] of entries){
        const keyLower = String(k).toLowerCase();

        // Whitelist always wins
        if (rules.whitelist.has(keyLower)) {
          kept.push({key: k, category: categorizeKey(keyLower), reason: "whitelist"});
          keptByWhitelist.add(keyLower);
          url.searchParams.append(k, v);
          continue;
        }

        const isBlack = rules.blacklist.has(keyLower);
        const isStd = isStdTrackingParam(keyLower);

        if (isBlack || isStd) {
          removed.push({key: k, category: categorizeKey(keyLower), reason: isBlack ? "blacklist" : "standard"});
          if (isBlack) removedByBlacklist.add(keyLower);
          continue;
        }

        kept.push({key: k, category: categorizeKey(keyLower), reason: "kept"});
        url.searchParams.append(k, v);
      }

      return { cleaned: url.toString(), removed, kept, keptByWhitelist, removedByBlacklist };
    }

    async function copyToClipboard(text){
      try{
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(e){}
      try{
        ui.output.focus();
        ui.output.select();
        document.execCommand("copy");
        return true;
      }catch(e){
        return false;
      }
    }

    function buildReceiptSummary(allRemoved){
      const cats = {};
      const keys = new Set();
      for (const r of allRemoved){
        cats[r.category] = (cats[r.category] || 0) + 1;
        keys.add(String(r.key).toLowerCase());
      }
      const catsSorted = Object.entries(cats)
        .sort((a,b)=>b[1]-a[1])
        .map(([c,n]) => `${c}:${n}`);

      return {
        catsLine: catsSorted.join(" · ") || "—",
        keysLine: Array.from(keys).slice(0, 24).join(", ") + (keys.size > 24 ? " …" : "")
      };
    }

    function cleanList(){
      const rules = loadRules();
      const lines = String(ui.input.value || "").split(/\r?\n/);

      const out = [];
      let total = 0, ok = 0, bad = 0;
      let removedCount = 0;

      const removedAll = [];
      const keptWhitelistAll = new Set();
      const removedBlacklistAll = new Set();

      for (const line of lines){
        const raw = normalizeUrl(line);
        if (!raw) continue;
        total++;

        if (!/^https?:\/\//i.test(raw)){
          bad++;
          continue;
        }

        try{
          const res = cleanOneUrl(raw, rules);
          out.push(res.cleaned);
          ok++;

          removedCount += res.removed.length;
          res.removed.forEach(r => removedAll.push(r));
          res.keptByWhitelist.forEach(k => keptWhitelistAll.add(k));
          res.removedByBlacklist.forEach(k => removedBlacklistAll.add(k));
        }catch(e){
          bad++;
        }
      }

      ui.output.value = out.join("\n");

      if (total === 0){
        setMsg(ui.status, "Bitte Links einfügen (je Zeile ein Link).", "bad");
        ui.stats.textContent = "";
        ui.receiptDetails.hidden = true;
        return;
      }

      if (ok === 0){
        setMsg(ui.status, "Keine gültigen http/https-Links gefunden.", "bad");
        ui.stats.textContent = "";
        ui.receiptDetails.hidden = true;
        return;
      }

      setMsg(ui.status, "Liste bereinigt.", "ok");
      ui.stats.textContent = `${ok}/${total} Links bereinigt · ${removedCount} Parameter entfernt${bad ? ` · ${bad} ungültig` : ""}`;

      // Receipt summary
      const summary = buildReceiptSummary(removedAll);
      ui.receiptDetails.hidden = false;
      ui.removedCats.textContent = summary.catsLine;
      ui.removedKeys.textContent = summary.keysLine || "—";
      ui.keptWhitelist.textContent = keptWhitelistAll.size ? (Array.from(keptWhitelistAll).slice(0, 24).join(", ") + (keptWhitelistAll.size > 24 ? " …" : "")) : "—";
      ui.removedBlacklist.textContent = removedBlacklistAll.size ? (Array.from(removedBlacklistAll).slice(0, 24).join(", ") + (removedBlacklistAll.size > 24 ? " …" : "")) : "—";
    }

    function clearInput(){
      ui.input.value = "";
      setMsg(ui.status, "");
    }
    function clearOutput(){
      ui.output.value = "";
      ui.stats.textContent = "";
      ui.receiptDetails.hidden = true;
      setMsg(ui.status, "");
    }

    async function copyOutput(){
      const text = String(ui.output.value || "").trim();
      if (!text){
        setMsg(ui.status, "Kein Ergebnis zum Kopieren.", "bad");
        return;
      }
      const ok = await copyToClipboard(text);
      setMsg(ui.status, ok ? "Bereinigte Liste kopiert." : "Kopieren nicht verfügbar – bitte manuell markieren.", ok ? "ok" : "bad");
    }

    function openFirst(){
      const first = String(ui.output.value || "").split(/\r?\n/).map(x=>x.trim()).find(Boolean);
      if (!first){
        setMsg(ui.status, "Kein Link zum Öffnen vorhanden.", "bad");
        return;
      }
      window.open(first, "_blank", "noopener");
    }

    ui.clean.addEventListener("click", cleanList);
    ui.clearInput.addEventListener("click", clearInput);
    ui.clearOutput.addEventListener("click", clearOutput);
    ui.copy.addEventListener("click", copyOutput);
    ui.openFirst.addEventListener("click", openFirst);

    ui.saveRules.addEventListener("click", saveRules);
    ui.resetRules.addEventListener("click", resetRules);

    // Autosave (lokal)
    let saveTimer = null;
    function scheduleAutoSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        localStorage.setItem(LS_BLACK, ui.blacklist.value || "");
        localStorage.setItem(LS_WHITE, ui.whitelist.value || "");
        setMsg(ui.rulesMsg, "Regeln gespeichert (lokal).", "ok");
      }, 450);
    }
    ui.blacklist.addEventListener("input", scheduleAutoSave);
    ui.whitelist.addEventListener("input", scheduleAutoSave);

    // init
    loadRules();

    // If coming from app.html with ?url=..., prefill as single line and clean once
    (function initFromQuery(){
      const qs = new URLSearchParams(location.search);
      const u = qs.get("url");
      if (!u) return;
      try{
        const decoded = decodeURIComponent(u);
        ui.input.value = decoded;
        cleanList();
      }catch(e){}
    })();
  </script>
</body>
</html>
