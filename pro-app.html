<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SafeShare Pro – Bulk-Cleaning & eigene Regeln</title>
  <meta name="description" content="SafeShare Pro bereinigt mehrere Links auf einmal und erlaubt eigene Regeln (Whitelist/Blacklist) – lokal im Browser, ohne Konto." />
  <meta name="robots" content="index,follow" />
  <meta name="color-scheme" content="dark light" />

  <!-- Google Search Console -->
  <meta name="google-site-verification" content="3-mi6zLHRdFC14-RdTIF6GY90jKWfyLNLsFBhGLqQB0" />
  <!-- Bing Webmaster Tools -->
  <meta name="msvalidate.01" content="B18ACE18875F9614DAA5CF69EED40ACE" />

  <style>
    :root{
      --bg0:#070a12;
      --bg1:#070b14;
      --bg2:#0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.60);
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 18px;
      --mint: #2fe3b7;
      --mint2: rgba(47,227,183,.18);
      --mint3: rgba(47,227,183,.28);
      --warn: rgba(255,197,84,.16);
      --bad: rgba(255,95,95,.16);
      --focus: 0 0 0 3px rgba(47,227,183,.22);
      --max: 1060px;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg0:#f6f7fb;
        --bg1:#ffffff;
        --bg2:#f2f6ff;
        --card:#ffffff;
        --card2:#f5f7ff;
        --border: rgba(17,24,39,.12);
        --text: rgba(17,24,39,.95);
        --muted: rgba(17,24,39,.72);
        --muted2: rgba(17,24,39,.62);
        --shadow: 0 18px 45px rgba(17,24,39,.10);
        --warn: rgba(255,197,84,.22);
        --bad: rgba(255,95,95,.18);
        --focus: 0 0 0 3px rgba(17,130,98,.22);
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(47,227,183,.18), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(255,197,84,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, var(--bg2));
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:var(--max); margin:0 auto; padding: 12px 16px 44px; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 10px 2px 12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width:0;
    }
    .logoWrap{
      width: 38px; height: 38px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(47,227,183,.22), rgba(255,197,84,.10));
      box-shadow: var(--shadow);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      overflow:hidden;
    }
    .logoWrap img{ width: 28px; height: 28px; display:block; }
    .logoFallback{ font-weight: 800; color: var(--mint); font-size: 14px; line-height: 1; }
    .brandText{ min-width:0; }
    .brandText .title{
      font-size: 16px;
      font-weight: 780;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .sub{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tabsBar{
      position: sticky;
      top: 0;
      z-index: 50;
      padding: 8px 0 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,0));
    }
    .tabs{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow-x:auto;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{
      font-size: 13px;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .tab:hover{ border-color: var(--border); background: rgba(255,255,255,.04); color: var(--text); }
    .tab.active{
      color: var(--text);
      border-color: rgba(47,227,183,.35);
      background: rgba(47,227,183,.12);
    }

    .card{
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{
      width: 10px; height:10px;
      border-radius: 999px;
      background: rgba(47,227,183,.85);
      box-shadow: 0 0 0 4px rgba(47,227,183,.12);
    }

    h1{
      margin: 10px 0 8px;
      font-size: clamp(22px, 3.8vw, 34px);
      line-height: 1.15;
      letter-spacing: -0.2px;
    }
    h2{ margin: 0 0 8px; font-size: 20px; letter-spacing: -0.1px; }
    p{ margin: 0 0 12px; color: var(--muted); line-height: 1.55; }

    .cols{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 8px;
    }
    @media(min-width: 920px){
      .cols{ grid-template-columns: 1fr 1fr; }
    }

    label{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 8px;
    }
    .labelHint{ color: var(--muted2); font-weight: 500; }

    textarea, input[type="text"], select{
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--card2);
      color: var(--text);
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
    }
    textarea:focus, input[type="text"]:focus, select:focus{
      box-shadow: var(--focus);
      border-color: rgba(47,227,183,.35);
    }
    .big{
      min-height: 140px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      line-height: 1.35;
    }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; margin-top: 12px; }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{
      background: var(--mint2);
      border-color: rgba(47,227,183,.35);
    }
    .btn.primary:hover{ background: var(--mint3); }
    .btn.ghost{ background: transparent; color: var(--muted); }
    .btn.ghost:hover{ color: var(--text); background: rgba(255,255,255,.04); }

    .status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }
    .status.ok{ color: rgba(47,227,183,.95); }
    .status.bad{ color: rgba(255,95,95,.95); }

    .hintBox{
      margin-top: 12px;
      border-left: 3px solid rgba(255,197,84,.55);
      background: var(--warn);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
    }

    details{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    details > summary{
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
      color: var(--text);
      list-style: none;
    }
    details > summary::-webkit-details-marker{ display:none; }

    .small{ font-size: 12px; color: var(--muted2); line-height: 1.45; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sep{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }

    .kv{
      display:grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 8px;
    }
    .kv .line{ color: var(--muted); line-height: 1.5; }
    .kv .line strong{ color: var(--text); font-weight: 700; }
    .scrollKeys{
      display:block;
      max-height: 180px;
      overflow:auto;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      line-height: 1.5;
      word-break: break-word;
    }

    footer{
      margin-top: 18px;
      padding: 18px 4px 10px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.55;
    }
    .footGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 14px;
    }
    @media(min-width: 920px){
      .footGrid{ grid-template-columns: 1.2fr .8fr; }
    }
    .footLinks{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-start;
    }
    .footLinks a{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .footLinks a:hover{ color: var(--text); background: rgba(255,255,255,.06); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logoWrap" aria-label="SafeShare Logo">
          <!-- Lege logo.svg in denselben Ordner wie pro-app.html -->
          <img src="logo.svg" alt="SafeShare" onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';">
          <span id="logoFallback" class="logoFallback" style="display:none;">8</span>
        </div>
        <div class="brandText">
          <div class="title">SafeShare</div>
          <div class="sub">Pro App · Bulk-Cleaning & Regeln</div>
        </div>
      </div>
      <div class="small">Alles lokal · keine Accounts</div>
    </header>

    <div class="tabsBar">
      <div class="tabs" role="navigation" aria-label="SafeShare Navigation">
        <a class="tab" href="app.html">App</a>
        <a class="tab active" href="pro-app.html">Pro</a>
        <a class="tab" href="utm-parameter-entfernen.html">UTM</a>
        <a class="tab" href="tracking-parameter.html">Tracking</a>
        <a class="tab" href="url-cleaner-tool-vergleich.html">Tool-Vergleich</a>
        <a class="tab" href="hilfe.html">Hilfe</a>
        <a class="tab" href="bookmarklets.html">Bookmarklets</a>
      </div>
    </div>

    <section class="card">
      <div class="badge"><span class="dot" aria-hidden="true"></span> SafeShare Pro App · praxisgerecht zum Experimentieren</div>

      <h1>Mehrere Links in einem Rutsch bereinigen</h1>
      <p>
        Füge Links ein (1 pro Zeile), wähle einen Modus, passe Regeln an und kopiere das Ergebnis.
        „Was wurde geändert?“ listet nachvollziehbar auf, was entfernt/behalten wurde – inkl. Whitelist/Affiliate.
      </p>

      <div class="cols">
        <div>
          <label for="inputList">
            <span>Eingabe – Links (1 pro Zeile)</span>
            <span class="labelHint">z. B. aus Newsletter, Social, Dokumenten</span>
          </label>
          <textarea id="inputList" class="big" placeholder="https://example.com/?utm_source=newsletter&#10;https://www.beispiel.de/artikel?fbclid=ABC123&utm_medium=social" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>

          <div class="row">
            <button class="btn" id="pasteBtn" type="button">Aus Zwischenablage</button>
            <button class="btn primary" id="cleanBtn" type="button">Liste bereinigen</button>
            <button class="btn" id="clearInputBtn" type="button">Eingabe leeren</button>
            <button class="btn ghost" id="clearOutputBtn" type="button">Ergebnis leeren</button>
          </div>

          <div class="status" id="statusMsg"></div>

          <div class="sep"></div>

          <label for="preset">
            <span>Modus (Preset)</span>
            <span class="labelHint">ändert Standardverhalten für Affiliate</span>
          </label>
          <select id="preset">
            <option value="private">Privat (empfohlen) – Affiliate entfernen</option>
            <option value="publisher">Publisher unterstützen – Affiliate behalten</option>
            <option value="team">Team (Policy) – frei konfigurierbar</option>
          </select>

          <div class="row" style="margin-top:10px;">
            <label style="margin:0; width:auto; display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px;">
              <input type="checkbox" id="removeAffiliate" checked />
              Affiliate entfernen (tag/ref/aff_…)
            </label>
          </div>

          <div class="small" style="margin-top:8px;">
            Hinweis: Whitelist hat immer Vorrang. Groß/Klein ist egal (Parameter werden case-insensitiv verglichen).
          </div>
        </div>

        <div>
          <label for="outputList">
            <span>Ausgabe – bereinigte Links</span>
            <span class="labelHint">je Zeile ein bereinigter Link</span>
          </label>
          <textarea id="outputList" class="big" placeholder="Die bereinigte Liste erscheint hier." readonly></textarea>

          <div class="row">
            <button class="btn primary" id="copyBtn" type="button">Liste kopieren</button>
            <button class="btn" id="openFirstBtn" type="button">Ersten Link öffnen</button>
          </div>

          <div class="small" id="statsLine"></div>

          <details id="receiptDetails" hidden>
            <summary>Was wurde geändert? (vollständig)</summary>
            <div class="kv">
              <div class="line"><strong>Entfernt (Standard):</strong></div>
              <div class="scrollKeys mono" id="removedStd">—</div>

              <div class="line"><strong>Entfernt (Blacklist):</strong></div>
              <div class="scrollKeys mono" id="removedBlacklist">—</div>

              <div class="line"><strong>Entfernt (Affiliate-Regel):</strong></div>
              <div class="scrollKeys mono" id="removedAffiliate">—</div>

              <div class="line"><strong>Behalten (Whitelist):</strong></div>
              <div class="scrollKeys mono" id="keptWhitelist">—</div>

              <div class="line"><strong>Behalten (sonst):</strong></div>
              <div class="scrollKeys mono" id="keptOther">—</div>

              <div class="small" style="margin-top:6px;">
                Keys sind dedupliziert (nur Parameternamen, ohne Werte). Bei vielen Links wird die Liste lang – deshalb mit Scrollbereich.
              </div>
            </div>
          </details>

          <div class="hintBox">
            Praxis: Wenn ein Link „kaputt“ wird, whiteliste den benötigten Parameter (z. B. <span class="mono">token</span>, <span class="mono">sig</span>, <span class="mono">state</span>).
            Wenn du Publisher fair unterstützen willst: Modus „Publisher“ oder Affiliate-Regel aus.
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Eigene Regeln (Whitelist/Blacklist)</h2>
      <p>
        SafeShare Pro entfernt standardmäßig typische Tracking-Parameter (UTM, Click-IDs, Newsletter-IDs usw.).
        Zusätzlich kannst du Regeln setzen:
      </p>

      <div class="cols">
        <div>
          <label for="blacklist">
            <span>Blacklist</span>
            <span class="labelHint">immer entfernen (zusätzlich)</span>
          </label>
          <textarea id="blacklist" class="big" placeholder="z. B.&#10;ref_src&#10;source&#10;spm"></textarea>
        </div>

        <div>
          <label for="whitelist">
            <span>Whitelist</span>
            <span class="labelHint">immer behalten (hat Vorrang)</span>
          </label>
          <textarea id="whitelist" class="big" placeholder="z. B.&#10;tag&#10;ref&#10;t&#10;token"></textarea>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="saveRulesBtn" type="button">Regeln speichern</button>
        <button class="btn" id="resetRulesBtn" type="button">Regeln zurücksetzen</button>
        <button class="btn ghost" id="exportRulesBtn" type="button">Regeln exportieren</button>
        <button class="btn ghost" id="importRulesBtn" type="button">Regeln importieren</button>
      </div>

      <div class="status" id="rulesMsg"></div>

      <details style="margin-top:10px;">
        <summary>Beispiele zum Testen (copy/paste)</summary>
        <div class="small" style="margin-top:10px;">
          <div class="mono scrollKeys" id="examplesBox" style="max-height:260px;">
https://example.com/artikel?utm_source=newsletter&utm_medium=email&utm_campaign=dezember&fbclid=EXAMPLE
https://shop.example.com/p/123?gclid=EXAMPLE&utm_source=google&utm_medium=cpc&utm_campaign=brand
https://www.amazon.de/dp/B000000000?tag=dein-tag-21&ref=abc&utm_source=newsletter
https://www.youtube.com/watch?v=dQw4w9WgXcQ&t=43s&utm_source=twitter&fbclid=EXAMPLE
https://app.example.io/open?token=SIGNED_TOKEN_123&state=abc123&utm_source=newsletter
          </div>
        </div>
      </details>
    </section>

    <footer>
      <div class="footGrid">
        <div>
          <div><strong>SafeShare Pro</strong> – Link-Hygiene, lokal im Browser.</div>
          <div>Keine Accounts. Keine Server-Logs. Regeln bleiben auf deinem Gerät (localStorage).</div>
        </div>
        <div class="footLinks">
          <a href="app.html">App</a>
          <a href="pro-app.html">Pro</a>
          <a href="hilfe.html">Hilfe</a>
          <a href="bookmarklets.html">Bookmarklets</a>
          <a href="datenschutz.html">Datenschutz</a>
          <a href="impressum.html">Impressum</a>
        </div>
      </div>
    </footer>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const ui = {
      input: $("inputList"),
      output: $("outputList"),
      paste: $("pasteBtn"),
      clean: $("cleanBtn"),
      clearInput: $("clearInputBtn"),
      clearOutput: $("clearOutputBtn"),
      copy: $("copyBtn"),
      openFirst: $("openFirstBtn"),
      status: $("statusMsg"),
      stats: $("statsLine"),

      preset: $("preset"),
      removeAffiliate: $("removeAffiliate"),

      receiptDetails: $("receiptDetails"),
      removedStd: $("removedStd"),
      removedBlacklist: $("removedBlacklist"),
      removedAffiliate: $("removedAffiliate"),
      keptWhitelist: $("keptWhitelist"),
      keptOther: $("keptOther"),

      blacklist: $("blacklist"),
      whitelist: $("whitelist"),
      saveRules: $("saveRulesBtn"),
      resetRules: $("resetRulesBtn"),
      exportRules: $("exportRulesBtn"),
      importRules: $("importRulesBtn"),
      rulesMsg: $("rulesMsg"),
    };

    const LS_BLACK = "ss_pro_blacklist_v3";
    const LS_WHITE = "ss_pro_whitelist_v3";
    const LS_PRESET = "ss_pro_preset_v1";
    const LS_AFF = "ss_pro_remove_affiliate_v1";

    // Standard Tracking Rules (conservative, but useful)
    const STD_REMOVE_EXACT = new Set([
      // click ids / ads
      "gclid","dclid","gbraid","wbraid","msclkid","fbclid","ttclid","twclid","igshid","yclid",
      // email/newsletter
      "mc_cid","mc_eid","mkt_tok","oly_anon_id","oly_enc_id","vero_id","vero_conv",
      // misc
      "gclsrc","ref_src","ref_url","fb_action_ids","fb_action_types"
    ]);

    const STD_REMOVE_REGEX = [
      /^utm_/i,                         // utm_*
      /(^|_)(clickid|clkid)$/i,         // generic click ids
      /^(ad|ads|adid|ad_id|adgroup|adgroupid|campaign|campaignid|cmp|cmpid|creative|keyword|matchtype|device)$/i,
      /^(abtest|variant|experiment|bucket)$/i,
      /^(scm|spm|srsltid)$/i
    ];

    function setMsg(el, text, kind=""){
      el.textContent = text || "";
      el.className = "status" + (kind ? " " + kind : "");
    }

    function normalizeUrl(raw){
      let s = String(raw || "").trim();
      if (!s) return "";
      if (!/^https?:\/\//i.test(s) && /^[a-z0-9.-]+\.[a-z]{2,}(\/|$)/i.test(s)) s = "https://" + s;
      return s;
    }

    // Case-insensitive rules: store lowercase
    function parseRulesTextarea(text){
      return new Set(
        String(text || "")
          .split(/\r?\n/)
          .map(x => x.trim())
          .filter(x => x && !x.startsWith("#"))
          .map(x => x.replace(/^[?&]/,"").replace(/=.*$/,""))
          .map(x => x.toLowerCase())
      );
    }

    function loadRules(){
      const b = localStorage.getItem(LS_BLACK) || "";
      const w = localStorage.getItem(LS_WHITE) || "";
      ui.blacklist.value = b;
      ui.whitelist.value = w;
      return {
        blacklist: parseRulesTextarea(b),
        whitelist: parseRulesTextarea(w),
      };
    }

    function saveRules(){
      localStorage.setItem(LS_BLACK, ui.blacklist.value || "");
      localStorage.setItem(LS_WHITE, ui.whitelist.value || "");
      setMsg(ui.rulesMsg, "Regeln gespeichert.", "ok");
    }

    function resetRules(){
      localStorage.removeItem(LS_BLACK);
      localStorage.removeItem(LS_WHITE);
      ui.blacklist.value = "";
      ui.whitelist.value = "";
      setMsg(ui.rulesMsg, "Regeln zurückgesetzt.", "ok");
    }

    function exportRules(){
      const obj = {
        preset: ui.preset.value,
        removeAffiliate: !!ui.removeAffiliate.checked,
        blacklist: ui.blacklist.value || "",
        whitelist: ui.whitelist.value || ""
      };
      const text = JSON.stringify(obj, null, 2);
      navigator.clipboard?.writeText(text).then(
        () => setMsg(ui.rulesMsg, "Regeln exportiert (in Zwischenablage kopiert).", "ok"),
        () => setMsg(ui.rulesMsg, "Export nicht möglich – kopiere manuell aus dem Dialog.", "bad")
      );
      // fallback dialog (always)
      prompt("Regeln (JSON) – kopieren:", text);
    }

    function importRules(){
      const raw = prompt("Regeln (JSON) einfügen:");
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        if (obj.preset) ui.preset.value = obj.preset;
        if (typeof obj.removeAffiliate === "boolean") ui.removeAffiliate.checked = obj.removeAffiliate;
        if (typeof obj.blacklist === "string") ui.blacklist.value = obj.blacklist;
        if (typeof obj.whitelist === "string") ui.whitelist.value = obj.whitelist;
        persistMode();
        saveRules();
      }catch(e){
        setMsg(ui.rulesMsg, "Ungültiges JSON.", "bad");
      }
    }

    function isStdTrackingParam(keyLower){
      if (STD_REMOVE_EXACT.has(keyLower)) return true;
      for (const rx of STD_REMOVE_REGEX) if (rx.test(keyLower)) return true;
      return false;
    }

    function isAffiliateParam(keyLower){
      // bewusst breit, damit Nutzer in Pro experimentieren können
      return /^(tag|ref|ref_|aff|aff_id|affid|affiliate|partner|partner_id|ascsubtag|clickref|irclickid|utm_referrer)$/i.test(keyLower);
    }

    function cleanOneUrl(rawUrl, rules, removeAffiliate){
      const url = new URL(rawUrl);
      const removedStd = new Set();
      const removedBlack = new Set();
      const removedAff = new Set();
      const keptWhite = new Set();
      const keptOther = new Set();

      const entries = Array.from(url.searchParams.entries());
      url.search = "";

      for (const [k,v] of entries){
        const keyLower = String(k).toLowerCase();

        // 1) Whitelist always wins
        if (rules.whitelist.has(keyLower)){
          keptWhite.add(keyLower);
          url.searchParams.append(k, v);
          continue;
        }

        // 2) Affiliate rule (optional)
        if (removeAffiliate && isAffiliateParam(keyLower)){
          removedAff.add(keyLower);
          continue;
        }

        // 3) Blacklist
        if (rules.blacklist.has(keyLower)){
          removedBlack.add(keyLower);
          continue;
        }

        // 4) Standard tracking
        if (isStdTrackingParam(keyLower)){
          removedStd.add(keyLower);
          continue;
        }

        // 5) Keep
        keptOther.add(keyLower);
        url.searchParams.append(k, v);
      }

      return {
        cleaned: url.toString(),
        removedStd, removedBlack, removedAff,
        keptWhite, keptOther
      };
    }

    function formatSet(s){
      const arr = Array.from(s);
      arr.sort();
      return arr.length ? arr.join(", ") : "—";
    }

    async function pasteFromClipboard(){
      try{
        if (navigator.clipboard?.readText){
          const text = await navigator.clipboard.readText();
          if (text){
            ui.input.value = text.trim();
            setMsg(ui.status, "Aus Zwischenablage eingefügt.", "ok");
          } else {
            setMsg(ui.status, "Zwischenablage ist leer.");
          }
        } else {
          setMsg(ui.status, "Zwischenablage nicht verfügbar. Bitte manuell einfügen.");
        }
      }catch(e){
        setMsg(ui.status, "Zugriff auf Zwischenablage nicht erlaubt.", "bad");
      }
    }

    async function copyOutput(){
      const text = String(ui.output.value || "").trim();
      if (!text){
        setMsg(ui.status, "Kein Ergebnis zum Kopieren.", "bad");
        return;
      }
      try{
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
          setMsg(ui.status, "Liste kopiert.", "ok");
          return;
        }
      }catch(e){}
      ui.output.focus();
      ui.output.select();
      try{
        document.execCommand("copy");
        setMsg(ui.status, "Liste kopiert.", "ok");
      }catch(e){
        setMsg(ui.status, "Kopieren nicht verfügbar – bitte manuell markieren.", "bad");
      }
    }

    function openFirst(){
      const first = String(ui.output.value || "").split(/\r?\n/).map(x=>x.trim()).find(Boolean);
      if (!first){
        setMsg(ui.status, "Kein Link zum Öffnen vorhanden.", "bad");
        return;
      }
      window.open(first, "_blank", "noopener");
    }

    function persistMode(){
      localStorage.setItem(LS_PRESET, ui.preset.value);
      localStorage.setItem(LS_AFF, ui.removeAffiliate.checked ? "1" : "0");
    }

    function applyPreset(p){
      // Presets affect only affiliate toggle (Whitelist still wins)
      if (p === "private") ui.removeAffiliate.checked = true;
      if (p === "publisher") ui.removeAffiliate.checked = false;
      // team: user decides (do not force)
      persistMode();
    }

    function loadMode(){
      const p = localStorage.getItem(LS_PRESET);
      const a = localStorage.getItem(LS_AFF);
      if (p) ui.preset.value = p;
      if (a === "1" || a === "0") ui.removeAffiliate.checked = (a === "1");
      // if no saved state: preset default implies affiliate on
      if (!p && (a !== "1" && a !== "0")){
        applyPreset(ui.preset.value);
      }
    }

    function cleanList(){
      const rules = loadRules(); // sync from storage/ui
      const removeAffiliate = !!ui.removeAffiliate.checked;

      const lines = String(ui.input.value || "").split(/\r?\n/);
      const out = [];

      let total = 0, ok = 0, bad = 0;
      let removedCount = 0;

      const removedStdAll = new Set();
      const removedBlackAll = new Set();
      const removedAffAll = new Set();
      const keptWhiteAll = new Set();
      const keptOtherAll = new Set();

      for (const line of lines){
        const raw = normalizeUrl(line);
        if (!raw) continue;
        total++;

        if (!/^https?:\/\//i.test(raw)){
          bad++;
          continue;
        }

        try{
          const res = cleanOneUrl(raw, rules, removeAffiliate);
          out.push(res.cleaned);
          ok++;

          res.removedStd.forEach(k => removedStdAll.add(k));
          res.removedBlack.forEach(k => removedBlackAll.add(k));
          res.removedAff.forEach(k => removedAffAll.add(k));
          res.keptWhite.forEach(k => keptWhiteAll.add(k));
          res.keptOther.forEach(k => keptOtherAll.add(k));

          removedCount += res.removedStd.size + res.removedBlack.size + res.removedAff.size;
        }catch(e){
          bad++;
        }
      }

      ui.output.value = out.join("\n");

      if (total === 0){
        setMsg(ui.status, "Bitte Links einfügen (je Zeile ein Link).", "bad");
        ui.stats.textContent = "";
        ui.receiptDetails.hidden = true;
        return;
      }

      if (ok === 0){
        setMsg(ui.status, "Keine gültigen http/https-Links gefunden.", "bad");
        ui.stats.textContent = "";
        ui.receiptDetails.hidden = true;
        return;
      }

      setMsg(ui.status, "Liste bereinigt.", "ok");
      ui.stats.textContent =
        `${ok}/${total} Links bereinigt · ${removedCount} Parameter entfernt` + (bad ? ` · ${bad} ungültig` : "");

      ui.receiptDetails.hidden = false;
      ui.removedStd.textContent = formatSet(removedStdAll);
      ui.removedBlacklist.textContent = formatSet(removedBlackAll);
      ui.removedAffiliate.textContent = formatSet(removedAffAll);
      ui.keptWhitelist.textContent = formatSet(keptWhiteAll);
      ui.keptOther.textContent = formatSet(keptOtherAll);
    }

    function clearInput(){
      ui.input.value = "";
      setMsg(ui.status, "");
    }
    function clearOutput(){
      ui.output.value = "";
      ui.stats.textContent = "";
      ui.receiptDetails.hidden = true;
      setMsg(ui.status, "");
    }

    // Autosave rules (local only)
    let saveTimer = null;
    function scheduleAutoSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        localStorage.setItem(LS_BLACK, ui.blacklist.value || "");
        localStorage.setItem(LS_WHITE, ui.whitelist.value || "");
        setMsg(ui.rulesMsg, "Regeln gespeichert (lokal).", "ok");
      }, 450);
    }

    // Events
    ui.paste.addEventListener("click", pasteFromClipboard);
    ui.clean.addEventListener("click", cleanList);
    ui.clearInput.addEventListener("click", clearInput);
    ui.clearOutput.addEventListener("click", clearOutput);
    ui.copy.addEventListener("click", copyOutput);
    ui.openFirst.addEventListener("click", openFirst);

    ui.preset.addEventListener("change", () => applyPreset(ui.preset.value));
    ui.removeAffiliate.addEventListener("change", persistMode);

    ui.blacklist.addEventListener("input", scheduleAutoSave);
    ui.whitelist.addEventListener("input", scheduleAutoSave);

    ui.saveRules.addEventListener("click", saveRules);
    ui.resetRules.addEventListener("click", resetRules);
    ui.exportRules.addEventListener("click", exportRules);
    ui.importRules.addEventListener("click", importRules);

    // Init
    loadMode();
    loadRules();

    // If coming from app.html with ?url=..., prefill and clean once
    (function initFromQuery(){
      const qs = new URLSearchParams(location.search);
      const u = qs.get("url");
      if (!u) return;
      try{
        const decoded = decodeURIComponent(u);
        ui.input.value = decoded;
        cleanList();
      }catch(e){}
    })();
  </script>
</body>
</html>
