<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SafeShare Pro – Policy & Audit</title>
  <meta name="description" content="SafeShare Pro: Links in Bulk bereinigen, Regeln als Policy verwalten, Audit pro Link exportieren – alles lokal im Browser." />
  <meta name="robots" content="index,follow" />
  <meta name="color-scheme" content="dark light" />

  <!-- Google Search Console -->
  <meta name="google-site-verification" content="3-mi6zLHRdFC14-RdTIF6GY90jKWfyLNLsFBhGLqQB0" />
  <!-- Bing Webmaster Tools -->
  <meta name="msvalidate.01" content="B18ACE18875F9614DAA5CF69EED40ACE" />

  <style>
    :root{
      --bg0:#070a12; --bg1:#070b14; --bg2:#0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.045);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --muted2: rgba(255,255,255,.60);
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --radius: 18px;
      --mint: #2fe3b7;
      --mint2: rgba(47,227,183,.18);
      --mint3: rgba(47,227,183,.28);
      --warn: rgba(255,197,84,.16);
      --bad: rgba(255,95,95,.16);
      --ok: rgba(47,227,183,.16);
      --focus: 0 0 0 3px rgba(47,227,183,.22);
      --max: 1120px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg0:#f6f7fb; --bg1:#ffffff; --bg2:#f2f6ff;
        --card:#ffffff; --card2:#f5f7ff;
        --border: rgba(17,24,39,.12);
        --text: rgba(17,24,39,.95);
        --muted: rgba(17,24,39,.72);
        --muted2: rgba(17,24,39,.62);
        --shadow: 0 18px 45px rgba(17,24,39,.10);
        --warn: rgba(255,197,84,.22);
        --bad: rgba(255,95,95,.18);
        --ok: rgba(47,227,183,.18);
        --focus: 0 0 0 3px rgba(17,130,98,.22);
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(47,227,183,.18), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(255,197,84,.10), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0) 55%, var(--bg2));
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:var(--max); margin:0 auto; padding: 12px 16px 44px; }

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap: 14px; padding: 10px 2px 12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logoWrap{
      width: 38px; height: 38px; border-radius: 999px;
      border:1px solid var(--border);
      background: linear-gradient(135deg, rgba(47,227,183,.22), rgba(255,197,84,.10));
      box-shadow: var(--shadow);
      display:grid; place-items:center; overflow:hidden; flex:0 0 auto;
    }
    .logoWrap img{ width:28px; height:28px; display:block; }
    .logoFallback{ font-weight:800; color: var(--mint); font-size: 14px; line-height:1; display:none; }
    .brandText{ min-width:0; }
    .brandText .title{
      font-size: 16px; font-weight: 780; line-height:1.1;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brandText .sub{
      font-size: 12px; color: var(--muted2); margin-top:2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .tabsBar{
      position: sticky; top:0; z-index: 50;
      padding: 8px 0 14px;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,0));
    }
    .tabs{
      display:flex; align-items:center; gap:10px;
      padding: 10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow-x:auto; scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{ display:none; }
    .tab{
      font-size: 13px; color: var(--muted);
      padding: 8px 12px; border-radius: 999px;
      border: 1px solid transparent;
      white-space: nowrap; flex: 0 0 auto;
    }
    .tab:hover{ border-color: var(--border); background: rgba(255,255,255,.04); color: var(--text); }
    .tab.active{
      color: var(--text);
      border-color: rgba(47,227,183,.35);
      background: rgba(47,227,183,.12);
    }

    .card{
      margin-top: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    h1{
      margin: 10px 0 8px;
      font-size: clamp(22px, 3.8vw, 34px);
      line-height: 1.15;
      letter-spacing: -0.2px;
    }
    h2{ margin: 0 0 8px; font-size: 20px; letter-spacing: -0.1px; }
    p{ margin: 0 0 12px; color: var(--muted); line-height: 1.55; }

    .cols{
      display:grid; grid-template-columns: 1fr; gap: 14px; margin-top: 8px;
    }
    @media(min-width: 980px){
      .cols{ grid-template-columns: 1fr 1fr; }
    }

    label{
      display:flex; justify-content:space-between; gap: 10px;
      font-size: 13px; color: var(--muted); margin: 0 0 8px;
    }
    .labelHint{ color: var(--muted2); font-weight: 500; }

    textarea, input[type="text"], select{
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--card2);
      color: var(--text);
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
    }
    textarea:focus, input[type="text"]:focus, select:focus{
      box-shadow: var(--focus); border-color: rgba(47,227,183,.35);
    }
    .big{
      min-height: 150px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      line-height: 1.35;
    }

    .row{ display:flex; gap: 10px; flex-wrap:wrap; align-items:center; margin-top: 12px; }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn.primary{
      background: var(--mint2);
      border-color: rgba(47,227,183,.35);
    }
    .btn.primary:hover{ background: var(--mint3); }
    .btn.ghost{ background: transparent; color: var(--muted); }
    .btn.ghost:hover{ color: var(--text); background: rgba(255,255,255,.04); }
    .btn.danger{ background: rgba(255,95,95,.12); border-color: rgba(255,95,95,.30); }
    .btn.danger:hover{ background: rgba(255,95,95,.18); }

    .status{
      margin-top: 10px; font-size: 13px; color: var(--muted); min-height: 18px;
    }
    .status.ok{ color: rgba(47,227,183,.95); }
    .status.bad{ color: rgba(255,95,95,.95); }

    .sep{ height:1px; background: rgba(255,255,255,.08); margin: 12px 0; }
    .small{ font-size: 12px; color: var(--muted2); line-height: 1.45; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size: 12px; color: var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius: 999px; background: rgba(47,227,183,.85); box-shadow: 0 0 0 4px rgba(47,227,183,.12); }
    .warnBox{
      margin-top: 12px;
      border-left: 3px solid rgba(255,197,84,.55);
      background: var(--warn);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
    }
    .okBox{
      margin-top: 12px;
      border-left: 3px solid rgba(47,227,183,.55);
      background: var(--ok);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.45;
    }

    /* Audit */
    .tableWrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
      font-size: 12px;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      vertical-align: top;
      color: var(--muted);
    }
    th{
      color: var(--text);
      font-weight: 700;
      text-align:left;
      position: sticky;
      top: 0;
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(6px);
    }
    .badgeStatus{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size: 12px; color: var(--text);
      white-space: nowrap;
    }
    .sOK{ border-color: rgba(47,227,183,.35); background: rgba(47,227,183,.12); }
    .sWARN{ border-color: rgba(255,197,84,.45); background: rgba(255,197,84,.14); }
    .sRISK{ border-color: rgba(255,95,95,.40); background: rgba(255,95,95,.14); }
    .mutedLink{
      display:block;
      max-width: 440px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color: var(--muted2);
    }
    .monoSmall{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 11px; color: var(--muted2); }
    details.auditDetails{
      margin-top: 10px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    details.auditDetails > summary{
      cursor:pointer;
      font-weight: 700;
      font-size: 13px;
      color: var(--text);
      list-style: none;
    }
    details.auditDetails > summary::-webkit-details-marker{ display:none; }

    .kv{
      display:grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px;
    }
    .scrollKeys{
      display:block;
      max-height: 140px;
      overflow:auto;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      line-height: 1.5;
      word-break: break-word;
      color: var(--muted);
    }

    footer{
      margin-top: 18px;
      padding: 18px 4px 10px;
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.55;
    }
    .footGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      border-top: 1px solid rgba(255,255,255,.08);
      padding-top: 14px;
    }
    @media(min-width: 920px){
      .footGrid{ grid-template-columns: 1.2fr .8fr; }
    }
    .footLinks{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-start;
    }
    .footLinks a{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .footLinks a:hover{ color: var(--text); background: rgba(255,255,255,.06); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logoWrap" aria-label="SafeShare Logo">
          <!-- Lege logo.svg in denselben Ordner wie pro-app.html -->
          <img id="logoImg" src="logo.svg" alt="SafeShare"
               onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';">
          <span id="logoFallback" class="logoFallback">8</span>
        </div>
        <div class="brandText">
          <div class="title">SafeShare</div>
          <div class="sub">Pro · Policy & Audit · local-first</div>
        </div>
      </div>
      <div class="small">Profi-Workflow: Bulk → Audit → Export</div>
    </header>

    <div class="tabsBar">
      <div class="tabs" role="navigation" aria-label="SafeShare Navigation">
        <a class="tab" href="app.html">App</a>
        <a class="tab active" href="pro-app.html">Pro</a>
        <a class="tab" href="utm-parameter-entfernen.html">UTM</a>
        <a class="tab" href="tracking-parameter.html">Tracking</a>
        <a class="tab" href="url-cleaner-tool-vergleich.html">Tool-Vergleich</a>
        <a class="tab" href="hilfe.html">Hilfe</a>
        <a class="tab" href="bookmarklets.html">Bookmarklets</a>
      </div>
    </div>

    <!-- WORKSPACE -->
    <section class="card">
      <div class="pill"><span class="dot" aria-hidden="true"></span> Pro Workspace</div>
      <h1>Links bereinigen – mit Audit pro Link</h1>
      <p>
        Für Profis: deterministisch, nachvollziehbar, exportierbar.
        SafeShare Pro extrahiert alle URLs aus einem Textblock, bereinigt nach Policy und liefert ein Audit pro Link.
      </p>

      <div class="cols">
        <!-- INPUT -->
        <div>
          <label for="inputText">
            <span>Input (Textblock)</span>
            <span class="labelHint">Listen, Nummerierungen, Mails – alles ok</span>
          </label>
          <textarea id="inputText" class="big" spellcheck="false" autocapitalize="off" autocomplete="off"
            placeholder="Hier Text einfügen – SafeShare Pro erkennt alle URLs&#10;&#10;1) https://example.com/?utm_source=newsletter&fbclid=EXAMPLE&#10;2) https://www.amazon.de/dp/B000000000?tag=dein-tag-21&ref=abc&utm_source=newsletter"></textarea>

          <div class="row">
            <button class="btn" id="pasteBtn" type="button">Aus Zwischenablage</button>
            <button class="btn primary" id="runBtn" type="button">Bereinigen</button>
            <button class="btn" id="clearInputBtn" type="button">Input leeren</button>
            <button class="btn ghost" id="clearAllBtn" type="button">Alles leeren</button>
          </div>

          <div class="status" id="statusMsg"></div>

          <div class="sep"></div>

          <label for="profileSel">
            <span>Profi-Profil</span>
            <span class="labelHint">setzt Defaults (du kannst danach feinjustieren)</span>
          </label>
          <select id="profileSel">
            <option value="journalism">Journalismus / Redaktion (Tracking + Affiliate raus)</option>
            <option value="social">Social / Creator (Tracking raus, Affiliate optional)</option>
            <option value="publisher">Publisher / Affiliate (Tracking raus, Affiliate bleibt)</option>
            <option value="compliance">Team / Compliance (streng, audit-lastig)</option>
          </select>

          <div class="row" style="margin-top:10px;">
            <button class="btn" id="applyProfileBtn" type="button">Profil anwenden</button>
            <button class="btn ghost" id="resetPolicyBtn" type="button">Policy auf Default</button>
          </div>

          <div class="okBox" id="profileHintBox" style="display:none;"></div>

          <details class="auditDetails" style="margin-top:12px;">
            <summary>Pro Settings</summary>
            <div class="kv">
              <label style="margin:0; display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px;">
                <input type="checkbox" id="removeAffiliate" />
                Affiliate entfernen (tag/ref/aff_…)
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px;">
                <input type="checkbox" id="unwrapRedirects" />
                Redirect/Wrapper entpacken (offline, wenn möglich)
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px;">
                <input type="checkbox" id="sortParams" checked />
                Parameter sortieren (kanonisch)
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px;">
                <input type="checkbox" id="allowlistFirst" />
                Allowlist-First (strict) – nur Whitelist bleibt
              </label>
              <label style="margin:0; display:flex; align-items:center; gap:10px; color:var(--muted); font-size:13px;">
                <input type="checkbox" id="stripFragmentTracking" checked />
                Tracking im Fragment entfernen (wenn fragment wie query aussieht)
              </label>

              <div class="small">
                Guardrails: Wenn Tokens/Signaturen entfernt würden, markiert SafeShare das als Risiko und bietet 1-Klick-Whitelist-Fix.
              </div>
            </div>
          </details>
        </div>

        <!-- OUTPUT -->
        <div>
          <label for="outputList">
            <span>Output (bereinigte Links)</span>
            <span class="labelHint">1 Link pro Zeile</span>
          </label>
          <textarea id="outputList" class="big" readonly placeholder="Bereinigte Links erscheinen hier."></textarea>

          <div class="row">
            <button class="btn primary" id="copyOutBtn" type="button">Liste kopieren</button>
            <button class="btn" id="downloadOutBtn" type="button">Liste .txt</button>
            <button class="btn" id="openFirstBtn" type="button">Ersten öffnen</button>
          </div>

          <div class="small" id="statsLine"></div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn" id="copyAuditJsonBtn" type="button">Audit JSON kopieren</button>
            <button class="btn" id="downloadAuditJsonBtn" type="button">Audit JSON</button>
            <button class="btn" id="downloadAuditCsvBtn" type="button">Audit CSV</button>
          </div>

          <div class="warnBox">
            Profi-Regel: Standard-Tracking (UTM/click-IDs/newsletter) raus. Funktionale Parameter bleiben.
            Tokens/Signaturen niemals “blind” entfernen – dafür sind Whitelist + Guardrails da.
          </div>
        </div>
      </div>
    </section>

    <!-- AUDIT TABLE -->
    <section class="card">
      <h2>Audit</h2>
      <p>Pro Link: Original → Clean + Gründe + Warnungen. Exportierbar (CSV/JSON).</p>

      <div class="tableWrap" id="auditWrap" style="display:none;">
        <table aria-label="Audit Tabelle">
          <thead>
            <tr>
              <th>#</th>
              <th>Status</th>
              <th>Domain</th>
              <th>Original</th>
              <th>Clean</th>
              <th>Counts</th>
              <th>Warnungen</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody id="auditTbody"></tbody>
        </table>
      </div>

      <div class="small" id="auditEmptyHint">Noch kein Audit. Klicke „Bereinigen“.</div>

      <div id="auditDetailsArea"></div>
    </section>

    <!-- POLICY -->
    <section class="card">
      <h2>Policy Editor</h2>
      <p>Whitelist gewinnt immer. Blacklist entfernt zusätzlich. Alles wird lokal gespeichert. Policy-Export ist versioniert.</p>

      <div class="cols">
        <div>
          <label for="whitelist">
            <span>Whitelist</span>
            <span class="labelHint">immer behalten (Vorrang)</span>
          </label>
          <textarea id="whitelist" class="big" placeholder="z. B.&#10;token&#10;sig&#10;state"></textarea>
        </div>
        <div>
          <label for="blacklist">
            <span>Blacklist</span>
            <span class="labelHint">immer entfernen (zusätzlich)</span>
          </label>
          <textarea id="blacklist" class="big" placeholder="z. B.&#10;ref_src&#10;source&#10;spm"></textarea>
        </div>
      </div>

      <div class="row">
        <button class="btn primary" id="savePolicyBtn" type="button">Policy speichern</button>
        <button class="btn" id="exportPolicyBtn" type="button">Policy exportieren</button>
        <button class="btn" id="importPolicyBtn" type="button">Policy importieren</button>
        <button class="btn ghost" id="copyPolicyBtn" type="button">Policy JSON kopieren</button>
      </div>

      <div class="status" id="policyMsg"></div>

      <details class="auditDetails" style="margin-top:12px;">
        <summary>Domain Overrides (optional, JSON)</summary>
        <div class="small" style="margin-top:10px;">
          Format:
          <div class="monoSmall" style="margin-top:6px;">
            {"amazon.de":{"removeAffiliate":false,"whitelist":["tag","ref"]},"youtube.com":{"whitelist":["v","t"]}}
          </div>
        </div>
        <textarea id="domainOverrides" class="big" placeholder='{}' style="margin-top:10px;"></textarea>
      </details>
    </section>

    <footer>
      <div class="footGrid">
        <div>
          <div><strong>SafeShare Pro</strong> – Policy & Audit, local-first.</div>
          <div>Keine Accounts. Keine Server-Logs. Policies & Exporte gehören dir.</div>
        </div>
        <div class="footLinks">
          <a href="app.html">App</a>
          <a href="pro-app.html">Pro</a>
          <a href="hilfe.html">Hilfe</a>
          <a href="bookmarklets.html">Bookmarklets</a>
          <a href="datenschutz.html">Datenschutz</a>
          <a href="impressum.html">Impressum</a>
        </div>
      </div>
    </footer>
  </div>

  <script>
    /* ===========================
       SafeShare Pro Engine (pure)
       =========================== */

    // Standard: tracking-like keys (conservative + practical)
    const STD_REMOVE_EXACT = new Set([
      "gclid","dclid","gbraid","wbraid","msclkid","fbclid","ttclid","twclid","igshid","yclid",
      "mc_cid","mc_eid","mkt_tok","oly_anon_id","oly_enc_id","vero_id","vero_conv",
      "gclsrc","ref_src","ref_url","fb_action_ids","fb_action_types","srsltid"
    ]);
    const STD_REMOVE_REGEX = [
      /^utm_/i,
      /(^|_)(clickid|clkid)$/i,
      /^(ad|ads|adid|ad_id|adgroup|adgroupid|campaign|campaignid|cmp|cmpid|creative|keyword|matchtype|device)$/i,
      /^(abtest|variant|experiment|bucket)$/i,
      /^(scm|spm)$/i
    ];

    // Affiliate buckets (broad)
    function isAffiliateKey(keyLower){
      return /^(tag|ref|ref_|aff|aff_id|affid|affiliate|partner|partner_id|ascsubtag|clickref|irclickid|utm_referrer)$/i.test(keyLower);
    }

    // Signed / security-ish keys: do not remove lightly (guardrails)
    function isSignedKey(keyLower){
      return /^(token|sig|signature|hmac|nonce|state|expires|expiry|exp|timestamp|ts|hash|key|api_key|x-amz-|x-amz-.*)$/i.test(keyLower);
    }

    function isStdTrackingKey(keyLower){
      if (STD_REMOVE_EXACT.has(keyLower)) return true;
      for (const rx of STD_REMOVE_REGEX) if (rx.test(keyLower)) return true;
      return false;
    }

    // Extract ALL URLs from a text block (lists, bullets, paragraphs)
    function extractUrlsFromText(text){
      const t = String(text || "");
      const httpMatches = t.match(/https?:\/\/[^\s<>"')]+/gi) || [];
      let domainMatches = [];
      if (httpMatches.length === 0){
        domainMatches = t.match(/\b[a-z0-9.-]+\.[a-z]{2,}(?:\/[^\s<>"')]+)?/gi) || [];
        domainMatches = domainMatches.map(x => "https://" + x);
      }
      const cleaned = [...httpMatches, ...domainMatches]
        .map(u => u.replace(/[),.;]+$/g, "").trim())
        .filter(Boolean);
      return Array.from(new Set(cleaned));
    }

    // Parse list textarea into Set(lowercase keys)
    function parseKeyList(text){
      return new Set(
        String(text || "")
          .split(/\r?\n/)
          .map(x => x.trim())
          .filter(x => x && !x.startsWith("#"))
          .map(x => x.replace(/^[?&]/,"").replace(/=.*$/,""))
          .map(x => x.toLowerCase())
      );
    }

    // Try to unwrap redirect wrappers offline (only works when wrapper contains a target URL in a param)
    function tryUnwrap(urlObj, maxDepth=3){
      const chain = [];
      let current = urlObj;
      for (let i=0; i<maxDepth; i++){
        const params = current.searchParams;
        const candidates = ["url","u","target","dest","destination","redirect","redir","r","to","next","out","continue"];
        let found = null;

        for (const k of candidates){
          if (!params.has(k)) continue;
          const v = params.get(k);
          if (!v) continue;
          const decoded = safeDecodeURIComponent(v);
          if (/^https?:\/\//i.test(decoded)){
            found = decoded;
            break;
          }
          if (/^https?:\/\//i.test(v)){
            found = v;
            break;
          }
        }

        if (!found) break;

        chain.push({ from: current.toString(), to: found });
        try{
          current = new URL(found);
        }catch(e){
          break;
        }
      }
      return { finalUrl: current, chain };
    }

    function safeDecodeURIComponent(s){
      try{ return decodeURIComponent(s); }catch(e){ return s; }
    }

    // Remove tracking-like tokens from fragment if fragment is query-ish
    function stripFragmentTracking(hash){
      if (!hash) return hash;
      const h = String(hash);
      const raw = h.startsWith("#") ? h.slice(1) : h;
      // If fragment looks like query pairs: a=b&c=d
      if (!raw.includes("=") || !raw.includes("&")) return h;

      const pairs = raw.split("&").map(p => p.trim()).filter(Boolean);
      const kept = [];
      for (const p of pairs){
        const [k, ...rest] = p.split("=");
        const key = String(k || "").toLowerCase();
        if (!key) continue;
        const looksTracking = isStdTrackingKey(key) || isAffiliateKey(key) || key === "fbclid" || key === "gclid";
        if (!looksTracking) kept.push([k, rest.join("=")].filter(Boolean).join("="));
      }
      if (kept.length === 0) return "";
      return "#" + kept.join("&");
    }

    // Canonical param sorting
    function sortEntries(entries){
      return entries.sort((a,b) => {
        const ka = String(a[0]).toLowerCase();
        const kb = String(b[0]).toLowerCase();
        if (ka < kb) return -1;
        if (ka > kb) return 1;
        return 0;
      });
    }

    // Apply domain overrides (optional)
    function getDomainOverride(host, overridesObj){
      if (!overridesObj || typeof overridesObj !== "object") return null;
      const h = String(host || "").toLowerCase();
      if (overridesObj[h]) return overridesObj[h];
      // also try without www.
      if (h.startsWith("www.") && overridesObj[h.slice(4)]) return overridesObj[h.slice(4)];
      return null;
    }

    function ensureArray(x){
      if (!x) return [];
      if (Array.isArray(x)) return x;
      return [];
    }

    // Engine: clean one URL with full audit
    function cleanUrlWithAudit(rawUrl, policy){
      const audit = {
        original: rawUrl,
        cleaned: null,
        host: null,
        unwrapChain: [],
        removed: { STD: [], BLACKLIST: [], AFFILIATE: [] },
        kept: { WHITELIST: [], KEEP: [], ALLOWLIST: [] },
        warnings: [],
        risk: false
      };

      let urlObj = new URL(rawUrl);
      audit.host = urlObj.hostname;

      // Optional unwrap
      if (policy.settings.unwrapRedirects){
        const unwrapped = tryUnwrap(urlObj, 3);
        audit.unwrapChain = unwrapped.chain;
        urlObj = unwrapped.finalUrl;
        audit.host = urlObj.hostname;
        // Note: Some wrappers like t.co cannot be unwrapped offline
        if (audit.unwrapChain.length === 0 && /(^|\.)t\.co$/i.test(new URL(rawUrl).hostname)){
          audit.warnings.push("Wrapper t.co kann offline nicht entpackt werden.");
        }
      }

      const overrides = getDomainOverride(urlObj.hostname, policy.domainOverrides);
      const removeAffiliate = (overrides && typeof overrides.removeAffiliate === "boolean")
        ? overrides.removeAffiliate
        : policy.settings.removeAffiliate;

      // Build effective whitelist/blacklist
      const wl = new Set([...policy.rules.whitelist]);
      const bl = new Set([...policy.rules.blacklist]);

      if (overrides){
        for (const k of ensureArray(overrides.whitelist)) wl.add(String(k).toLowerCase());
        for (const k of ensureArray(overrides.blacklist)) bl.add(String(k).toLowerCase());
      }

      const entries = Array.from(urlObj.searchParams.entries());
      const keptEntries = [];
      const removedSignedCandidates = new Set();

      // Allowlist-first: keep only whitelisted keys (strict), plus keep keys explicitly on allowlist (WHITELIST).
      // Everything else gets removed (as STD-like in audit: we record under STD for simplicity, but mark as ALLOWLIST in kept.)
      const allowlistFirst = !!policy.settings.allowlistFirst;

      for (const [k,v] of entries){
        const keyLower = String(k).toLowerCase();

        // Whitelist always wins
        if (wl.has(keyLower)){
          audit.kept.WHITELIST.push(keyLower);
          keptEntries.push([k,v]);
          continue;
        }

        if (allowlistFirst){
          // strict: drop everything not in whitelist
          // risk tracking of signed keys removed by strict policy
          if (isSignedKey(keyLower)) removedSignedCandidates.add(keyLower);
          audit.removed.BLACKLIST.push(keyLower); // "policy strict" -> treat as forced removal bucket
          continue;
        }

        // Affiliate rule
        if (removeAffiliate && isAffiliateKey(keyLower)){
          if (isSignedKey(keyLower)) removedSignedCandidates.add(keyLower);
          audit.removed.AFFILIATE.push(keyLower);
          continue;
        }

        // Blacklist
        if (bl.has(keyLower)){
          if (isSignedKey(keyLower)) removedSignedCandidates.add(keyLower);
          audit.removed.BLACKLIST.push(keyLower);
          continue;
        }

        // Standard tracking
        if (isStdTrackingKey(keyLower)){
          if (isSignedKey(keyLower)) removedSignedCandidates.add(keyLower);
          audit.removed.STD.push(keyLower);
          continue;
        }

        // Keep
        audit.kept.KEEP.push(keyLower);
        keptEntries.push([k,v]);
      }

      // Deduplicate lists
      for (const bucket of ["STD","BLACKLIST","AFFILIATE"]){
        audit.removed[bucket] = Array.from(new Set(audit.removed[bucket])).sort();
      }
      for (const bucket of ["WHITELIST","KEEP","ALLOWLIST"]){
        audit.kept[bucket] = Array.from(new Set(audit.kept[bucket])).sort();
      }

      // Guardrails warnings
      if (removedSignedCandidates.size){
        audit.risk = true;
        audit.warnings.push("Signatur/Token-Keys würden entfernt: " + Array.from(removedSignedCandidates).sort().join(", "));
      }

      // Rebuild URL
      const out = new URL(urlObj.toString());
      out.search = "";
      const finalEntries = policy.settings.sortParams ? sortEntries(keptEntries) : keptEntries;
      for (const [k,v] of finalEntries){
        // Keep original key casing
        out.searchParams.append(k, v);
      }

      // Fragment handling
      if (policy.settings.stripFragmentTracking){
        const newHash = stripFragmentTracking(out.hash);
        out.hash = newHash || "";
      }

      // Canonical: remove trailing ? if none
      audit.cleaned = out.toString();
      return audit;
    }

    /* ===========================
       UI / Policy storage
       =========================== */

    const $ = (id) => document.getElementById(id);

    const ui = {
      inputText: $("inputText"),
      outputList: $("outputList"),
      pasteBtn: $("pasteBtn"),
      runBtn: $("runBtn"),
      clearInputBtn: $("clearInputBtn"),
      clearAllBtn: $("clearAllBtn"),
      copyOutBtn: $("copyOutBtn"),
      downloadOutBtn: $("downloadOutBtn"),
      openFirstBtn: $("openFirstBtn"),

      statusMsg: $("statusMsg"),
      statsLine: $("statsLine"),

      profileSel: $("profileSel"),
      applyProfileBtn: $("applyProfileBtn"),
      resetPolicyBtn: $("resetPolicyBtn"),
      profileHintBox: $("profileHintBox"),

      removeAffiliate: $("removeAffiliate"),
      unwrapRedirects: $("unwrapRedirects"),
      sortParams: $("sortParams"),
      allowlistFirst: $("allowlistFirst"),
      stripFragmentTracking: $("stripFragmentTracking"),

      whitelist: $("whitelist"),
      blacklist: $("blacklist"),
      domainOverrides: $("domainOverrides"),

      savePolicyBtn: $("savePolicyBtn"),
      exportPolicyBtn: $("exportPolicyBtn"),
      importPolicyBtn: $("importPolicyBtn"),
      copyPolicyBtn: $("copyPolicyBtn"),
      policyMsg: $("policyMsg"),

      auditWrap: $("auditWrap"),
      auditTbody: $("auditTbody"),
      auditEmptyHint: $("auditEmptyHint"),
      auditDetailsArea: $("auditDetailsArea"),

      copyAuditJsonBtn: $("copyAuditJsonBtn"),
      downloadAuditJsonBtn: $("downloadAuditJsonBtn"),
      downloadAuditCsvBtn: $("downloadAuditCsvBtn"),
    };

    const LS_POLICY = "safeshare_pro_policy_v1";

    function nowISO(){
      return new Date().toISOString();
    }

    function defaultPolicy(){
      return {
        meta: {
          policyVersion: "1.0",
          engineVersion: "1.0",
          createdAt: nowISO(),
          profile: "journalism",
          notes: ""
        },
        settings: {
          removeAffiliate: true,
          unwrapRedirects: false,
          sortParams: true,
          allowlistFirst: false,
          stripFragmentTracking: true
        },
        rules: {
          whitelist: [], // lowercase keys
          blacklist: []  // lowercase keys
        },
        domainOverrides: {} // host -> { removeAffiliate?: bool, whitelist?: [], blacklist?: [] }
      };
    }

    const PROFILE_PRESETS = {
      journalism: {
        profile: "journalism",
        settings: { removeAffiliate: true, unwrapRedirects: true, sortParams: true, allowlistFirst: false, stripFragmentTracking: true },
        notes: "Redaktion: Tracking + Affiliate raus, Unwrap an (offline soweit möglich), Guardrails aktiv."
      },
      social: {
        profile: "social",
        settings: { removeAffiliate: true, unwrapRedirects: false, sortParams: true, allowlistFirst: false, stripFragmentTracking: true },
        notes: "Social: Tracking raus, Affiliate standardmäßig raus (schaltbar), schnell & kanonisch."
      },
      publisher: {
        profile: "publisher",
        settings: { removeAffiliate: false, unwrapRedirects: false, sortParams: true, allowlistFirst: false, stripFragmentTracking: true },
        notes: "Publisher: Tracking raus, Affiliate bleibt (fair), kanonisch."
      },
      compliance: {
        profile: "compliance",
        settings: { removeAffiliate: true, unwrapRedirects: true, sortParams: true, allowlistFirst: false, stripFragmentTracking: true },
        notes: "Compliance: audit-lastig, Unwrap an, Affiliate raus. Allowlist-first optional."
      }
    };

    function setMsg(el, text, kind=""){
      el.textContent = text || "";
      el.className = "status" + (kind ? " " + kind : "");
    }

    function loadPolicy(){
      const raw = localStorage.getItem(LS_POLICY);
      if (!raw) return defaultPolicy();
      try{
        const obj = JSON.parse(raw);
        // very light validation
        if (!obj || typeof obj !== "object") return defaultPolicy();
        if (!obj.settings || !obj.rules) return defaultPolicy();
        if (!obj.domainOverrides) obj.domainOverrides = {};
        return obj;
      }catch(e){
        return defaultPolicy();
      }
    }

    function savePolicyToStorage(policy){
      localStorage.setItem(LS_POLICY, JSON.stringify(policy));
    }

    function policyFromUI(){
      const p = loadPolicy();
      p.meta.createdAt = p.meta.createdAt || nowISO();
      p.settings.removeAffiliate = !!ui.removeAffiliate.checked;
      p.settings.unwrapRedirects = !!ui.unwrapRedirects.checked;
      p.settings.sortParams = !!ui.sortParams.checked;
      p.settings.allowlistFirst = !!ui.allowlistFirst.checked;
      p.settings.stripFragmentTracking = !!ui.stripFragmentTracking.checked;

      p.rules.whitelist = Array.from(parseKeyList(ui.whitelist.value));
      p.rules.blacklist = Array.from(parseKeyList(ui.blacklist.value));

      try{
        const dom = ui.domainOverrides.value.trim() ? JSON.parse(ui.domainOverrides.value) : {};
        p.domainOverrides = dom && typeof dom === "object" ? dom : {};
      }catch(e){
        // keep old if invalid
      }
      return p;
    }

    function applyPolicyToUI(policy){
      ui.profileSel.value = policy.meta?.profile || "journalism";
      ui.removeAffiliate.checked = !!policy.settings.removeAffiliate;
      ui.unwrapRedirects.checked = !!policy.settings.unwrapRedirects;
      ui.sortParams.checked = policy.settings.sortParams !== false;
      ui.allowlistFirst.checked = !!policy.settings.allowlistFirst;
      ui.stripFragmentTracking.checked = policy.settings.stripFragmentTracking !== false;

      ui.whitelist.value = (policy.rules.whitelist || []).join("\n");
      ui.blacklist.value = (policy.rules.blacklist || []).join("\n");
      ui.domainOverrides.value = JSON.stringify(policy.domainOverrides || {}, null, 2);
    }

    function applyProfile(profileKey){
      const base = loadPolicy();
      const preset = PROFILE_PRESETS[profileKey] || PROFILE_PRESETS.journalism;
      base.meta.profile = preset.profile;
      base.meta.createdAt = nowISO();
      base.meta.notes = preset.notes;

      // only overwrite settings; keep existing lists unless user resets
      base.settings = { ...base.settings, ...preset.settings };

      savePolicyToStorage(base);
      applyPolicyToUI(base);

      ui.profileHintBox.style.display = "block";
      ui.profileHintBox.textContent = preset.notes;
      setMsg(ui.policyMsg, "Profil angewendet.", "ok");
    }

    function resetPolicy(){
      const p = defaultPolicy();
      savePolicyToStorage(p);
      applyPolicyToUI(p);
      ui.profileHintBox.style.display = "none";
      setMsg(ui.policyMsg, "Policy auf Default zurückgesetzt.", "ok");
    }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }

    async function copyText(text){
      try{
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(e){}
      return false;
    }

    async function pasteFromClipboard(){
      try{
        if (navigator.clipboard?.readText){
          const text = await navigator.clipboard.readText();
          if (text){
            ui.inputText.value = text.trim();
            setMsg(ui.statusMsg, "Aus Zwischenablage eingefügt.", "ok");
          } else {
            setMsg(ui.statusMsg, "Zwischenablage ist leer.");
          }
        } else {
          setMsg(ui.statusMsg, "Zwischenablage nicht verfügbar.", "bad");
        }
      }catch(e){
        setMsg(ui.statusMsg, "Zwischenablage-Zugriff nicht erlaubt.", "bad");
      }
    }

    function openFirst(){
      const first = String(ui.outputList.value || "").split(/\r?\n/).map(x=>x.trim()).find(Boolean);
      if (!first){
        setMsg(ui.statusMsg, "Kein Link zum Öffnen vorhanden.", "bad");
        return;
      }
      window.open(first, "_blank", "noopener");
    }

    /* ===========================
       Run + Audit rendering
       =========================== */

    let LAST_AUDIT = []; // array of audit objects

    function auditStatus(a){
      // Risk: removed signed keys
      if (a.risk) return { label: "RISK", cls: "sRISK" };
      // Warn: wrapper not unwrapped / had warnings
      if ((a.warnings || []).length) return { label: "WARN", cls: "sWARN" };
      return { label: "OK", cls: "sOK" };
    }

    function countRemoved(a){
      return (a.removed.STD.length + a.removed.BLACKLIST.length + a.removed.AFFILIATE.length);
    }

    function domainOf(urlStr){
      try{ return new URL(urlStr).hostname; }catch(e){ return ""; }
    }

    function toCsv(audits){
      const esc = (s) => {
        const t = String(s ?? "");
        if (t.includes('"') || t.includes(",") || t.includes("\n")) return '"' + t.replace(/"/g,'""') + '"';
        return t;
      };
      const header = [
        "index","status","domain","original","cleaned",
        "removed_std","removed_blacklist","removed_affiliate",
        "kept_whitelist","kept_other",
        "warnings","unwrap_chain"
      ].join(",");
      const rows = audits.map((a, i) => {
        const st = auditStatus(a).label;
        const unwrap = (a.unwrapChain || []).map(x => `${x.from} -> ${x.to}`).join(" | ");
        return [
          i+1,
          st,
          domainOf(a.cleaned),
          a.original,
          a.cleaned,
          a.removed.STD.join(" "),
          a.removed.BLACKLIST.join(" "),
          a.removed.AFFILIATE.join(" "),
          a.kept.WHITELIST.join(" "),
          a.kept.KEEP.join(" "),
          (a.warnings || []).join(" | "),
          unwrap
        ].map(esc).join(",");
      });
      return [header, ...rows].join("\n");
    }

    function renderAudit(audits){
      ui.auditTbody.innerHTML = "";
      ui.auditDetailsArea.innerHTML = "";

      if (!audits.length){
        ui.auditWrap.style.display = "none";
        ui.auditEmptyHint.style.display = "block";
        return;
      }

      ui.auditWrap.style.display = "block";
      ui.auditEmptyHint.style.display = "none";

      audits.forEach((a, idx) => {
        const st = auditStatus(a);
        const removed = countRemoved(a);
        const kept = (a.kept.WHITELIST.length + a.kept.KEEP.length);
        const warnings = (a.warnings || []).join(" · ") || "—";
        const host = domainOf(a.cleaned) || a.host || "—";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td><span class="badgeStatus ${st.cls}">${st.label}</span></td>
          <td class="monoSmall">${host}</td>
          <td><span class="mutedLink" title="${escapeHtml(a.original)}">${escapeHtml(a.original)}</span></td>
          <td><span class="mutedLink" title="${escapeHtml(a.cleaned)}">${escapeHtml(a.cleaned)}</span></td>
          <td class="monoSmall">- ${removed} / + ${kept}</td>
          <td class="monoSmall">${escapeHtml(warnings)}</td>
          <td>
            <button class="btn" data-open="${idx}" type="button">Open</button>
            <button class="btn" data-details="${idx}" type="button">Details</button>
            ${a.risk ? `<button class="btn danger" data-fix="${idx}" type="button">Whitelist-Fix</button>` : ``}
          </td>
        `;
        ui.auditTbody.appendChild(tr);
      });

      // Wire buttons
      ui.auditTbody.querySelectorAll("button[data-open]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = Number(btn.getAttribute("data-open"));
          const url = audits[i]?.cleaned;
          if (url) window.open(url, "_blank", "noopener");
        });
      });

      ui.auditTbody.querySelectorAll("button[data-details]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = Number(btn.getAttribute("data-details"));
          showAuditDetails(i);
        });
      });

      ui.auditTbody.querySelectorAll("button[data-fix]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = Number(btn.getAttribute("data-fix"));
          whitelistFixForAudit(i);
        });
      });
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function showAuditDetails(i){
      const a = LAST_AUDIT[i];
      if (!a) return;

      // remove existing details for same index (toggle behavior)
      const existing = document.getElementById("detail_" + i);
      if (existing){ existing.remove(); return; }

      const st = auditStatus(a);
      const unwrapChain = (a.unwrapChain || []).map(x => `${x.from} → ${x.to}`).join("\n") || "—";

      const box = document.createElement("details");
      box.className = "auditDetails";
      box.id = "detail_" + i;
      box.open = true;
      box.innerHTML = `
        <summary>Details #${i+1} · ${st.label}</summary>
        <div class="kv">
          <div class="small"><strong>Original</strong></div>
          <div class="scrollKeys mono">${escapeHtml(a.original)}</div>

          <div class="small"><strong>Clean</strong></div>
          <div class="scrollKeys mono">${escapeHtml(a.cleaned)}</div>

          <div class="small"><strong>Unwrap Chain</strong></div>
          <div class="scrollKeys mono">${escapeHtml(unwrapChain)}</div>

          <div class="small"><strong>Removed · STD</strong></div>
          <div class="scrollKeys mono">${escapeHtml(a.removed.STD.join(", ") || "—")}</div>

          <div class="small"><strong>Removed · BLACKLIST (inkl. Allowlist-First drops)</strong></div>
          <div class="scrollKeys mono">${escapeHtml(a.removed.BLACKLIST.join(", ") || "—")}</div>

          <div class="small"><strong>Removed · AFFILIATE</strong></div>
          <div class="scrollKeys mono">${escapeHtml(a.removed.AFFILIATE.join(", ") || "—")}</div>

          <div class="small"><strong>Kept · WHITELIST</strong></div>
          <div class="scrollKeys mono">${escapeHtml(a.kept.WHITELIST.join(", ") || "—")}</div>

          <div class="small"><strong>Kept · OTHER</strong></div>
          <div class="scrollKeys mono">${escapeHtml(a.kept.KEEP.join(", ") || "—")}</div>

          <div class="small"><strong>Warnings</strong></div>
          <div class="scrollKeys mono">${escapeHtml((a.warnings || []).join(" · ") || "—")}</div>

          <div class="row">
            <button class="btn" data-close="${i}" type="button">Close</button>
            <button class="btn primary" data-copy="${i}" type="button">Copy Clean</button>
            ${a.risk ? `<button class="btn danger" data-fix="${i}" type="button">Whitelist-Fix</button>` : ``}
          </div>
        </div>
      `;

      ui.auditDetailsArea.prepend(box);

      box.querySelector(`button[data-close="${i}"]`)?.addEventListener("click", () => box.remove());
      box.querySelector(`button[data-copy="${i}"]`)?.addEventListener("click", async () => {
        const ok = await copyText(a.cleaned || "");
        setMsg(ui.statusMsg, ok ? "Clean URL kopiert." : "Kopieren nicht verfügbar.", ok ? "ok" : "bad");
      });
      box.querySelector(`button[data-fix="${i}"]`)?.addEventListener("click", () => whitelistFixForAudit(i));
    }

    function whitelistFixForAudit(i){
      const a = LAST_AUDIT[i];
      if (!a) return;

      // Parse warning string for signed keys or derive from removed buckets
      const removedAll = new Set([...a.removed.STD, ...a.removed.BLACKLIST, ...a.removed.AFFILIATE]);
      const candidates = Array.from(removedAll).filter(k => isSignedKey(k));

      if (!candidates.length){
        setMsg(ui.statusMsg, "Kein Whitelist-Fix nötig (keine Signatur/Token-Keys entfernt).", "ok");
        return;
      }

      const current = parseKeyList(ui.whitelist.value);
      candidates.forEach(k => current.add(k));

      ui.whitelist.value = Array.from(current).sort().join("\n");

      // Save policy immediately
      const p = policyFromUI();
      p.rules.whitelist = Array.from(parseKeyList(ui.whitelist.value));
      savePolicyToStorage(p);

      setMsg(ui.statusMsg, "Whitelist-Fix angewendet: " + candidates.join(", "), "ok");
      // rerun to remove risk flags
      runCleaning();
    }

    function runCleaning(){
      const policy = policyFromUI();
      policy.meta.policyVersion = policy.meta.policyVersion || "1.0";
      policy.meta.engineVersion = policy.meta.engineVersion || "1.0";
      policy.meta.createdAt = nowISO();
      policy.meta.profile = ui.profileSel.value || policy.meta.profile || "journalism";

      // domain overrides parsing: keep last valid
      try{
        policy.domainOverrides = ui.domainOverrides.value.trim() ? JSON.parse(ui.domainOverrides.value) : {};
      }catch(e){
        // keep as is, but warn
        setMsg(ui.policyMsg, "Domain Overrides: JSON ungültig (ignoriert).", "bad");
      }

      // Persist
      savePolicyToStorage(policy);

      const urls = extractUrlsFromText(ui.inputText.value);
      if (!urls.length){
        ui.outputList.value = "";
        ui.statsLine.textContent = "";
        LAST_AUDIT = [];
        renderAudit(LAST_AUDIT);
        setMsg(ui.statusMsg, "Keine URLs gefunden.", "bad");
        return;
      }

      const audits = [];
      const outLines = [];
      let riskCount = 0, warnCount = 0;

      for (const raw of urls){
        try{
          const a = cleanUrlWithAudit(raw, policy);
          audits.push(a);
          outLines.push(a.cleaned);
          const st = auditStatus(a).label;
          if (st === "RISK") riskCount++;
          else if (st === "WARN") warnCount++;
        }catch(e){
          audits.push({
            original: raw, cleaned: raw, host: "", unwrapChain: [],
            removed:{STD:[],BLACKLIST:[],AFFILIATE:[]},
            kept:{WHITELIST:[],KEEP:[],ALLOWLIST:[]},
            warnings:["Ungültige URL oder nicht parsebar."],
            risk:false
          });
          outLines.push(raw);
          warnCount++;
        }
      }

      LAST_AUDIT = audits;
      ui.outputList.value = outLines.join("\n");

      const removedTotal = audits.reduce((sum,a)=>sum + countRemoved(a), 0);
      ui.statsLine.textContent =
        `${audits.length} Links · ${removedTotal} Parameter entfernt · ${warnCount} WARN · ${riskCount} RISK`;

      renderAudit(audits);

      if (riskCount){
        setMsg(ui.statusMsg, `Bereinigt mit ${riskCount} RISK. Prüfe Audit und nutze Whitelist-Fix.`, "bad");
      }else if (warnCount){
        setMsg(ui.statusMsg, `Bereinigt mit ${warnCount} WARN. Prüfe Audit.`, "ok");
      }else{
        setMsg(ui.statusMsg, "Bereinigt. Audit ist OK.", "ok");
      }
    }

    /* ===========================
       Buttons: export/copy
       =========================== */

    async function copyOutputList(){
      const text = String(ui.outputList.value || "").trim();
      if (!text){ setMsg(ui.statusMsg, "Kein Output zum Kopieren.", "bad"); return; }
      const ok = await copyText(text);
      setMsg(ui.statusMsg, ok ? "Liste kopiert." : "Kopieren nicht verfügbar.", ok ? "ok" : "bad");
    }

    async function copyAuditJson(){
      if (!LAST_AUDIT.length){ setMsg(ui.statusMsg, "Kein Audit vorhanden.", "bad"); return; }
      const payload = JSON.stringify({ exportedAt: nowISO(), audit: LAST_AUDIT }, null, 2);
      const ok = await copyText(payload);
      setMsg(ui.statusMsg, ok ? "Audit JSON kopiert." : "Kopieren nicht verfügbar.", ok ? "ok" : "bad");
    }

    async function copyPolicyJson(){
      const p = policyFromUI();
      p.meta.profile = ui.profileSel.value || p.meta.profile;
      p.meta.createdAt = nowISO();
      const payload = JSON.stringify(p, null, 2);
      const ok = await copyText(payload);
      setMsg(ui.policyMsg, ok ? "Policy JSON kopiert." : "Kopieren nicht verfügbar.", ok ? "ok" : "bad");
    }

    function exportPolicy(){
      const p = policyFromUI();
      p.meta.profile = ui.profileSel.value || p.meta.profile;
      p.meta.createdAt = nowISO();
      const payload = JSON.stringify(p, null, 2);
      downloadText(`safeshare-policy-${p.meta.profile}-${new Date().toISOString().slice(0,10)}.json`, payload);
      setMsg(ui.policyMsg, "Policy exportiert.", "ok");
    }

    function importPolicy(){
      const raw = prompt("Policy JSON einfügen:");
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== "object" || !obj.settings || !obj.rules){
          setMsg(ui.policyMsg, "Ungültige Policy-Struktur.", "bad");
          return;
        }
        savePolicyToStorage(obj);
        applyPolicyToUI(obj);
        ui.profileHintBox.style.display = "none";
        setMsg(ui.policyMsg, "Policy importiert.", "ok");
      }catch(e){
        setMsg(ui.policyMsg, "Ungültiges JSON.", "bad");
      }
    }

    function downloadAuditJson(){
      if (!LAST_AUDIT.length){ setMsg(ui.statusMsg, "Kein Audit vorhanden.", "bad"); return; }
      const payload = JSON.stringify({ exportedAt: nowISO(), audit: LAST_AUDIT }, null, 2);
      downloadText(`safeshare-audit-${new Date().toISOString().slice(0,10)}.json`, payload);
      setMsg(ui.statusMsg, "Audit JSON exportiert.", "ok");
    }

    function downloadAuditCsv(){
      if (!LAST_AUDIT.length){ setMsg(ui.statusMsg, "Kein Audit vorhanden.", "bad"); return; }
      const csv = toCsv(LAST_AUDIT);
      downloadText(`safeshare-audit-${new Date().toISOString().slice(0,10)}.csv`, csv);
      setMsg(ui.statusMsg, "Audit CSV exportiert.", "ok");
    }

    function downloadOutputTxt(){
      const text = String(ui.outputList.value || "").trim();
      if (!text){ setMsg(ui.statusMsg, "Kein Output vorhanden.", "bad"); return; }
      downloadText(`safeshare-cleaned-${new Date().toISOString().slice(0,10)}.txt`, text + "\n");
      setMsg(ui.statusMsg, "Liste exportiert.", "ok");
    }

    function clearAll(){
      ui.inputText.value = "";
      ui.outputList.value = "";
      ui.statsLine.textContent = "";
      LAST_AUDIT = [];
      renderAudit(LAST_AUDIT);
      setMsg(ui.statusMsg, "");
    }

    /* ===========================
       Wire UI
       =========================== */

    ui.pasteBtn.addEventListener("click", pasteFromClipboard);
    ui.runBtn.addEventListener("click", runCleaning);
    ui.clearInputBtn.addEventListener("click", () => { ui.inputText.value = ""; setMsg(ui.statusMsg,""); });
    ui.clearAllBtn.addEventListener("click", clearAll);

    ui.copyOutBtn.addEventListener("click", copyOutputList);
    ui.downloadOutBtn.addEventListener("click", downloadOutputTxt);
    ui.openFirstBtn.addEventListener("click", openFirst);

    ui.copyAuditJsonBtn.addEventListener("click", copyAuditJson);
    ui.downloadAuditJsonBtn.addEventListener("click", downloadAuditJson);
    ui.downloadAuditCsvBtn.addEventListener("click", downloadAuditCsv);

    ui.savePolicyBtn.addEventListener("click", () => {
      const p = policyFromUI();
      p.meta.profile = ui.profileSel.value || p.meta.profile;
      p.meta.createdAt = nowISO();
      savePolicyToStorage(p);
      setMsg(ui.policyMsg, "Policy gespeichert.", "ok");
    });
    ui.exportPolicyBtn.addEventListener("click", exportPolicy);
    ui.importPolicyBtn.addEventListener("click", importPolicy);
    ui.copyPolicyBtn.addEventListener("click", copyPolicyJson);

    ui.applyProfileBtn.addEventListener("click", () => applyProfile(ui.profileSel.value));
    ui.resetPolicyBtn.addEventListener("click", resetPolicy);

    // Autosave policy inputs (local only)
    let saveTimer = null;
    function scheduleAutosave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        const p = policyFromUI();
        p.meta.profile = ui.profileSel.value || p.meta.profile;
        savePolicyToStorage(p);
        setMsg(ui.policyMsg, "Auto-Save (lokal).", "ok");
      }, 500);
    }

    [ui.removeAffiliate, ui.unwrapRedirects, ui.sortParams, ui.allowlistFirst, ui.stripFragmentTracking]
      .forEach(el => el.addEventListener("change", scheduleAutosave));
    [ui.whitelist, ui.blacklist, ui.domainOverrides]
      .forEach(el => el.addEventListener("input", scheduleAutosave));

    // Init
    (function init(){
      const p = loadPolicy();
      applyPolicyToUI(p);
      ui.profileHintBox.style.display = "none";
    })();

    // Deep link from app: ?url=...
    (function initFromQuery(){
      const qs = new URLSearchParams(location.search);
      const u = qs.get("url");
      if (!u) return;
      try{
        ui.inputText.value = decodeURIComponent(u);
        runCleaning();
      }catch(e){}
    })();
  </script>
</body>
</html>
