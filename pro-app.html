<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SafeShare Pro App – Bulk Clean für Profis</title>
  <meta name="description" content="SafeShare Pro: mehrere Links bereinigen, Whitelist/Blacklist, Presets und Audit. Local-first im Browser." />
  <meta name="robots" content="noindex,follow" />
  <meta name="color-scheme" content="dark light" />

  <!-- Google Search Console -->
  <meta name="google-site-verification" content="3-mi6zLHRdFC14-RdTIF6GY90jKWfyLNLsFBhGLqQB0" />
  <!-- Bing Webmaster Tools -->
  <meta name="msvalidate.01" content="B18ACE18875F9614DAA5CF69EED40ACE" />

  <style>
    :root{
      --bg0:#070a12; --bg1:#070b14; --bg2:#0b1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.045);
      --border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.58);
      --mint:#2fe3b7;
      --mint2:rgba(47,227,183,.18);
      --shadow:0 18px 45px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(47,227,183,.10), transparent 60%),
        radial-gradient(900px 600px at 70% 20%, rgba(100,180,255,.10), transparent 55%),
        linear-gradient(180deg,var(--bg0),var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:22px 16px 40px}
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; padding:12px 14px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius:999px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:10;
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text)}
    .brand img{width:28px;height:28px;border-radius:999px}
    .brand b{letter-spacing:.2px}
    .brand small{display:block;color:var(--muted);font-weight:500;margin-top:1px}
    .navLinks{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .navLinks a{
      color:var(--muted);
      text-decoration:none;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .navLinks a:hover{
      color:var(--text);
      border-color:var(--border);
      background:rgba(255,255,255,.04);
    }
    .hero{padding:18px 4px 8px}
    h1{margin:14px 0 10px; font-size: clamp(26px, 3.6vw, 40px); line-height:1.08}
    .lead{color:var(--muted); font-size: clamp(15px, 1.7vw, 18px); line-height:1.5; margin:0 0 14px}
    .chipRow{display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 12px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid var(--border);
      color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--mint); box-shadow:0 0 0 6px var(--mint2)}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:10px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width:900px){ .twoCol{grid-template-columns:1fr} }

    .card h2{margin:0 0 8px; font-size:20px}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .hr{height:1px;background:rgba(255,255,255,.10); margin:14px 0}

    textarea, select, input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    textarea{min-height:120px; resize:vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    textarea:focus, select:focus, input:focus{
      border-color:rgba(47,227,183,.6);
      box-shadow:0 0 0 6px rgba(47,227,183,.12)
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius:999px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:600;
      text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
    }
    .btn.primary{background: linear-gradient(180deg, rgba(47,227,183,.22), rgba(47,227,183,.10)); border-color: rgba(47,227,183,.40)}
    .btn:hover{border-color:rgba(255,255,255,.28); background:rgba(255,255,255,.08)}
    .btn.primary:hover{border-color:rgba(47,227,183,.58)}
    .btn:disabled{opacity:.5; cursor:not-allowed}

    .box{
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      padding:12px 12px;
      color:var(--muted);
    }
    .ok{color:#aef7df}
    .warn{color:#ffd9a8}
    .err{color:#ffb2b2}

    .auditList{margin:0; padding-left:18px}
    .auditItem{margin:8px 0}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}

    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .overlay .modal{
      max-width:740px;
      width:100%;
      border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 25px 70px rgba(0,0,0,.55);
      padding:18px;
    }
    .modal h2{margin:0 0 8px}
    .modal p{margin:0 0 10px; color:var(--muted)}

    footer{
      margin-top:22px;
      padding:18px 10px;
      color:var(--muted);
      text-align:center;
    }
    footer .footLinks{
      display:flex; gap:14px; justify-content:center; flex-wrap:wrap;
      margin-bottom:10px;
    }
    footer a{color:var(--muted); text-decoration:none}
    footer a:hover{color:var(--text); text-decoration:underline}
    .tiny{font-size:12px; color:rgba(255,255,255,.55)}
  </style>
</head>

<body>
  <div class="wrap">

    <nav class="nav" aria-label="SafeShare Navigation">
      <a class="brand" href="index.html">
        <img src="assets/icons/icon-32-kreis.png" alt="SafeShare Logo" />
        <div>
          <b>SafeShare</b>
          <small>Pro App · Bulk Clean</small>
        </div>
      </a>
      <div class="navLinks">
        <a href="app.html">App</a>
        <a href="pro.html">Pro</a>
        <a href="help.html">Hilfe</a>
      </div>
    </nav>

    <header class="hero">
      <h1>Mehrere Links in einem Rutsch bereinigen</h1>
      <p class="lead">
        Für Profis, die Links veröffentlichen: Presets/Policies, Whitelist/Blacklist und ein Audit, das nachvollziehbar zeigt,
        was entfernt und was behalten wurde.
      </p>

      <div class="chipRow">
        <span class="chip"><span class="dot"></span><span id="chipPlan">Plan: —</span></span>
        <span class="chip">Aktivierung: <span id="chipActive">—</span></span>
        <span class="chip">local-first im Browser</span>
      </div>
    </header>

    <main class="grid" id="appRoot">

      <section class="card">
        <h2>Input</h2>
        <p class="muted">Je Zeile ein Link. Leerzeilen werden ignoriert.</p>

        <div class="twoCol">
          <div>
            <label class="muted2" for="preset">Preset/Policy</label>
            <select id="preset">
              <option value="conservative">Konservativ (stabil)</option>
              <option value="standard" selected>Standard (Publishing)</option>
              <option value="aggressive">Aggressiv (max clean – prüfen!)</option>
            </select>

            <label class="muted2" for="inputLinks" style="margin-top:12px; display:block;">Eingabe – Links (1 pro Zeile)</label>
            <textarea id="inputLinks" placeholder="https://example.com/?utm_source=newsletter
https://www.beispiel.de/artikel?fbclid=ABC123&utm_medium=social"></textarea>

            <div class="row">
              <button class="btn primary" id="btnClean">Liste bereinigen</button>
              <button class="btn" id="btnClearInput" type="button">Eingabe leeren</button>
              <button class="btn" id="btnLoadExamples" type="button">Test-Beispiele laden</button>
            </div>
          </div>

          <div>
            <div class="box">
              <b>Whitelist (Allowlist)</b>
              <div class="muted" style="margin-top:6px">Parameter, die bleiben dürfen (1 pro Zeile), z. B. <code>tag</code>, <code>ref</code>, <code>affid</code>.</div>
              <textarea id="whitelist" style="min-height:120px; margin-top:10px" placeholder="tag
ref"></textarea>
            </div>

            <div class="box" style="margin-top:12px">
              <b>Blacklist (zusätzlich entfernen)</b>
              <div class="muted" style="margin-top:6px">Eigene Tracking-Keys, die immer raus sollen (1 pro Zeile).</div>
              <textarea id="blacklist" style="min-height:120px; margin-top:10px" placeholder="si
fb_action_ids"></textarea>
            </div>

            <div class="row">
              <button class="btn" id="btnSaveRules" type="button">Regeln speichern</button>
              <button class="btn" id="btnResetRules" type="button">Regeln zurücksetzen</button>
            </div>

            <p class="tiny" style="margin-top:10px">
              Regeln werden lokal im Browser gespeichert (localStorage).
            </p>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Output</h2>
        <p class="muted">Bereinigte Links (je Zeile ein Link). Du kannst die Liste direkt kopieren.</p>

        <textarea id="outputLinks" readonly placeholder="Die bereinigte Liste erscheint hier – je Zeile ein Link."></textarea>

        <div class="row">
          <button class="btn primary" id="btnCopy">Bereinigte Liste kopieren</button>
          <button class="btn" id="btnClearOutput" type="button">Ergebnis leeren</button>
        </div>

        <div class="hr"></div>

        <h2>Audit: Was wurde geändert?</h2>
        <p class="muted">Hier wird jede Zeile aufgelistet – inkl. entfernte/behaltene Parameter.</p>
        <div class="box" id="auditBox">
          <span class="muted">Noch keine Auswertung.</span>
        </div>
      </section>

    </main>

    <footer>
      <div class="footLinks">
        <a href="index.html">Start</a>
        <a href="app.html">App</a>
        <a href="pro.html">Pro</a>
        <a href="datenschutz.html">Datenschutz</a>
        <a href="impressum.html">Impressum</a>
      </div>
      <div class="tiny">SafeShare Pro – Policy statt Blackbox.</div>
    </footer>

  </div>

  <!-- Gating Overlay (wenn nicht aktiviert) -->
  <div class="overlay" id="gate">
    <div class="modal">
      <h2>SafeShare Pro ist nicht aktiviert</h2>
      <p>
        Bitte aktiviere SafeShare Pro mit deinem Lizenz-Key (Payhip-Kaufbestätigung / Download-Seite).
        Danach kannst du die Pro App nutzen.
      </p>
      <div class="row">
        <a class="btn primary" href="pro-activate.html">Zur Aktivierung</a>
        <a class="btn" href="pro.html">Zur Pro-Seite</a>
        <a class="btn" href="help.html">Hilfe</a>
      </div>
      <p class="tiny" style="margin-top:12px">
        Hinweis: Aktivierung wird lokal im Browser gespeichert. Wenn du den Browser wechselst, musst du erneut aktivieren.
      </p>
    </div>
  </div>

  <script>
    (function(){
      // ----- shared keys (wie in pro-activate.html) -----
      const KEY_STORAGE  = 'ss_pro_key';
      const PRO_STORAGE  = 'ss_pro_activated';
      const PLAN_STORAGE = 'ss_pro_plan';
      const TS_STORAGE   = 'ss_pro_activated_at';

      // ----- rule storage -----
      const WL_STORAGE = 'ss_pro_whitelist';
      const BL_STORAGE = 'ss_pro_blacklist';
      const PRESET_STORAGE = 'ss_pro_preset';

      const $ = (id) => document.getElementById(id);

      // ----- gating -----
      function isActivated(){
        return localStorage.getItem(PRO_STORAGE) === '1' && !!(localStorage.getItem(KEY_STORAGE) || '').trim();
      }

      function planLabel(){
        const p = (localStorage.getItem(PLAN_STORAGE) || '').toLowerCase().trim();
        if (p === 'team') return 'Team';
        if (p === 'personal') return 'Person';
        return 'Auto';
      }

      function fmtTs(){
        const iso = localStorage.getItem(TS_STORAGE);
        if (!iso) return '—';
        try{
          const d = new Date(iso);
          return d.toLocaleString('de-DE', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
        }catch{ return '—'; }
      }

      function applyGate(){
        if (!isActivated()){
          $('gate').style.display = 'flex';
          $('appRoot').style.filter = 'blur(8px)';
          $('appRoot').style.pointerEvents = 'none';
          $('chipActive').innerHTML = '<span class="err"><b>nicht aktiv</b></span>';
        } else {
          $('gate').style.display = 'none';
          $('appRoot').style.filter = 'none';
          $('appRoot').style.pointerEvents = 'auto';
          $('chipActive').innerHTML = '<span class="ok"><b>aktiv</b></span> · ' + fmtTs();
        }
        $('chipPlan').textContent = 'Plan: ' + planLabel();
      }

      // ----- rules -----
      function normalizeLines(txt){
        return (txt || '')
          .split(/\r?\n/g)
          .map(s => s.trim())
          .filter(Boolean);
      }

      function loadRules(){
        const wl = localStorage.getItem(WL_STORAGE);
        const bl = localStorage.getItem(BL_STORAGE);
        const pr = localStorage.getItem(PRESET_STORAGE);

        if (wl !== null) $('whitelist').value = wl;
        if (bl !== null) $('blacklist').value = bl;
        if (pr) $('preset').value = pr;
      }

      function saveRules(){
        localStorage.setItem(WL_STORAGE, $('whitelist').value || '');
        localStorage.setItem(BL_STORAGE, $('blacklist').value || '');
        localStorage.setItem(PRESET_STORAGE, $('preset').value || 'standard');
        $('auditBox').innerHTML = '<span class="ok"><b>Regeln gespeichert.</b></span> <span class="muted">Sie gelten ab dem nächsten Clean.</span>';
      }

      function resetRules(){
        localStorage.removeItem(WL_STORAGE);
        localStorage.removeItem(BL_STORAGE);
        localStorage.removeItem(PRESET_STORAGE);
        $('whitelist').value = 'tag\nref';
        $('blacklist').value = '';
        $('preset').value = 'standard';
        $('auditBox').innerHTML = '<span class="warn"><b>Regeln zurückgesetzt.</b></span> <span class="muted">Whitelist-Vorschlag: tag/ref.</span>';
      }

      // ----- preset logic -----
      const BASE_REMOVE = new Set([
        // UTM
        'utm_source','utm_medium','utm_campaign','utm_term','utm_content','utm_id','utm_reader','utm_name',
        // ad click ids
        'gclid','dclid','wbraid','gbraid','msclkid','fbclid','twclid','igshid','ttclid','li_fat_id',
        // email/campaign trackers
        'mc_cid','mc_eid','mkt_tok','vero_id',
        // hubspot-ish
        '_hsenc','_hsmi','hsCtaTracking',
        // misc
        'ref_src','ref_url','spm','yclid','_ga','_gl','cmpid','campaignid','adid'
      ]);

      function presetRemoveSet(preset){
        const s = new Set(BASE_REMOVE);

        // standard: etwas mehr, aber keine Affiliate-Killer
        if (preset === 'standard'){
          [
            'source','medium','campaign','cid','icid','ocid','scid','ncid','s_cid','trk','tracking','trkId','trkEmail',
            'fb_action_ids','fb_action_types','fb_source','fb_ref'
          ].forEach(x => s.add(x));
        }

        // aggressive: deutlich mehr, aber immer noch NICHT automatisch ref/tag entfernen
        if (preset === 'aggressive'){
          [
            'share','shared','feature','features','si','smid','mibextid','app','app_name','from','is_from_webapp',
            'guccounter','guce_referrer','guce_referrer_sig','r','sr','mbid','spm_id_from',
            'cmp','cmp_id','cmpid','cmp_id','campaign','campaign_id','ad','ads','adset','creative',
            'pcrid','placement','keyword','matchtype'
          ].forEach(x => s.add(x));
        }

        return s;
      }

      function isUtmLike(name){
        return /^utm_/i.test(name);
      }

      // ----- cleaning -----
      function safeUrlParse(line){
        const raw = (line || '').trim();
        if (!raw) return { ok:false, reason:'leer', raw };
        try {
          // URL() braucht scheme – wenn fehlt, versuchen wir https://
          if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(raw)) {
            return { ok:true, url: new URL('https://' + raw), raw };
          }
          return { ok:true, url: new URL(raw), raw };
        } catch {
          return { ok:false, reason:'ungültige URL', raw };
        }
      }

      function cleanOne(inputLine, preset, wlSet, blSet){
        const parsed = safeUrlParse(inputLine);
        if (!parsed.ok){
          return {
            ok:false,
            original: inputLine,
            cleaned: '',
            removed: [],
            kept: [],
            whitelisted: [],
            warning: parsed.reason
          };
        }

        const url = parsed.url;
        const removeSet = presetRemoveSet(preset);

        const removed = [];
        const kept = [];
        const whitelisted = [];

        // collect existing params
        const params = Array.from(url.searchParams.entries()); // [name,value]
        url.search = ''; // reset, rebuild

        for (const [name, value] of params){
          const n = (name || '').trim();
          const nLower = n.toLowerCase();

          const isWL = wlSet.has(n) || wlSet.has(nLower);
          const isBL = blSet.has(n) || blSet.has(nLower);

          const shouldRemove =
            isBL ||
            isUtmLike(nLower) ||
            removeSet.has(n) ||
            removeSet.has(nLower);

          if (isWL){
            // Whitelist schlägt alles
            url.searchParams.append(n, value);
            kept.push(n);
            whitelisted.push(n);
            continue;
          }

          if (shouldRemove){
            removed.push(n);
            continue;
          }

          url.searchParams.append(n, value);
          kept.push(n);
        }

        // normalize: sort params (optional, stabil)
        const normalizedParams = Array.from(url.searchParams.entries())
          .sort(([a],[b]) => a.localeCompare(b));

        url.search = '';
        for (const [a,b] of normalizedParams){
          url.searchParams.append(a,b);
        }

        // wenn wir https:// davor gesetzt haben, aber der Nutzer eigentlich eine URL ohne scheme eingegeben hat:
        // -> wir lassen es trotzdem, ist für Publishing ok (funktioniert überall).
        return {
          ok:true,
          original: inputLine,
          cleaned: url.toString(),
          removed,
          kept,
          whitelisted,
          warning: removed.length === 0 ? 'keine Änderungen' : ''
        };
      }

      function renderAudit(results){
        if (!results.length){
          $('auditBox').innerHTML = '<span class="muted">Keine Links.</span>';
          return;
        }

        const parts = [];
        parts.push('<ol class="auditList">');

        for (const r of results){
          if (!r.ok){
            parts.push(
              `<li class="auditItem"><span class="err"><b>Ungültig:</b></span> <code>${escapeHtml(r.original)}</code>
               <div class="muted">Grund: ${escapeHtml(r.warning || '—')}</div></li>`
            );
            continue;
          }

          const removed = r.removed.length ? r.removed.map(x => `<code>${escapeHtml(x)}</code>`).join(', ') : '<span class="muted">—</span>';
          const kept = r.kept.length ? r.kept.map(x => `<code>${escapeHtml(x)}</code>`).join(', ') : '<span class="muted">—</span>';
          const wl = r.whitelisted.length ? r.whitelisted.map(x => `<code>${escapeHtml(x)}</code>`).join(', ') : '<span class="muted">—</span>';

          const status =
            r.removed.length
              ? `<span class="ok"><b>bereinigt</b></span>`
              : `<span class="warn"><b>unverändert</b></span>`;

          parts.push(`
            <li class="auditItem">
              ${status}<br/>
              <div class="muted2">Original:</div>
              <div><code>${escapeHtml(r.original)}</code></div>
              <div class="muted2" style="margin-top:6px">Ergebnis:</div>
              <div><code>${escapeHtml(r.cleaned)}</code></div>

              <div class="muted2" style="margin-top:8px">Entfernt:</div>
              <div>${removed}</div>

              <div class="muted2" style="margin-top:8px">Behalten:</div>
              <div>${kept}</div>

              <div class="muted2" style="margin-top:8px">Whitelist-Treffer:</div>
              <div>${wl}</div>
            </li>
          `);
        }

        parts.push('</ol>');
        $('auditBox').innerHTML = parts.join('');
      }

      function escapeHtml(s){
        return String(s || '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      function doClean(){
        const preset = $('preset').value || 'standard';
        const lines = normalizeLines($('inputLinks').value);

        const wlSet = new Set(normalizeLines($('whitelist').value).flatMap(x => [x, x.toLowerCase()]));
        const blSet = new Set(normalizeLines($('blacklist').value).flatMap(x => [x, x.toLowerCase()]));

        const results = lines.map(line => cleanOne(line, preset, wlSet, blSet));

        // output list: nur ok cleaned + original wenn ungültig
        const out = results.map(r => r.ok ? r.cleaned : r.original).join('\n');
        $('outputLinks').value = out;

        renderAudit(results);
      }

      function loadExamples(){
        $('inputLinks').value = [
          'https://example.com/?utm_source=newsletter&utm_medium=email&utm_campaign=launch',
          'https://www.amazon.de/dp/B0XXXXXX?tag=partner123&utm_source=twitter&ref=abc',
          'https://www.beispiel.de/artikel?fbclid=AAA111&utm_medium=social&utm_campaign=test',
          'https://news.site.tld/story?id=123&gclid=BBB222&utm_source=google',
          'https://youtu.be/XXXXXX?si=CCCC33&utm_source=share'
        ].join('\n');

        $('whitelist').value = 'tag\nref';
        $('blacklist').value = 'si';
        $('preset').value = 'standard';

        $('auditBox').innerHTML = '<span class="muted">Beispiele geladen. Jetzt „Liste bereinigen“.</span>';
      }

      async function copyOut(){
        const txt = $('outputLinks').value || '';
        if (!txt.trim()){
          $('auditBox').innerHTML = '<span class="warn"><b>Nichts zu kopieren.</b></span> <span class="muted">Erst bereinigen.</span>';
          return;
        }
        try{
          await navigator.clipboard.writeText(txt);
          $('auditBox').innerHTML = '<span class="ok"><b>Kopiert.</b></span> <span class="muted">Bereinigte Liste ist in der Zwischenablage.</span>';
        } catch {
          // Fallback: markieren
          $('outputLinks').focus();
          $('outputLinks').select();
          $('auditBox').innerHTML = '<span class="warn"><b>Zwischenablage blockiert.</b></span> <span class="muted">Text ist markiert – kopiere manuell.</span>';
        }
      }

      // init
      applyGate();
      loadRules();

      // sensible defaults
      if (!$('whitelist').value.trim()) $('whitelist').value = 'tag\nref';

      // bind
      $('btnClean').addEventListener('click', doClean);
      $('btnClearInput').addEventListener('click', () => $('inputLinks').value = '');
      $('btnClearOutput').addEventListener('click', () => $('outputLinks').value = '');
      $('btnCopy').addEventListener('click', copyOut);
      $('btnLoadExamples').addEventListener('click', loadExamples);

      $('btnSaveRules').addEventListener('click', saveRules);
      $('btnResetRules').addEventListener('click', resetRules);

      // re-apply gate if storage changes (z.B. nach Aktivierung in anderem Tab)
      window.addEventListener('focus', applyGate);
      window.addEventListener('storage', applyGate);

    })();
  </script>
</body>
</html>
