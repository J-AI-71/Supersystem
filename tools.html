<!-- /Supersystem/tools.html -->
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <base href="/Supersystem/">

  <title>SafeShare Tools</title>
  <link rel="canonical" href="https://j-ai-71.github.io/Supersystem/tools.html">
  <meta name="robots" content="noindex,nofollow">

  <!-- iOS / Icons -->
  <link rel="apple-touch-icon" href="assets/icons/icon-180-kreis.png?v=2025-11-15-11">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/icons/icon-32-kreis.png?v=2025-11-15-11">

  <style>
    :root{--bg:#0b0b0b;--fg:#eaeaea;--mut:#9a9a9a;--pri:#29c07e;--line:#222}
    html,body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui}
    .wrap{max-width:980px;margin:auto;padding:28px 16px}
    h1{margin:0 0 8px;font-size:26px}
    .card{border:1px solid var(--line);border-radius:12px;padding:14px;background:#101010;margin-bottom:12px}
    .btn{display:inline-block;padding:.6rem .9rem;border-radius:10px;background:#1b1b1b;border:1px solid #2a2a2a;color:#eaeaea;font-weight:700;text-decoration:none;cursor:pointer}
    .btn.pri{background:var(--pri);color:#07130c;border-color:transparent}
    .mut{color:var(--mut)}
    pre,code{background:#000;border:1px solid #222;border-radius:6px;padding:6px;overflow:auto}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #222;padding:8px;vertical-align:top}
    th{background:#111}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Tools</h1>

    <div class="card">
      <strong>Service Worker &amp; Cache</strong>
      <div style="margin-top:8px">
        <button class="btn" id="swUpdate">SW update()</button>
        <button class="btn" id="swUnregister">Service Worker abmelden</button>
        <button class="btn" id="clearCaches">Alle Caches löschen</button>
      </div>
      <p class="mut" id="swState" style="margin-top:8px">Status …</p>
    </div>

    <div class="card">
      <strong>Lokale Einstellungen</strong>
      <div style="margin-top:8px">
        <button class="btn" id="clearLocal">Pro &amp; Team-Defaults löschen</button>
      </div>
      <pre id="localDump" style="margin-top:8px"></pre>
    </div>

    <div class="card">
      <strong>Versionen</strong>
      <table>
        <tbody id="versTbl"></tbody>
      </table>
    </div>
  </div>

  <script>
  (async function(){
    const $state = document.getElementById('swState');
    const $dump  = document.getElementById('localDump');
    const $tbl   = document.getElementById('versTbl');

    async function swInfo(){
      try{
        const reg = await navigator.serviceWorker?.getRegistration();
        const ctrl = navigator.serviceWorker?.controller;
        $state.textContent = `SW: ${reg ? 'registriert' : 'nicht registriert'} · Controller: ${ctrl ? 'ja' : 'nein'}`;
      }catch(e){ $state.textContent = 'SW-Status nicht verfügbar'; }
    }

    document.getElementById('swUpdate').onclick = async ()=>{
      try{
        const reg = await navigator.serviceWorker.getRegistration();
        await reg?.update();
        await swInfo();
        alert('update() aufgerufen.');
      }catch(e){ alert('update() fehlgeschlagen.'); }
    };

    document.getElementById('swUnregister').onclick = async ()=>{
      try{
        const reg = await navigator.serviceWorker.getRegistration();
        if(reg){ await reg.unregister(); alert('Abgemeldet. Seite neu laden.'); }
        else alert('Kein SW registriert.');
        await swInfo();
      }catch(e){ alert('Abmelden fehlgeschlagen.'); }
    };

    document.getElementById('clearCaches').onclick = async ()=>{
      try{
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
        alert('Alle Caches gelöscht.');
      }catch(e){ alert('Caches konnten nicht gelöscht werden.'); }
    };

    document.getElementById('clearLocal').onclick = ()=>{
      try{
        localStorage.removeItem('ss_pro');
        localStorage.removeItem('ss_publisher');
        localStorage.removeItem('ss_wl');
        dumpLocal();
        alert('Lokale Einträge entfernt.');
      }catch(e){ alert('Fehler beim Löschen.'); }
    };

    function dumpLocal(){
      try{
        const out = {
          ss_pro: localStorage.getItem('ss_pro'),
          ss_publisher: localStorage.getItem('ss_publisher'),
          ss_wl: localStorage.getItem('ss_wl')
        };
        $dump.textContent = JSON.stringify(out, null, 2);
      }catch(e){ $dump.textContent = 'kein Zugriff'; }
    }

    async function row(label, url, rx){
      const tr = document.createElement('tr');
      tr.innerHTML = `<th>${label}</th><td>…</td>`;
      $tbl.appendChild(tr);
      try{
        const r = await fetch(url, {cache:'no-store'});
        const t = await r.text();
        const m = rx.exec(t);
        tr.children[1].textContent = m ? m[1] : '–';
      }catch(e){
        tr.children[1].textContent = 'Fehler';
      }
    }

    dumpLocal();
    swInfo();
    row('sw.js VERSION','sw.js?v=ns', /VERSION\s*=\s*['"]([^'"]+)['"]/);
    row('sw-register.js VER','js/sw-register.js?v=ns', /VER\s*=\s*['"]([^'"]+)['"]/);
    row('manifest name','manifest.webmanifest?v=ns', /"name"\s*:\s*"([^"]+)"/);
  })();
  </script>
</body>
</html>
