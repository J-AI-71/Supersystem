<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SafeShare – Tools</title>
<meta name="description" content="Cache löschen, Service Worker abmelden, LocalStorage leeren, Status prüfen.">
<!-- SPDX-License-Identifier: MIT -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'">
<style>
  :root{--bd:#e5e7eb;--fg:#111827;--muted:#6b7280}
  *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;margin:16px;color:var(--fg)}
  h1{font-size:20px;margin:0 0 8px} .muted{color:var(--muted);font-size:12px}
  .row{margin:10px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{display:inline-block;padding:10px 12px;border:1px solid var(--bd);border-radius:8px;background:#fff;color:var(--fg);cursor:pointer}
  .btn.small{padding:6px 8px;font-size:12px} .btn.warn{border-color:#991b1b;color:#991b1b}
  pre{white-space:pre-wrap;border:1px solid var(--bd);border-radius:8px;padding:10px;background:#f8fafc}
  code{background:#f8fafc;border:1px solid var(--bd);padding:2px 6px;border-radius:6px}
  a.btn{text-decoration:none}
</style>
</head>
<body>
<h1>SafeShare – Tools</h1>
<p class="muted">Cache/Service Worker/LocalStorage verwalten. Nutze <code>?v=NN</code> als Cache-Buster.</p>

<div class="row">
  <button id="btnStatus" class="btn" type="button">Status prüfen</button>
  <button id="btnClearCaches" class="btn warn" type="button">Alle Caches löschen</button>
  <button id="btnUnregSW" class="btn warn" type="button">Service Worker abmelden</button>
  <button id="btnClearLS" class="btn" type="button">LocalStorage löschen</button>
  <button id="btnNuke" class="btn warn" type="button">Alles löschen (SW+Cache+LS)</button>
  <button id="btnReload" class="btn" type="button">Neu laden mit Buster</button>
</div>

<pre id="log">–</pre>

<div class="row">
  <a class="btn small" href="index.html?v=93">index.html</a>
  <a class="btn small" href="app.html?v=93">app.html</a>
  <a class="btn small" href="app-classic.html?v=93">app-classic.html</a>
  <a class="btn small" href="sitemap.xml?v=93">sitemap.xml</a>
  <a class="btn small" href="robots.txt?v=93">robots.txt</a>
  <a class="btn small" href=".well-known/security.txt?v=93">security.txt</a>
</div>

<script>
const logEl = document.getElementById('log');
const log = (msg)=>{ logEl.textContent = (logEl.textContent==='–'?'':logEl.textContent+'\n') + msg; };

async function status(){
  logEl.textContent=''; 
  try{
    const regs = ('serviceWorker' in navigator) ? await navigator.serviceWorker.getRegistrations() : [];
    log(`SW-Registrations: ${regs.length}`);
    regs.forEach((r,i)=> log(`  [${i}] scope=${r.scope}`));

    const cacheKeys = await ('caches' in window ? caches.keys() : Promise.resolve([]));
    log(`Caches: ${cacheKeys.length}`);
    cacheKeys.forEach(k=> log(`  • ${k}`));

    const est = navigator.storage && navigator.storage.estimate ? await navigator.storage.estimate() : {};
    if(est && est.usage && est.quota){
      const pct = ((est.usage/est.quota)*100).toFixed(1);
      log(`Storage: ${(est.usage/1024/1024).toFixed(2)}MB / ${(est.quota/1024/1024).toFixed(2)}MB (${pct}%)`);
    }

    log(`LocalStorage Keys: ${Object.keys(localStorage).length}`);
    Object.keys(localStorage).forEach(k=>log(`  - ${k}`));
  }catch(e){ log('Status-Fehler: '+e.message); }
}

async function clearCaches(){
  if(!('caches' in window)) return log('Kein Cache-API verfügbar.');
  const keys = await caches.keys();
  let n=0;
  for(const k of keys){ try{ await caches.delete(k); n++; }catch(e){ log(`Fehler beim Löschen ${k}: ${e.message}`); } }
  log(`Caches gelöscht: ${n}`);
}

async function unregisterSW(){
  if(!('serviceWorker' in navigator)) return log('Kein Service Worker verfügbar.');
  const regs = await navigator.serviceWorker.getRegistrations();
  let n=0;
  for(const r of regs){ try{ await r.unregister(); n++; }catch(e){ log(`Unregister-Fehler: ${e.message}`); } }
  log(`Service Worker abgemeldet: ${n}`);
}

function clearLS(){
  try{
    const n = Object.keys(localStorage).length;
    localStorage.clear();
    log(`LocalStorage gelöscht: ${n} Keys`);
  }catch(e){ log('LocalStorage-Fehler: '+e.message); }
}

async function nukeAll(){
  await unregisterSW();
  await clearCaches();
  clearLS();
  log('Alles gelöscht. Jetzt Seite neu laden.');
}

function reloadWithBuster(){
  const u = new URL(location.href);
  const n = Date.now().toString().slice(-6);
  u.searchParams.set('v', n);
  location.href = u.toString();
}

document.getElementById('btnStatus').onclick = status;
document.getElementById('btnClearCaches').onclick = clearCaches;
document.getElementById('btnUnregSW').onclick = unregisterSW;
document.getElementById('btnClearLS').onclick = clearLS;
document.getElementById('btnNuke').onclick = nukeAll;
document.getElementById('btnReload').onclick = reloadWithBuster;

// Auto-Status beim Laden
document.addEventListener('DOMContentLoaded', status);
</script>
</body>
</html>