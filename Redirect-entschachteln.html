<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <base href="/Supersystem/">
  <title>Weiterleitung · SafeShare2</title>
  <link rel="icon" href="assets/logo.png?v=2025-11-13-01">
  <style>
    body{margin:0;background:#0b0b0b;color:#eaeaea;font:16px/1.45 system-ui}
    .wrap{max-width:760px;margin:auto;padding:28px 16px}
    .card{background:#111;border:1px solid #1f1f1f;border-radius:12px;padding:16px}
    .btn{display:inline-block;padding:.8rem 1.1rem;background:#29c07e;color:#07130c;border-radius:10px;text-decoration:none;font-weight:600}
    .mut{color:#9a9a9a}
    #err{color:#ff7b7b}
  </style>
</head>
<body>
<div class="wrap">
  <h2>SafeShare sichert deinen Link</h2>
  <div class="card">
    <p id="status">Reinige…</p>
    <p><a id="go" class="btn" href="#" rel="noopener">Jetzt öffnen</a></p>
    <p id="err" style="display:none"></p>
    <p class="mut">Gängige Tracking-Parameter werden entfernt. Kein Nutzer-Tracking.</p>
  </div>

  <div class="card" style="margin-top:12px">
    <strong>Unterstütze dieses Projekt</strong>
    <p>Hol dir SafeShare Pro für Bulk-Cleaning und eigene Regeln.</p>
    <p>
      <!-- ERSETZEN: Payhip-Links -->
      <a class="btn" href="https://payhip.com/" target="_blank" rel="noopener">Pro kaufen</a>
      <a class="btn" href="app.html" style="background:#1b1b1b;color:#eaeaea;border:1px solid #2a2a2a">App öffnen</a>
    </p>
  </div>
</div>

<script>
function getParam(){
  const sp=new URL(location.href).searchParams;
  let v=sp.get('u')||sp.get('url')||sp.get('link')||'';
  v=v.trim();

  // Wrapper-auf-Wrapper entschachteln
  try{
    const t=new URL(v);
    if(t.origin===location.origin && /redirect-entschachteln\.html$/i.test(t.pathname)){
      const inner=t.searchParams.get('u'); if(inner) v=inner;
    }
  }catch{}

  // mehrfaches Encoding entspannen
  for(let i=0;i<3;i++){
    try{ const d=decodeURIComponent(v); if(d===v) break; v=d; }catch{ break; }
  }

  // Schema reparieren
  if(/^\/\//.test(v)) v='https:'+v;
  if(!/^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(v)) v='https://'+v;
  return v;
}

function clean(u){
  try{
    const x=new URL(u);
    const trackers=["utm_source","utm_medium","utm_campaign","utm_term","utm_content","utm_id","gclid","fbclid","msclkid","yclid","mc_cid","mc_eid","_hsenc","_hsmi","igshid","si","spm"];
    if(/amazon\./.test(x.hostname)){["tag","ascsubtag","ref","pf_rd_r","pf_rd_p"].forEach(k=>x.searchParams.delete(k)); x.hash="";}
    for(const k of [...x.searchParams.keys()]){ if(k.startsWith("utm_")||trackers.includes(k)) x.searchParams.delete(k); }
    x.pathname=x.pathname.replace(/\/{2,}/g,"/"); if(x.pathname!=="/"&&x.pathname.endsWith("/")) x.pathname=x.pathname.slice(0,-1);
    return x.toString();
  }catch{ return u; }
}

(function run(){
  let raw=getParam();
  if(!raw){ fail("Kein Ziel übergeben."); return; }
  let dst=clean(raw);

  // Selbst-Loop absichern
  try{
    const u=new URL(dst);
    if(u.origin===location.origin && /redirect-entschachteln\.html$/i.test(u.pathname)){
      fail("Loop erkannt. Ziel ist erneut der Wrapper."); return;
    }
  }catch{}

  document.getElementById('status').textContent='Ziel: '+dst;
  const a=document.getElementById('go'); a.href=dst; a.target="_self";
  setTimeout(()=>{ location.href=dst; }, 900);
})();

function fail(msg){
  document.getElementById('status').textContent='Fehler';
  const e=document.getElementById('err'); e.style.display='block'; e.textContent=msg;
  const a=document.getElementById('go'); a.textContent='Zur Startseite'; a.href='index.html';
}

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js?v=2025-11-13-01');
}
</script>
</body>
</html>
